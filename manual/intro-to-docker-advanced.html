





<!doctype html>
<html lang="en" class="govuk-template govuk-template--rebranded no-js">
  <head>
    

    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Intro to GOV.UK Docker (Advanced) - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/manual/intro-to-docker-advanced.html">
      <link rel="icon" sizes="48x48" href="/assets/govuk/assets/rebrand/images/favicon.ico">
      <link rel="icon" sizes="any" href="/assets/govuk/assets/rebrand/images/favicon.svg" type="image/svg+xml">
      <link rel="mask-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-mask.svg" color="#0b0c0c">
      <link rel="apple-touch-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-180.png">
      <link rel="manifest" href="/assets/govuk/assets/rebrand/manifest.json">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta name="twitter:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta name="twitter:title" content="Intro to GOV.UK Docker (Advanced) - GOV.UK Developer Documentation" />
      <meta name="twitter:url" content="https://docs.publishing.service.gov.uk/manual/intro-to-docker-advanced.html" />

      <meta property="og:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="Intro to GOV.UK Docker (Advanced)" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/manual/intro-to-docker-advanced.html" />

      <script>
  document.addEventListener('DOMContentLoaded', function () {
    var markup = `<div id="global-cookie-message" data-module="cookie-banner" data-nosnippet="" aria-label="Can we store analytics cookies on your device?" class="gem-c-cookie-banner govuk-clearfix govuk-cookie-banner js-banner-wrapper" role="region" hidden="hidden" title="Can we store analytics cookies on your device?"> <div class="govuk-cookie-banner__message govuk-width-container"> <div class="govuk-grid-row"> <div class="govuk-grid-column-two-thirds"> <h2 class="govuk-cookie-banner__heading govuk-heading-m">Can we store analytics cookies on your device?</h2> <div tabindex="-1" class="govuk-cookie-banner__content gem-c-cookie-banner__confirmation"> <div class="gem-c-cookie-banner__content"><p class='govuk-body'>Weâ€™d like to set some cookies to understand how you use this site and remember your settings.</p><p class='govuk-body'>We also use cookies set by other sites to help us deliver content from their services.</p></div> <p class="gem-c-cookie-banner__confirmation-message--accepted govuk-body" hidden data-ga4-cookie-banner data-module="ga4-link-tracker" data-ga4-track-links-only data-ga4-set-indexes data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" >You have accepted additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> <p class="gem-c-cookie-banner__confirmation-message--rejected govuk-body" hidden>You have rejected additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> </div> </div> </div> <div class="js-confirmation-buttons govuk-button-group"> <button class="gem-c-button govuk-button" type="submit" data-accept-cookies="true" data-cookie-types="all">Accept additional cookies</button> <button class="gem-c-button govuk-button" type="submit" data-reject-cookies="true">Reject additional cookies</button> <a class="govuk-link" href="/cookies.html">View cookies</a> </div> <div hidden class="js-hide-button govuk-button-group"> <button class="gem-c-cookie-banner__hide-button govuk-button" data-hide-cookie-banner="true" data-module="ga4-event-tracker" data-ga4-event="{&quot;event_name&quot;:&quot;select_content&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;action&quot;:&quot;closed&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" > Hide cookie message </button> </div> </div> </div>`;
    var banner = document.createElement('div');
    banner.innerHTML = markup;
    document.body.prepend(banner);
  })
</script>


  </head>

  <body class="govuk-template__body">
    <script>document.body.className += ' js-enabled' + ('noModule' in HTMLScriptElement.prototype ? ' govuk-frontend-supported' : '');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <svg
          focusable="false"
          role="img"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 324 60"
          height="30"
          width="162"
          fill="currentcolor"
          class="govuk-header__logotype"
          aria-label="GOV.UK">
          <title>GOV.UK</title>
          <g>
            <circle cx="20" cy="17.6" r="3.7"></circle>
            <circle cx="10.2" cy="23.5" r="3.7"></circle>
            <circle cx="3.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <circle cx="43.3" cy="17.6" r="3.7"></circle>
            <circle cx="53.2" cy="23.5" r="3.7"></circle>
            <circle cx="59.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
          </g>
          <circle class="govuk-logo-dot" cx="226" cy="36" r="7.3"/>
          <path d="M93.94 41.25c.4 1.81 1.2 3.21 2.21 4.62 1 1.4 2.21 2.41 3.61 3.21s3.21 1.2 5.22 1.2 3.61-.4 4.82-1c1.4-.6 2.41-1.4 3.21-2.41.8-1 1.4-2.01 1.61-3.01s.4-2.01.4-3.01v.14h-10.86v-7.02h20.07v24.08h-8.03v-5.56c-.6.8-1.38 1.61-2.19 2.41-.8.8-1.81 1.2-2.81 1.81-1 .4-2.21.8-3.41 1.2s-2.41.4-3.81.4a18.56 18.56 0 0 1-14.65-6.63c-1.6-2.01-3.01-4.41-3.81-7.02s-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83a20.45 20.45 0 0 1 19.46-13.65c3.21 0 4.01.2 5.82.8 1.81.4 3.61 1.2 5.02 2.01 1.61.8 2.81 2.01 4.01 3.21s2.21 2.61 2.81 4.21l-7.63 4.41c-.4-1-1-1.81-1.61-2.61-.6-.8-1.4-1.4-2.21-2.01-.8-.6-1.81-1-2.81-1.4-1-.4-2.21-.4-3.61-.4-2.01 0-3.81.4-5.22 1.2-1.4.8-2.61 1.81-3.61 3.21s-1.61 2.81-2.21 4.62c-.4 1.81-.6 3.71-.6 5.42s.8 5.22.8 5.22Zm57.8-27.9c3.21 0 6.22.6 8.63 1.81 2.41 1.2 4.82 2.81 6.62 4.82S170.2 24.39 171 27s1.4 5.62 1.4 8.83-.4 6.02-1.4 8.83-2.41 5.02-4.01 7.02-4.01 3.61-6.62 4.82-5.42 1.81-8.63 1.81-6.22-.6-8.63-1.81-4.82-2.81-6.42-4.82-3.21-4.41-4.01-7.02-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83 2.41-5.02 4.01-7.02 4.01-3.61 6.42-4.82 5.42-1.81 8.63-1.81Zm0 36.73c1.81 0 3.61-.4 5.02-1s2.61-1.81 3.61-3.01 1.81-2.81 2.21-4.41c.4-1.81.8-3.61.8-5.62 0-2.21-.2-4.21-.8-6.02s-1.2-3.21-2.21-4.62c-1-1.2-2.21-2.21-3.61-3.01s-3.21-1-5.02-1-3.61.4-5.02 1c-1.4.8-2.61 1.81-3.61 3.01s-1.81 2.81-2.21 4.62c-.4 1.81-.8 3.61-.8 5.62 0 2.41.2 4.21.8 6.02.4 1.81 1.2 3.21 2.21 4.41s2.21 2.21 3.61 3.01c1.4.8 3.21 1 5.02 1Zm36.32 7.96-12.24-44.15h9.83l8.43 32.77h.4l8.23-32.77h9.83L200.3 58.04h-12.24Zm74.14-7.96c2.18 0 3.51-.6 3.51-.6 1.2-.6 2.01-1 2.81-1.81s1.4-1.81 1.81-2.81a13 13 0 0 0 .8-4.01V13.9h8.63v28.15c0 2.41-.4 4.62-1.4 6.62-.8 2.01-2.21 3.61-3.61 5.02s-3.41 2.41-5.62 3.21-4.62 1.2-7.02 1.2-5.02-.4-7.02-1.2c-2.21-.8-4.01-1.81-5.62-3.21s-2.81-3.01-3.61-5.02-1.4-4.21-1.4-6.62V13.9h8.63v26.95c0 1.61.2 3.01.8 4.01.4 1.2 1.2 2.21 2.01 2.81.8.8 1.81 1.4 2.81 1.81 0 0 1.34.6 3.51.6Zm34.22-36.18v18.92l15.65-18.92h10.82l-15.03 17.32 16.03 26.83h-10.21l-11.44-20.21-5.62 6.22v13.99h-8.83V13.9"/>
        </svg>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <nav class="govuk-header__navigation govuk-header__navigation--end" aria-label="Menu">
        <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" hidden>Menu</button>
        <ul id="navigation" class="govuk-header__navigation-list">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/manual.html" aria-current="page">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/kubernetes/">Kubernetes</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apps.html">Apps</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/repos.html">Repos</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/mobile/">Mobile</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1">
              <div class="search" data-module="search" data-path-to-site-root="/">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input
      type="search"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <a href='/manual.html' class="toc__back-link govuk-link">&lsaquo; Manual</a>
  <ul>
  <li>
    <a href="#header"><span>Intro to GOV.UK Docker (Advanced)</span></a>
    <ul>
      <li>
        <a href="#step-1-makefiles"><span>Step 1: Makefiles</span></a>
      </li>
      <li>
        <a href="#step-2-govuk"><span>Step 2: /govuk</span></a>
      </li>
      <li>
        <a href="#step-3-rbenv"><span>Step 3: rbenv</span></a>
      </li>
      <li>
        <a href="#step-4-rails"><span>Step 4: Rails</span></a>
      </li>
      <li>
        <a href="#step-5-yaml"><span>Step 5: YAML</span></a>
      </li>
      <li>
        <a href="#step-6-nginx"><span>Step 6: NGINX</span></a>
      </li>
      <li>
        <a href="#step-7-dnsmasq"><span>Step 7: dnsmasq</span></a>
      </li>
      <li>
        <a href="#step-8-cleanup"><span>Step 8: Cleanup</span></a>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled" aria-label="Content">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
                
<script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "item": {
        "name": "Home",
        "@id": "http://www.dev.gov.uk/"
      }
    },
    {
      "@type": "ListItem",
      "position": 2,
      "item": {
        "name": "Docker",
        "@id": "http://www.dev.gov.uk/manual.html#docker"
      }
    }
  ]
}
</script>

<nav data-module="ga4-link-tracker" aria-label="Breadcrumb" class="gem-c-breadcrumbs govuk-breadcrumbs">
  <ol class="govuk-breadcrumbs__list">
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;1&quot;,&quot;index_total&quot;:&quot;2&quot;}" class="govuk-breadcrumbs__link" href="/">Home</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;2&quot;,&quot;index_total&quot;:&quot;2&quot;}" class="govuk-breadcrumbs__link" href="/manual.html#docker">Docker</a>
        </li>
  </ol>
</nav>
   <div class="govuk-!-font-size-16 govuk-!-margin-top-6">
    <div class="govuk-warning-text">
      <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
      <strong class="govuk-warning-text__text">
        <span class="govuk-warning-text__assistive">Warning</span>
        This document has not been updated for a while now. It may be out of date.
      </strong>
    </div>

  Last updated: <a href="https://github.com/alphagov/govuk-developer-docs/commit/ea375597fa40411853b17a22c9246debf5b4a3ef">23 Nov 2022</a>
</div>

 <h1 id='header'>Intro to GOV.UK Docker (Advanced)</h1> <p>In the <a href="/manual/intro-to-docker.html">Intro to Docker tutorial</a> we began with a generic container running the <code>ruby</code> image, and finished with a powerful <code>docker-compose</code> command to run the <a href="https://github.com/alphagov/content-publisher">content-publisher</a> tests against a Postgres DB.</p>
<p>This tutorial is going to pick up where we left off and introduce some more advanced concepts that we make use of in <a href="https://github.com/alphagov/govuk-docker">govuk-docker</a>. You should be able to understand the bulk of the repo after completing this tutorial.</p>

<blockquote>
<p>You will need the following from the <a href="/manual/intro-to-docker.html">previous tutorial</a>:</p>

<ul>
<li>The <code>docker-compose.yml</code> file from Step 6</li>
<li>The Dockerfile that we wrote incrementally</li>
<li>The <code>.dockerignore</code> file from Step 3 (optional)</li>
</ul>
</blockquote>
<h2 id='step-1-makefiles'>Step 1: Makefiles</h2><p>We did some tidy-up work at the end of the last tutorial, but there are still some manual setup commands to run.</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$mac</span> docker-compose run content-publisher-demo bundle <span class="nb">install</span>
<span class="nv">$mac</span> docker-compose run content-publisher-demo bundle <span class="nb">exec </span>rake db:setup
</code></pre></div><p>To avoid having to remember these commands and type them to setup different projects, we can use a <a href="https://www.gnu.org/software/make/manual/html_node/Introduction.html">Makefile</a>.</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>content-publisher:
  docker-compose run content-publisher-demo bundle install
  docker-compose run content-publisher-demo bundle exec rake db:setup
</code></pre></div>
<blockquote>
<p>Makefiles use strict tabs for indentation, so you may need to adjust your editor if it&rsquo;s inserting spaces automatically.</p>
</blockquote>
<p>Now we can run <code>make content-publisher</code> and the commands are run for us.</p>
<h2 id='step-2-govuk'>Step 2: <code>/govuk</code></h2><p>At the end of the last tutorial we got some, but not all, of the tests passing. The remaining failures should be due to a missing dependency: <a href="https://github.com/alphagov/publishing-api/tree/main/content_schemas">content-schemas</a>. The tests are looking for the shemas at <code>../publishing-api/content_schemas</code>, which doesn&rsquo;t exist inside our container, since we only mapped the <code>content-publisher</code> directory to <code>/app</code>.</p>

<ul>
<li>Mount the whole of the <code>~/govuk</code> directory</li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>volumes:
  - bundle:/usr/local/bundle
  - ~/govuk:/govuk
</code></pre></div>
<ul>
<li>Adjust the working directory accordingly</li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>working_dir: /govuk/content-publisher
</code></pre></div>
<ul>
<li>Check all of the tests now pass (hopefully!)</li>
</ul>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$mac</span> docker-compose run content-publisher-demo bundle <span class="nb">exec </span>rake
</code></pre></div><h2 id='step-3-rbenv'>Step 3: rbenv</h2><p>In the last tutorial we used a <code>bundle</code> volume to persist the gems we installed. This works fine initially, but <a href="https://bundler.io/">Bundler</a> doesn&rsquo;t cope well if we start using a new version of Ruby.</p>
<p>On GOV.UK we use <a href="/manual/ruby.html">rbenv</a> to manage different Ruby versions. To support this, we need to build a lower-level base image that has rbenv and isn&rsquo;t tied to a version of Ruby.</p>

<ul>
<li>Change the <code>FROM</code> entry in our Dockerfile</li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>FROM buildpack-deps
</code></pre></div>
<ul>
<li>Install rbenv before we create the &lsquo;build&rsquo; user</li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>RUN git clone https://github.com/sstephenson/rbenv.git /rbenv
RUN git clone https://github.com/sstephenson/ruby-build.git /rbenv/plugins/ruby-build
RUN /rbenv/plugins/ruby-build/install.sh
ENV PATH /rbenv/bin:$PATH
</code></pre></div>
<ul>
<li>Add shims for ruby, bundler, etc. to the <code>PATH</code></li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>ENV PATH /home/build/.rbenv/shims:${PATH}
</code></pre></div>
<ul>
<li>Tell compose to rebuild the image we&rsquo;re using</li>
</ul>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$mac</span> docker-compose build content-publisher-demo
</code></pre></div><p>Rubies and gems will go into <code>/home/build/.rbenv</code> by default. We need to make sure this directory is persisted. If we persist the entire <code>/home/build</code> directory, we can also benefit from <a href="https://github.com/titusfortner/webdrivers#download-location">caching for chromedriver</a>.</p>

<ul>
<li>Replace the &lsquo;bundle&rsquo; volume with a &lsquo;home&rsquo; one</li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>volumes:
  home:
  postgres:
</code></pre></div>
<ul>
<li>Change the service to use the new &lsquo;home&rsquo; volume</li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>volumes:
  - home:/home/build
  - ~/govuk:/govuk
</code></pre></div>
<ul>
<li>Change our <code>Makefile</code> to install Ruby and bundler</li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>content-publisher:
  docker-compose run content-publisher-demo rbenv install -s
  docker-compose run content-publisher-demo sh -c 'gem install --conservative --no-document bundler -v $$(grep -A1 "BUNDLED WITH" Gemfile.lock | tail -1)'
  docker-compose run content-publisher-demo bundle install
  docker-compose run content-publisher-demo bundle exec rake db:setup
</code></pre></div>
<ul>
<li>Get the tests passing now we&rsquo;re running with rbenv</li>
</ul>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="c"># it can take some time to install Ruby!</span>
<span class="nv">$mac</span> make content-publisher

<span class="c"># run the tests</span>
<span class="nv">$mac</span> docker-compose run content-publisher-demo bundle <span class="nb">exec </span>rake
</code></pre></div><h2 id='step-4-rails'>Step 4: Rails</h2><p>Now the tests are passing, we&rsquo;re going to shift our focus and look at running Content Publisher as a web app. The aim is to get it running in our browser at <code>content-publisher-demo.intro-to-docker.gov.uk</code>.</p>
<p>Our host machine can&rsquo;t communicate with the process in the container. We need to expose the Rails port (3000) on our host machine, and tell Rails to listen for requests on all network interfaces.</p>

<ul>
<li>Start with a hacky bunch of command flags</li>
</ul>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$mac</span> docker-compose run <span class="nt">-p</span> 80:3000 content-publisher-demo bin/rails s <span class="nt">-b</span> 0.0.0.0
</code></pre></div>
<blockquote>
<p>If you see a <code>Bind for 0.0.0.0:80 failed</code> error, you need to stop the process on your local machine that&rsquo;s using this port. This is probably GOV.UK Docker, so try doing <code>govuk-docker down</code>.</p>
<p>If you see a <code>A server is already running</code> error, you need an additional <code>--restart</code> flag to tell Rails to cleanup its <code>tmp/pids</code> directory, which sometimes fails when containers exit too quickly.</p>
</blockquote>
<p>If you visit <code>localhost</code> in your browser, you should see some Rails logs in the terminal, and the Content Publisher homepage should (eventually) be visible. Now let&rsquo;s tidy up.</p>

<ul>
<li>Move the binding flag for Rails into config</li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>environment:
  BINDING: 0.0.0.0
</code></pre></div>
<ul>
<li>Run <code>rails s</code> as the default command</li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>command: bin/rails s
</code></pre></div>
<ul>
<li>Re-run with a slightly shorter command</li>
</ul>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$mac</span> docker-compose run <span class="nt">-p</span> 80:3000 content-publisher-demo
</code></pre></div>
<ul>
<li>Add a temporary entry in <code>/etc/hosts</code></li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>127.0.0.1 content-publisher-demo.intro-to-docker.gov.uk
</code></pre></div><p>You should now be able to go to this domain in your browser and see the Content Publisher homepage. After the next section we&rsquo;ll iterate this approach to make it more dynamic and work across multiple apps.</p>
<h2 id='step-5-yaml'>Step 5: YAML</h2><p>The <code>content-publisher-demo</code> service in our <code>docker-compose.yml</code> file is now serving two purposes: running tests and running the app. As we add more environment variables, dependencies, etc., it makes sense to have variants of <code>content-publisher-demo</code> that have just the right amount of config for what they need to do.</p>

<ul>
<li>Move common config into <a href="https://medium.com/@kinghuang/docker-compose-anchors-aliases-extensions-a1e4105d70bd">an extension</a></li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code># this needs a higher version of compose
version: '3.7'

x-content-publisher-demo: &amp;content-publisher-demo
  build:
    context: .
  volumes:
    - home:/home/build
    - ~/govuk:/govuk
  working_dir: /govuk/content-publisher
</code></pre></div>
<ul>
<li>Merge the config hash into the service</li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>services:
  ...

  content-publisher-demo:
    &lt;&lt;: *content-publisher-demo
    ...
</code></pre></div>
<ul>
<li>Split the &lsquo;demo&rsquo; service into two &lsquo;stacks&rsquo;</li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>services:
  ...

  # for tests
  content-publisher-demo-lite:
    &lt;&lt;: *content-publisher-demo
    privileged: true
    depends_on:
      - postgres
    environment:
      DATABASE_URL: "postgresql://postgres@postgres/content-publisher"
      TEST_DATABASE_URL: "postgresql://postgres@postgres/content-publisher-test"

  # for Rails
  content-publisher-demo-app:
    &lt;&lt;: *content-publisher-demo
    depends_on:
      - postgres
    environment:
      DATABASE_URL: "postgresql://postgres@postgres/content-publisher"
      HOST: 0.0.0.0
    command: bin/rails s
</code></pre></div>
<blockquote>
<p>Although the <code>depends_on</code> config is the same for both stacks in this case, in general we expect it to vary between stacks.</p>
</blockquote>

<ul>
<li>Update the Makefile to use the <code>lite</code> stack</li>
</ul>
<p>Each service will have its own image by default, which is based on the name of the service. Compose will build the images automatically when we try to <code>run</code> one of the stacks. Although the build time will be fast, because Docker will re-use layers it built previously, the extra &lsquo;build&rsquo; step is unnecessary and we can easily avoid it.</p>

<ul>
<li>Build/re-use the same image for both stacks</li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>x-content-publisher-demo: &amp;content-publisher-demo
  image: content-publisher-demo
  ...
</code></pre></div>
<ul>
<li>Check everything still works after the refactor</li>
</ul>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="c"># re-run setup</span>
<span class="nv">$mac</span> make content-publisher

<span class="c"># run the tests</span>
<span class="nv">$mac</span> docker-compose run content-publisher-demo-lite bundle <span class="nb">exec </span>rake

<span class="c"># run the app</span>
<span class="nv">$mac</span> docker-compose run <span class="nt">-p</span> 80:3000 content-publisher-demo-app
</code></pre></div><h2 id='step-6-nginx'>Step 6: NGINX</h2><p>In the previous section we used a <code>-p 80:3000</code> flag to make Rails, which runs on port 3000, available on our host machine, on port 80. This approach doesn&rsquo;t scale to multiple apps, since only one process can bind to port 80 at a time. We need a single app that can &lsquo;proxy&rsquo; our HTTP requests&hellip; an <a href="https://github.com/jwilder/nginx-proxy"><code>nginx-proxy</code></a>!</p>

<ul>
<li>Add a new service to our compose file</li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>nginx-proxy:
  image: jwilder/nginx-proxy:latest
  ports:
    - "80:80"
  volumes:
    - /var/run/docker.sock:/tmp/docker.sock
</code></pre></div><p>The nginx-proxy service will act as a &lsquo;front door&rsquo; for HTTP requests we make in the browser. We give it access to the Docker daemon so it can auto-detect which containers are running and scan their config for which domains they &lsquo;own&rsquo;. It will then proxy HTTP requests to a matching container, on a declared port.</p>

<ul>
<li>Change the <code>app</code> stack to work with it</li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>depends_on:
  - postgres
  - nginx-proxy
environment:
  ...
  VIRTUAL_HOST: content-publisher-demo.intro-to-docker.gov.uk
expose:
  - 3000
</code></pre></div>
<ul>
<li>Start the app and try it in your browser</li>
</ul>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$mac</span> docker-compose run content-publisher-demo-app
</code></pre></div><h2 id='step-7-dnsmasq'>Step 7: dnsmasq</h2><p>The reason <code>content-publisher-demo.intro-to-docker.gov.uk</code> works in your browser is because we added a custom entry in <code>/etc/hosts</code>. This approach doesn&rsquo;t scale to lots of entries, especially if we need to keep them in-sync across a team. We need something more dynamic, but that&rsquo;s not possible with <code>/etc/hosts</code>.</p>
<p>As part of <a href="https://github.com/alphagov/govuk-docker/blob/master/README.md">setting-up govuk-docker</a> you will have installed <a href="http://www.thekelleys.org.uk/dnsmasq/doc.html">dnsmasq</a>. This gives us a little DNS server running on our Mac, which we can use instead of <code>/etc/hosts</code> to resolve <code>*.intro-to-docker.gov.uk</code> to the localhost.</p>

<ul>
<li><p>Remove the temporary entry in <code>/etc/hosts</code></p></li>
<li><p>Create <code>/etc/resolver/intro-to-docker.gov.uk</code></p></li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>nameserver 127.0.0.1
port 53
</code></pre></div>
<ul>
<li>Check your Mac is aware of the new rule</li>
</ul>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$mac</span> scutil <span class="nt">--dns</span>

...

resolver <span class="c">#9</span>
  domain   : intro-to-docker.gov.uk
  nameserver[0] : 127.0.0.1
  port     : 53
  flags    : Request A records, Request AAAA records
  reach    : 0x00030002 <span class="o">(</span>Reachable,Local Address,Directly Reachable Address<span class="o">)</span>
</code></pre></div>
<ul>
<li>Edit <code>/usr/local/etc/dnsmasq.d/development.conf</code></li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>address=/dev.gov.uk/127.0.0.1
address=/intro-to-docker.gov.uk/127.0.0.1
</code></pre></div>
<ul>
<li>Restart dnsmasq and your DNS resolver</li>
</ul>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$mac</span> <span class="nb">sudo </span>killall <span class="nt">-HUP</span> mDNSResponder
<span class="nv">$mac</span> <span class="nb">sudo </span>brew services restart dnsmasq
</code></pre></div>
<ul>
<li>Start the app and try it in your browser</li>
</ul>
<p>That&rsquo;s it! You should now have something very similar to the repo we use to develop on GOV.UK. All that remains is for you to go forth, use it, make it work better, and develop some software :-).</p>
<h2 id='step-8-cleanup'>Step 8: Cleanup</h2><p>During this tutorial you created or changed a lot of files and state on your system. The following indicate how to cleanup your system e.g. if you want to run through the tutorials again.</p>

<ul>
<li>Remove all the extra docker state</li>
</ul>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>docker-compose down
docker <span class="nb">rm</span> <span class="si">$(</span>docker ps <span class="nt">-aq</span> <span class="nt">-f</span> <span class="nv">status</span><span class="o">=</span>exited<span class="si">)</span>
docker <span class="nb">rm</span> <span class="si">$(</span>docker ps <span class="nt">-aq</span> <span class="nt">-f</span> <span class="nv">status</span><span class="o">=</span>created<span class="si">)</span>
docker volume <span class="nb">rm </span>content-publisher-bundle
docker volume <span class="nb">rm </span>content-publisher-postgres
docker volume <span class="nb">rm </span>content-publisher_bundle
docker volume <span class="nb">rm </span>content-publisher_home
docker volume <span class="nb">rm </span>content-publisher_postgres
docker network <span class="nb">rm </span>content-publisher-network
docker network <span class="nb">rm </span>content-publisher_default
docker image <span class="nb">rm </span>content-publisher-demo
docker image <span class="nb">rm </span>content-publisher_content-publisher-demo
docker image <span class="nb">rm </span>content-publisher_content-publisher
docker image <span class="nb">rm</span> <span class="si">$(</span>docker image <span class="nb">ls</span> <span class="nt">-q</span> <span class="nt">-f</span> <span class="nv">dangling</span><span class="o">=</span><span class="nb">true</span><span class="si">)</span>
</code></pre></div>
<blockquote>
<p>Some of these commands may return errors if you&rsquo;ve deviated slightly from this tutorial. This isn&rsquo;t a problem.</p>
</blockquote>

<ul>
<li>Remove the files you created</li>
</ul>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nb">rm</span> .dockerignore docker-compose.yml Dockerfile Makefile
<span class="nb">sudo rm</span> /etc/resolver/intro-to-docker.gov.uk
</code></pre></div>
<ul>
<li>Re-run the setup for GOV.UK Docker</li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>cd ~/govuk/govuk-docker
bin/setup
</code></pre></div>
  <div class='related-content'>

    <h3>More in the Docker section</h3>

    <div class='govuk-grid-row'>
        <div class='govuk-grid-column-one-half'>
          <h4>Learn</h4>

          <ul class="govuk-list">
            <li><a href="/manual/intro-to-docker.html">Intro to GOV.UK Docker</a></li>
          </ul>
        </div>


    </div>
</div>


            
          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/govuk-developer-docs/blob/master/source/manual/intro-to-docker-advanced.html.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?body=Problem+with+%27Intro+to+GOV.UK+Docker+%28Advanced%29%27+%28https%3A%2F%2Fdocs.publishing.service.gov.uk%2Fmanual%2Fintro-to-docker-advanced.html%29&amp;labels=bug&amp;title=Re%3A+%27Intro+to+GOV.UK+Docker+%28Advanced%29%27">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <svg focusable="false" role="presentation" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 60" height="30" width="32" fill="currentcolor" class="govuk-footer__crown">
    <g>
      <circle cx="20" cy="17.6" r="3.7"></circle>
      <circle cx="10.2" cy="23.5" r="3.7"></circle>
      <circle cx="3.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <circle cx="43.3" cy="17.6" r="3.7"></circle>
      <circle cx="53.2" cy="23.5" r="3.7"></circle>
      <circle cx="59.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
    </g>
  </svg>
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/accessibility.html">Accessibility</a>
            </li>
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/cookies.html">Cookies</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >Â© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/govuk_frontend.js" type="module"></script>
    <script src="/javascripts/application.js"></script>
  </body>
</html>
