





<!doctype html>
<html lang="en" class="govuk-template govuk-template--rebranded no-js">
  <head>
    
    

    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Our content delivery network (CDN) - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/manual/cdn.html">
      <link rel="icon" sizes="48x48" href="/assets/govuk/assets/rebrand/images/favicon.ico">
      <link rel="icon" sizes="any" href="/assets/govuk/assets/rebrand/images/favicon.svg" type="image/svg+xml">
      <link rel="mask-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-mask.svg" color="#0b0c0c">
      <link rel="apple-touch-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-180.png">
      <link rel="manifest" href="/assets/govuk/assets/rebrand/manifest.json">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta name="twitter:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta name="twitter:title" content="Our content delivery network (CDN) - GOV.UK Developer Documentation" />
      <meta name="twitter:url" content="https://docs.publishing.service.gov.uk/manual/cdn.html" />

      <meta property="og:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="Our content delivery network (CDN)" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/manual/cdn.html" />

      <script>
  document.addEventListener('DOMContentLoaded', function () {
    var markup = `<div id="global-cookie-message" data-module="cookie-banner" data-nosnippet="" aria-label="Can we store analytics cookies on your device?" class="gem-c-cookie-banner govuk-clearfix govuk-cookie-banner js-banner-wrapper" role="region" hidden="hidden" title="Can we store analytics cookies on your device?"> <div class="govuk-cookie-banner__message govuk-width-container"> <div class="govuk-grid-row"> <div class="govuk-grid-column-two-thirds"> <h2 class="govuk-cookie-banner__heading govuk-heading-m">Can we store analytics cookies on your device?</h2> <div tabindex="-1" class="govuk-cookie-banner__content gem-c-cookie-banner__confirmation"> <div class="gem-c-cookie-banner__content"><p class='govuk-body'>We’d like to set some cookies to understand how you use this site and remember your settings.</p><p class='govuk-body'>We also use cookies set by other sites to help us deliver content from their services.</p></div> <p class="gem-c-cookie-banner__confirmation-message--accepted govuk-body" hidden data-ga4-cookie-banner data-module="ga4-link-tracker" data-ga4-track-links-only data-ga4-set-indexes data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" >You have accepted additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> <p class="gem-c-cookie-banner__confirmation-message--rejected govuk-body" hidden>You have rejected additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> </div> </div> </div> <div class="js-confirmation-buttons govuk-button-group"> <button class="gem-c-button govuk-button" type="submit" data-accept-cookies="true" data-cookie-types="all">Accept additional cookies</button> <button class="gem-c-button govuk-button" type="submit" data-reject-cookies="true">Reject additional cookies</button> <a class="govuk-link" href="/cookies.html">View cookies</a> </div> <div hidden class="js-hide-button govuk-button-group"> <button class="gem-c-cookie-banner__hide-button govuk-button" data-hide-cookie-banner="true" data-module="ga4-event-tracker" data-ga4-event="{&quot;event_name&quot;:&quot;select_content&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;action&quot;:&quot;closed&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" > Hide cookie message </button> </div> </div> </div>`;
    var banner = document.createElement('div');
    banner.innerHTML = markup;
    document.body.prepend(banner);
  })
</script>


  </head>

  <body class="govuk-template__body">
    <script>document.body.className += ' js-enabled' + ('noModule' in HTMLScriptElement.prototype ? ' govuk-frontend-supported' : '');</script>

    <div class="app-pane">
      
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <svg
          focusable="false"
          role="img"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 324 60"
          height="30"
          width="162"
          fill="currentcolor"
          class="govuk-header__logotype"
          aria-label="GOV.UK">
          <title>GOV.UK</title>
          <g>
            <circle cx="20" cy="17.6" r="3.7"></circle>
            <circle cx="10.2" cy="23.5" r="3.7"></circle>
            <circle cx="3.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <circle cx="43.3" cy="17.6" r="3.7"></circle>
            <circle cx="53.2" cy="23.5" r="3.7"></circle>
            <circle cx="59.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
          </g>
          <circle class="govuk-logo-dot" cx="226" cy="36" r="7.3"/>
          <path d="M93.94 41.25c.4 1.81 1.2 3.21 2.21 4.62 1 1.4 2.21 2.41 3.61 3.21s3.21 1.2 5.22 1.2 3.61-.4 4.82-1c1.4-.6 2.41-1.4 3.21-2.41.8-1 1.4-2.01 1.61-3.01s.4-2.01.4-3.01v.14h-10.86v-7.02h20.07v24.08h-8.03v-5.56c-.6.8-1.38 1.61-2.19 2.41-.8.8-1.81 1.2-2.81 1.81-1 .4-2.21.8-3.41 1.2s-2.41.4-3.81.4a18.56 18.56 0 0 1-14.65-6.63c-1.6-2.01-3.01-4.41-3.81-7.02s-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83a20.45 20.45 0 0 1 19.46-13.65c3.21 0 4.01.2 5.82.8 1.81.4 3.61 1.2 5.02 2.01 1.61.8 2.81 2.01 4.01 3.21s2.21 2.61 2.81 4.21l-7.63 4.41c-.4-1-1-1.81-1.61-2.61-.6-.8-1.4-1.4-2.21-2.01-.8-.6-1.81-1-2.81-1.4-1-.4-2.21-.4-3.61-.4-2.01 0-3.81.4-5.22 1.2-1.4.8-2.61 1.81-3.61 3.21s-1.61 2.81-2.21 4.62c-.4 1.81-.6 3.71-.6 5.42s.8 5.22.8 5.22Zm57.8-27.9c3.21 0 6.22.6 8.63 1.81 2.41 1.2 4.82 2.81 6.62 4.82S170.2 24.39 171 27s1.4 5.62 1.4 8.83-.4 6.02-1.4 8.83-2.41 5.02-4.01 7.02-4.01 3.61-6.62 4.82-5.42 1.81-8.63 1.81-6.22-.6-8.63-1.81-4.82-2.81-6.42-4.82-3.21-4.41-4.01-7.02-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83 2.41-5.02 4.01-7.02 4.01-3.61 6.42-4.82 5.42-1.81 8.63-1.81Zm0 36.73c1.81 0 3.61-.4 5.02-1s2.61-1.81 3.61-3.01 1.81-2.81 2.21-4.41c.4-1.81.8-3.61.8-5.62 0-2.21-.2-4.21-.8-6.02s-1.2-3.21-2.21-4.62c-1-1.2-2.21-2.21-3.61-3.01s-3.21-1-5.02-1-3.61.4-5.02 1c-1.4.8-2.61 1.81-3.61 3.01s-1.81 2.81-2.21 4.62c-.4 1.81-.8 3.61-.8 5.62 0 2.41.2 4.21.8 6.02.4 1.81 1.2 3.21 2.21 4.41s2.21 2.21 3.61 3.01c1.4.8 3.21 1 5.02 1Zm36.32 7.96-12.24-44.15h9.83l8.43 32.77h.4l8.23-32.77h9.83L200.3 58.04h-12.24Zm74.14-7.96c2.18 0 3.51-.6 3.51-.6 1.2-.6 2.01-1 2.81-1.81s1.4-1.81 1.81-2.81a13 13 0 0 0 .8-4.01V13.9h8.63v28.15c0 2.41-.4 4.62-1.4 6.62-.8 2.01-2.21 3.61-3.61 5.02s-3.41 2.41-5.62 3.21-4.62 1.2-7.02 1.2-5.02-.4-7.02-1.2c-2.21-.8-4.01-1.81-5.62-3.21s-2.81-3.01-3.61-5.02-1.4-4.21-1.4-6.62V13.9h8.63v26.95c0 1.61.2 3.01.8 4.01.4 1.2 1.2 2.21 2.01 2.81.8.8 1.81 1.4 2.81 1.81 0 0 1.34.6 3.51.6Zm34.22-36.18v18.92l15.65-18.92h10.82l-15.03 17.32 16.03 26.83h-10.21l-11.44-20.21-5.62 6.22v13.99h-8.83V13.9"/>
        </svg>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <nav class="govuk-header__navigation govuk-header__navigation--end" aria-label="Menu">
        <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" hidden>Menu</button>
        <ul id="navigation" class="govuk-header__navigation-list">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/manual.html" aria-current="page">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/kubernetes/">Kubernetes</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apps.html">Apps</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/repos.html">Repos</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/mobile/">Mobile</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1">
              <div class="search" data-module="search" data-path-to-site-root="/">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input
      type="search"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <a href='/manual.html' class="toc__back-link govuk-link">&lsaquo; Manual</a>
  <ul>
  <li>
    <a href="#header"><span>Our content delivery network (CDN)</span></a>
    <ul>
      <li>
        <a href="#cdn-configuration"><span>CDN configuration</span></a>
        <ul>
          <li>
            <a href="#deploying-fastly"><span>Deploying Fastly</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#fastly-caching"><span>Fastly Caching</span></a>
        <ul>
          <li>
            <a href="#conditional-request-caching"><span>Conditional request caching</span></a>
          </li>
          <li>
            <a href="#testing-vcl"><span>Testing VCL</span></a>
          </li>
          <li>
            <a href="#access-controls-on-cache-clearing"><span>Access controls on cache clearing</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#fastlys-ip-ranges-and-our-access-controls-on-origin-servers"><span>Fastly’s IP ranges and our access controls on origin servers</span></a>
      </li>
      <li>
        <a href="#ddos-protection"><span>DDOS protection</span></a>
        <ul>
          <li>
            <a href="#unblocking-legitimate-traffic"><span>Unblocking legitimate traffic</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#blocking-traffic-at-the-cdn-edge"><span>Blocking traffic at the CDN edge</span></a>
        <ul>
          <li>
            <a href="#block-requests-based-on-their-ip-addresses"><span>Block requests based on their IP addresses</span></a>
          </li>
          <li>
            <a href="#block-requests-based-on-their-ja3-signature"><span>Block requests based on their JA3 signature</span></a>
          </li>
          <li>
            <a href="#block-traffic-based-on-arbitrary-criteria"><span>Block traffic based on arbitrary criteria</span></a>
          </li>
          <li>
            <a href="#block-traffic-using-the-aws-waf"><span>Block traffic using the AWS WAF</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#bouncers-fastly-service"><span>Bouncer’s Fastly service</span></a>
        <ul>
          <li>
            <a href="#new-solution-for-bouncer-and-fastly"><span>New solution for Bouncer and Fastly</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled" aria-label="Content">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
                
<script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "item": {
        "name": "Home",
        "@id": "http://www.dev.gov.uk/"
      }
    },
    {
      "@type": "ListItem",
      "position": 2,
      "item": {
        "name": "CDN & Caching",
        "@id": "http://www.dev.gov.uk/manual.html#cdn-caching"
      }
    }
  ]
}
</script>

<nav data-module="ga4-link-tracker" aria-label="Breadcrumb" class="gem-c-breadcrumbs govuk-breadcrumbs">
  <ol class="govuk-breadcrumbs__list">
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;1&quot;,&quot;index_total&quot;:&quot;2&quot;}" class="govuk-breadcrumbs__link" href="/">Home</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;2&quot;,&quot;index_total&quot;:&quot;2&quot;}" class="govuk-breadcrumbs__link" href="/manual.html#cdn-caching">CDN &amp; Caching</a>
        </li>
  </ol>
</nav>
   <div class="govuk-!-font-size-16 govuk-!-margin-top-6">
    <div class="govuk-warning-text">
      <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
      <strong class="govuk-warning-text__text">
        <span class="govuk-warning-text__assistive">Warning</span>
        This document has not been updated for a while now. It may be out of date.
      </strong>
    </div>

  Last updated: <a href="https://github.com/alphagov/govuk-developer-docs/commit/b944a969d34df301c1d771dfe234ea5a8e1d4cf3">27 Aug 2025</a>
</div>

 <h1 id='header'>Our content delivery network (CDN)</h1> <p>GOV.UK uses Fastly as a CDN. Public users aren&rsquo;t accessing GOV.UK servers directly, they connect via the CDN. This is better because:</p>

<ul>
<li>The CDN &ldquo;edge nodes&rdquo; (webservers) are closer to end users. Fastly has servers all around the world but our &ldquo;origin&rdquo; servers are only in the AWS eu-west-1 region (Ireland).</li>
<li>It reduces load on our origin. Fastly uses Varnish to cache responses.</li>
</ul>
<p>The CDN is responsible for retrying requests against the <a href="/manual/fall-back-to-mirror.html">static mirror</a>.</p>
<p><a href="images/cdn-mirror-configuration.png" rel="noopener noreferrer"><img src="/manual/images/cdn-mirror-configuration.png" alt="image" /></a></p>
<h2 id='cdn-configuration'>CDN configuration</h2><p>Most of the CDN config is versioned and scripted:</p>

<ul>
<li><a href="https://github.com/alphagov/govuk-fastly">govuk-fastly</a></li>
<li><a href="https://github.com/alphagov/govuk-fastly-secrets">govuk-fastly-secrets</a></li>
</ul>
<p>The www, bouncer and assets services send logs to S3 which can be <a href="/manual/query-cdn-logs.html">queried</a>.
These logging endpoints are configured via <a href="https://github.com/alphagov/govuk-fastly-secrets/blob/a5cc9a5d25d014679a669a3ca4cb636d05409738/secrets.yaml#L62-L105">the secrets repo</a></p>
<h3 id='deploying-fastly'>Deploying Fastly</h3>
<ol>
<li>Make your changes in the <a href="https://github.com/alphagov/govuk-fastly">govuk-fastly</a> or <a href="https://github.com/alphagov/govuk-fastly-secrets">govuk-fastly-secrets</a> repositories and open a PR</li>
<li>Once the PR has been merged, check the proposed changes in the Terraform Cloud console

<ul>
<li>Check the <code>fastly-vcl-diff</code> post-plan task to view a diff of your VCL changes</li>
</ul></li>
<li>If you are happy with your changes, confirm the plan and wait for Terraform Cloud to deploy your changes</li>
</ol>
<h2 id='fastly-caching'>Fastly Caching</h2><p>The main www.gov.uk cache is <a href="https://varnish-cache.org/docs/2.1/index.html">Varnish</a>, which Fastly runs for us.</p>
<p>Varnish lets us configure our caching logic with VCL (Varnish config language).</p>
<p>It also lets us do fancy things, like <a href="https://github.com/alphagov/govuk-cdn-config/blob/f6cf15e9155f7c2ea89970741d3e03851a00013d/vcl_templates/www.vcl.erb#L202">only allowing connections to staging from permitted IPs</a>, <a href="https://github.com/alphagov/govuk-cdn-config/blob/f6cf15e9155f7c2ea89970741d3e03851a00013d/vcl_templates/www.vcl.erb#L222">forcing SSL</a> and <a href="https://github.com/alphagov/govuk-cdn-config/blob/f6cf15e9155f7c2ea89970741d3e03851a00013d/vcl_templates/www.vcl.erb#L208">blocking IP addresses</a>, among other things.</p>
<p>We set a default TTL of 300s (5 mins) on cached objects. This means that pages such as the GOV.UK homepage will be cached for 5 minutes. 5XX responses get cached for 1s; mirror responses get cached for 15 minutes.</p>
<p>We also set a grace period of 24 hours. So if the homepage server is down, we&rsquo;ll continue to serve a stale homepage for 24 hours.</p>
<p>These are the GET request status codes that Varnish caches automatically: 200, 203, 300, 301, 302, 404 or 410. (See the <a href="https://varnish-cache.org/docs/2.1/reference/vcl.html#variables">Varnish docs</a> for more detail.)</p>
<p>We have added to these - see the <a href="https://github.com/alphagov/govuk-fastly/">GOV.UK CDN Config repo</a> VCL for <a href="https://github.com/alphagov/govuk-cdn-config/blob/c37856f5cb463d204ef3926828f35204721eb7e9/vcl_templates/www.vcl.erb#L408-L416">special handling of certain status codes</a>, and for the most up-to-date version of what we&rsquo;re running in Fastly. Refer to the Varnish 2.1 documentation when looking at the VCL code.</p>
<h3 id='conditional-request-caching'>Conditional request caching</h3><p>Fastly will cache HTTP responses that include cache validation headers (such as ETag or Last-Modified) indefinitely. GOV.UK typically serves these headers with <a href="/manual/assets.html#uploaded-assets">assets uploaded to Asset Manager</a>.</p>
<p>When Fastly has a conditional response cached it will modify subsequent requests that it passes to origin to include <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Conditional_requests#conditional_headers">conditional HTTP headers</a>. This allows origin applications to return a 304 Not Modified status code to indicate the resource is unchanged and avoid an unnecessary data transfer. As Fastly, not the end user, has the resource cached a 304 response will need to be modified by Fastly into a 200 response with the cached resource attached.</p>
<p>If we mistakenly serve invalid responses with cache validation headers we will need to change the validation headers or manually <a href="/manual/purge-cache.html">purge the resource from the Fastly cache</a>, otherwise the incorrect resource could be served for a long time.</p>
<h3 id='testing-vcl'>Testing VCL</h3><p>VCL can be tricky to get right.</p>
<p>You can use Fastly&rsquo;s <a href="https://fiddle.fastlydemo.net/">Fiddle tool</a> to manually test, and you can also test your changes with cURL by including a debug header:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$ </span>curl <span class="nt">-svo</span> /dev/null <span class="nt">-H</span> <span class="s2">"Fastly-Debug: 1"</span> https://www.gov.uk/
</code></pre></div><p>This will give you various debugging headers that may be useful:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>&lt; Fastly-Debug-Path: &lt;nodes you hit&gt;
&lt; Fastly-Debug-TTL: &lt;nodes with TTL&gt;
&lt; Fastly-Debug-Digest: &lt;hash&gt;
&lt; X-Served-By: &lt;node that responded&gt;
&lt; X-Cache: HIT, HIT
&lt; X-Cache-Hits: 1
&lt; X-Timer: &lt;time it took&gt;
&lt; Vary: Accept-Encoding, Accept-Encoding
</code></pre></div><p>See the Varnish/Fastly docs for what these mean. Check out the Fastly <a href="https://docs.fastly.com/guides/debugging/checking-cache#using-curl">debugging guide</a> for more details on testing.</p>
<h3 id='access-controls-on-cache-clearing'>Access controls on cache clearing</h3><p>Our <a href="https://github.com/alphagov/govuk-fastly/">Fastly Varnish config</a> restricts HTTP purges to specific IP addresses (otherwise anyone would be able to purge the cache).</p>
<h2 id='fastlys-ip-ranges-and-our-access-controls-on-origin-servers'>Fastly&rsquo;s IP ranges and our access controls on origin servers</h2><p>Fastly publish their cache node <a href="https://api.fastly.com/public-ip-list">IP address ranges as JSON from their API</a>. We use these IP addresses in two places:</p>

<ul>
<li>Origin has firewall rules in place so that only our office and Fastly can connect. This is updated automatically using the <a href="https://registry.terraform.io/providers/fastly/fastly/latest/docs">Fastly Terraform provider</a> when the <a href="https://github.com/alphagov/govuk-aws/tree/master/terraform/projects/infra-security-groups">infra-security-groups</a> module is deployed. Triggering the deployment is still a manual step though.</li>
</ul>
<h2 id='ddos-protection'>DDOS protection</h2><p>Our services that sit behind Fastly have <a href="https://manage.fastly.com/security/ddos/protection">DDOS protection enabled</a>.</p>
<p>If we are experiencing an attack, and this is providing insufficient mitigation <a href="/manual/incident-what-to-do.html">start an incident</a>.</p>
<p>Sign in to Fastly and check for <a href="https://manage.fastly.com/security/ddos/protection/events">DDOS events</a>. There should be more information about any attack there.</p>
<p>If you need to raise a support ticket with Fastly, use the contact details on the <a href="https://docs.google.com/document/d/1ty12B5eBWB9YSfnD9xY1mr5rtTQxdNxRdmEGgibilN0">&ldquo;So you&rsquo;re having an incident&rdquo; document</a>.</p>
<p>You may want to consider adjusting the other <a href="/manual/web_application_firewall_rules.html">Web Application Firewalls</a> we use. Further CDN traffic management options are below.</p>
<h3 id='unblocking-legitimate-traffic'>Unblocking legitimate traffic</h3><p>It&rsquo;s possible that the automatic protection may block legitimate traffic. In this case, you may wish to <a href="/manual/incident-what-to-do.html">start an incident</a>.</p>
<p>Sign in to Fastly and check for <a href="https://manage.fastly.com/security/ddos/protection/events">DDOS events</a>. There should be more information about any detected events there.</p>
<p>You can inspect all the <a href="https://www.fastly.com/documentation/guides/security/ddos-protection/about-the-ddos-protection-controls/#about-the-events-page">matched rules for each event</a> to check if any of them look like they&rsquo;re incorrectly matching legitimate traffic.</p>
<p>You can <a href="https://www.fastly.com/documentation/guides/security/ddos-protection/about-the-ddos-protection-controls/#modifying-rule-behavior">override any of the generated DDOS protection rules</a> to block, log only, accept the default, or just turn them off.</p>
<p>If you need to do this, raise a support ticket with Fastly so that they can investigate false positives.</p>
<h2 id='blocking-traffic-at-the-cdn-edge'>Blocking traffic at the CDN edge</h2><p>If you need to block some subset of traffic, identify a unique field or set of fields to block on that will catch that traffic, but avoid blocking legitimate user traffic as far as possible. There are several options below.</p>
<p>If, for example, you <a href="/manual/query-cdn-logs.html">look at the CDN logs</a> and see an attack coming from thousands of different IPs, all with different user agent strings but with the same JA3 fingerprint, and if that JA3 fingerprint isn&rsquo;t present in other traffic (from before the attack began), you may want to consider blocking the JA3 fingerprint.</p>
<h3 id='block-requests-based-on-their-ip-addresses'>Block requests based on their IP addresses</h3><p>We occasionally decide to ban an IP address at our CDN edge if they exhibit the following behaviour:</p>

<ul>
<li>not respecting <a href="https://www.gov.uk/robots.txt">our robots.txt directives</a></li>
<li>repeatedly receiving 429 (rate limit) error responses from origin and not slowing down</li>
<li>making suspicious requests like attempting SQL injection queries</li>
</ul>
<p>Banning IPs shouldn&rsquo;t be taken lightly because many users can share the same IP address and the user behind an IP address can change over time, so there&rsquo;s always a chance that we may block legitimate users.</p>
<p>You can change the list of banned IP addresses by modifying the <a href="https://github.com/alphagov/govuk-fastly-secrets/blob/45381b4e0af022dfb4ba51c485551e023c2e2e12/dictionaries.yaml#L4">YAML config file</a> and <a href="https://app.terraform.io/app/govuk/workspaces/govuk-fastly-secrets">deploying the configuration</a>.</p>
<h3 id='block-requests-based-on-their-ja3-signature'>Block requests based on their JA3 signature</h3><p><a href="https://engineering.salesforce.com/open-sourcing-ja3-92c9e53c3c41/">JA3 is a way of fingerprinting TLS connections</a>, which can be used to detect whether a connection comes from a particular browser, or another TLS client (like curl, python, or possibly malware). They are useful as a way to match botnet/malware traffic if there are no better criteria available. Their opaqueness is a disadvantage in that it&rsquo;s not possible to tell anything about what traffic they might apply to by reading the configuration.</p>
<p>Much like the IP addresses logic above, we&rsquo;re able to block traffic based on its JA3 signature. To do this:</p>
<p>1) Update the <a href="https://github.com/alphagov/govuk-fastly-secrets/blob/45381b4e0af022dfb4ba51c485551e023c2e2e12/dictionaries.yaml#L1-L3">JA3 signature denylist dictionary</a>
2) <a href="https://app.terraform.io/app/govuk/workspaces/govuk-fastly-secrets">Deploy the dictionary</a> to the <code>www</code> and <code>assets</code> services.</p>
<p>Note that banning JA3s is potentially risky. If we get it wrong, we could ban a legitimate browser version.</p>
<h3 id='block-traffic-based-on-arbitrary-criteria'>Block traffic based on arbitrary criteria</h3><p>As well as blocking based on source IP address or JA3 fingerprint, we can also block abusive traffic based on headers, URL paths or any arbitrary criteria about the request that we can specify using VCL. This requires care and testing, but can be nonetheless a valueable incident response tool for mitigating DoS and spam attacks.</p>
<p>We have a mechanism for including VCL code from the private <code>govuk-cdn-config-secrets</code> repo into the Fastly config, so that mitigations we make during an attack are not published to the public repo for the attacker to see and work around. An example of this <a href="https://github.com/alphagov/govuk-fastly-secrets/blob/45381b4e0af022dfb4ba51c485551e023c2e2e12/secrets.yaml#L27-L35">can be found here</a>.</p>
<h3 id='block-traffic-using-the-aws-waf'>Block traffic using the AWS WAF</h3><p>Even if we allow traffic through from Fastly, we can block it at the AWS level using the <a href="https://aws.amazon.com/waf/">AWS WAF (Web Application Firewall)</a>.</p>
<p>See WAF configuration located in <a href="https://github.com/alphagov/govuk-infrastructure/tree/main/terraform/deployments/cloudfront">cloudfront</a> and <a href="https://github.com/alphagov/govuk-infrastructure/tree/main/terraform/deployments/govuk-publishing-infrastructure">publishing</a>.</p>
<h2 id='bouncers-fastly-service'>Bouncer&rsquo;s Fastly service</h2><p>A Fastly CDN service can normally handle up to 1000 domains - this limit is currently undocumented.</p>
<p>We have asked them to increase this limit for Bouncer&rsquo;s service a few times as the number of domains it handled grew, and the limit is <a href="https://fastly.zendesk.com/requests/7356">currently 3500</a>. We have <a href="https://transition.publishing.service.gov.uk/hosts">about 2000 domains</a> so shouldn&rsquo;t need to increase it again for a while.</p>
<p>If we reach the limit then the <a href="https://deploy.blue.production.govuk.digital/job/Bouncer_CDN/">Jenkins job to update Bouncer&rsquo;s CDN config</a> should fail and new domains won&rsquo;t be added to the service.</p>
<p>Configuring a new site in Transition generally adds at least 4 domains to the service, including the <code>aka</code> domain for each real domain. For example:</p>

<ul>
<li><code>www.foo.gov.uk</code></li>
<li><code>aka.foo.gov.uk</code></li>
<li><code>foo.gov.uk</code></li>
<li><code>aka-foo.gov.uk</code></li>
</ul>
<h3 id='new-solution-for-bouncer-and-fastly'>New solution for Bouncer and Fastly</h3><p>Fastly&rsquo;s new solution to get around the domain limit is a &ldquo;service pinned map&rdquo;.</p>
<p>They have created a map which we access using <code>bouncer-cdn.production.govuk.service.gov.uk</code>. Domains that need to be transitioned can <code>CNAME</code> to this domain. It also has 4 IP addresses assigned, which at the time of writing are the same as the <code>A</code> records at that hostname:</p>

<ul>
<li><code>151.101.2.30</code></li>
<li><code>151.101.66.30</code></li>
<li><code>151.101.130.30</code></li>
<li><code>151.101.194.30</code></li>
</ul>
<p>Domains do not need to be added to the &ldquo;Production Bouncer&rdquo; Fastly service like they used to be.</p>

  <div class='related-content'>

    <h3>More in the CDN & Caching section</h3>

    <div class='govuk-grid-row'>

        <div class='govuk-grid-column-one-half'>
          <h4>How to...</h4>

          <ul class="govuk-list">
            <li><a href="/manual/purge-cache.html">Purge a page from cache</a></li>
          </ul>
        </div>

    </div>
</div>


            
          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/govuk-developer-docs/blob/master/source/manual/cdn.html.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?body=Problem+with+%27Our+content+delivery+network+%28CDN%29%27+%28https%3A%2F%2Fdocs.publishing.service.gov.uk%2Fmanual%2Fcdn.html%29&amp;labels=bug&amp;title=Re%3A+%27Our+content+delivery+network+%28CDN%29%27">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <svg focusable="false" role="presentation" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 60" height="30" width="32" fill="currentcolor" class="govuk-footer__crown">
    <g>
      <circle cx="20" cy="17.6" r="3.7"></circle>
      <circle cx="10.2" cy="23.5" r="3.7"></circle>
      <circle cx="3.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <circle cx="43.3" cy="17.6" r="3.7"></circle>
      <circle cx="53.2" cy="23.5" r="3.7"></circle>
      <circle cx="59.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
    </g>
  </svg>
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/accessibility.html">Accessibility</a>
            </li>
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/cookies.html">Cookies</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/govuk_frontend.js" type="module"></script>
    <script src="/javascripts/application.js"></script>
  </body>
</html>
