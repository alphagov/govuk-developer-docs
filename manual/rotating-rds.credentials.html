





<!doctype html>
<html lang="en" class="govuk-template govuk-template--rebranded no-js">
  <head>
    
    

    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Rotate Relational Database Service (RDS) Credentials for GOV.UK Applications - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/manual/rotating-rds.credentials.html">
      <link rel="icon" sizes="48x48" href="/assets/govuk/assets/rebrand/images/favicon.ico">
      <link rel="icon" sizes="any" href="/assets/govuk/assets/rebrand/images/favicon.svg" type="image/svg+xml">
      <link rel="mask-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-mask.svg" color="#0b0c0c">
      <link rel="apple-touch-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-180.png">
      <link rel="manifest" href="/assets/govuk/assets/rebrand/manifest.json">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta name="twitter:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta name="twitter:title" content="Rotate Relational Database Service (RDS) Credentials for GOV.UK Applications - GOV.UK Developer Documentation" />
      <meta name="twitter:url" content="https://docs.publishing.service.gov.uk/manual/rotating-rds.credentials.html" />

      <meta property="og:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="Rotate Relational Database Service (RDS) Credentials for GOV.UK Applications" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/manual/rotating-rds.credentials.html" />

      <script>
  document.addEventListener('DOMContentLoaded', function () {
    var markup = `<div id="global-cookie-message" data-module="cookie-banner" data-nosnippet="" aria-label="Can we store analytics cookies on your device?" class="gem-c-cookie-banner govuk-clearfix govuk-cookie-banner js-banner-wrapper" role="region" hidden="hidden" title="Can we store analytics cookies on your device?"> <div class="govuk-cookie-banner__message govuk-width-container"> <div class="govuk-grid-row"> <div class="govuk-grid-column-two-thirds"> <h2 class="govuk-cookie-banner__heading govuk-heading-m">Can we store analytics cookies on your device?</h2> <div tabindex="-1" class="govuk-cookie-banner__content gem-c-cookie-banner__confirmation"> <div class="gem-c-cookie-banner__content"><p class='govuk-body'>We’d like to set some cookies to understand how you use this site and remember your settings.</p><p class='govuk-body'>We also use cookies set by other sites to help us deliver content from their services.</p></div> <p class="gem-c-cookie-banner__confirmation-message--accepted govuk-body" hidden data-ga4-cookie-banner data-module="ga4-link-tracker" data-ga4-track-links-only data-ga4-set-indexes data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" >You have accepted additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> <p class="gem-c-cookie-banner__confirmation-message--rejected govuk-body" hidden>You have rejected additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> </div> </div> </div> <div class="js-confirmation-buttons govuk-button-group"> <button class="gem-c-button govuk-button" type="submit" data-accept-cookies="true" data-cookie-types="all">Accept additional cookies</button> <button class="gem-c-button govuk-button" type="submit" data-reject-cookies="true">Reject additional cookies</button> <a class="govuk-link" href="/cookies.html">View cookies</a> </div> <div hidden class="js-hide-button govuk-button-group"> <button class="gem-c-cookie-banner__hide-button govuk-button" data-hide-cookie-banner="true" data-module="ga4-event-tracker" data-ga4-event="{&quot;event_name&quot;:&quot;select_content&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;action&quot;:&quot;closed&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" > Hide cookie message </button> </div> </div> </div>`;
    var banner = document.createElement('div');
    banner.innerHTML = markup;
    document.body.prepend(banner);
  })
</script>


  </head>

  <body class="govuk-template__body">
    <script>document.body.className += ' js-enabled' + ('noModule' in HTMLScriptElement.prototype ? ' govuk-frontend-supported' : '');</script>

    <div class="app-pane">
      
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <svg
          focusable="false"
          role="img"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 324 60"
          height="30"
          width="162"
          fill="currentcolor"
          class="govuk-header__logotype"
          aria-label="GOV.UK">
          <title>GOV.UK</title>
          <g>
            <circle cx="20" cy="17.6" r="3.7"></circle>
            <circle cx="10.2" cy="23.5" r="3.7"></circle>
            <circle cx="3.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <circle cx="43.3" cy="17.6" r="3.7"></circle>
            <circle cx="53.2" cy="23.5" r="3.7"></circle>
            <circle cx="59.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
          </g>
          <circle class="govuk-logo-dot" cx="226" cy="36" r="7.3"/>
          <path d="M93.94 41.25c.4 1.81 1.2 3.21 2.21 4.62 1 1.4 2.21 2.41 3.61 3.21s3.21 1.2 5.22 1.2 3.61-.4 4.82-1c1.4-.6 2.41-1.4 3.21-2.41.8-1 1.4-2.01 1.61-3.01s.4-2.01.4-3.01v.14h-10.86v-7.02h20.07v24.08h-8.03v-5.56c-.6.8-1.38 1.61-2.19 2.41-.8.8-1.81 1.2-2.81 1.81-1 .4-2.21.8-3.41 1.2s-2.41.4-3.81.4a18.56 18.56 0 0 1-14.65-6.63c-1.6-2.01-3.01-4.41-3.81-7.02s-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83a20.45 20.45 0 0 1 19.46-13.65c3.21 0 4.01.2 5.82.8 1.81.4 3.61 1.2 5.02 2.01 1.61.8 2.81 2.01 4.01 3.21s2.21 2.61 2.81 4.21l-7.63 4.41c-.4-1-1-1.81-1.61-2.61-.6-.8-1.4-1.4-2.21-2.01-.8-.6-1.81-1-2.81-1.4-1-.4-2.21-.4-3.61-.4-2.01 0-3.81.4-5.22 1.2-1.4.8-2.61 1.81-3.61 3.21s-1.61 2.81-2.21 4.62c-.4 1.81-.6 3.71-.6 5.42s.8 5.22.8 5.22Zm57.8-27.9c3.21 0 6.22.6 8.63 1.81 2.41 1.2 4.82 2.81 6.62 4.82S170.2 24.39 171 27s1.4 5.62 1.4 8.83-.4 6.02-1.4 8.83-2.41 5.02-4.01 7.02-4.01 3.61-6.62 4.82-5.42 1.81-8.63 1.81-6.22-.6-8.63-1.81-4.82-2.81-6.42-4.82-3.21-4.41-4.01-7.02-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83 2.41-5.02 4.01-7.02 4.01-3.61 6.42-4.82 5.42-1.81 8.63-1.81Zm0 36.73c1.81 0 3.61-.4 5.02-1s2.61-1.81 3.61-3.01 1.81-2.81 2.21-4.41c.4-1.81.8-3.61.8-5.62 0-2.21-.2-4.21-.8-6.02s-1.2-3.21-2.21-4.62c-1-1.2-2.21-2.21-3.61-3.01s-3.21-1-5.02-1-3.61.4-5.02 1c-1.4.8-2.61 1.81-3.61 3.01s-1.81 2.81-2.21 4.62c-.4 1.81-.8 3.61-.8 5.62 0 2.41.2 4.21.8 6.02.4 1.81 1.2 3.21 2.21 4.41s2.21 2.21 3.61 3.01c1.4.8 3.21 1 5.02 1Zm36.32 7.96-12.24-44.15h9.83l8.43 32.77h.4l8.23-32.77h9.83L200.3 58.04h-12.24Zm74.14-7.96c2.18 0 3.51-.6 3.51-.6 1.2-.6 2.01-1 2.81-1.81s1.4-1.81 1.81-2.81a13 13 0 0 0 .8-4.01V13.9h8.63v28.15c0 2.41-.4 4.62-1.4 6.62-.8 2.01-2.21 3.61-3.61 5.02s-3.41 2.41-5.62 3.21-4.62 1.2-7.02 1.2-5.02-.4-7.02-1.2c-2.21-.8-4.01-1.81-5.62-3.21s-2.81-3.01-3.61-5.02-1.4-4.21-1.4-6.62V13.9h8.63v26.95c0 1.61.2 3.01.8 4.01.4 1.2 1.2 2.21 2.01 2.81.8.8 1.81 1.4 2.81 1.81 0 0 1.34.6 3.51.6Zm34.22-36.18v18.92l15.65-18.92h10.82l-15.03 17.32 16.03 26.83h-10.21l-11.44-20.21-5.62 6.22v13.99h-8.83V13.9"/>
        </svg>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <nav class="govuk-header__navigation govuk-header__navigation--end" aria-label="Menu">
        <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" hidden>Menu</button>
        <ul id="navigation" class="govuk-header__navigation-list">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/manual.html" aria-current="page">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/kubernetes/">Kubernetes</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apps.html">Apps</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/repos.html">Repos</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/mobile/">Mobile</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1">
              <div class="search" data-module="search" data-path-to-site-root="/">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input
      type="search"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <a href='/manual.html' class="toc__back-link govuk-link">&lsaquo; Manual</a>
  <ul>
  <li>
    <a href="#header"><span>Rotate Relational Database Service (RDS) Credentials for GOV.UK Applications</span></a>
    <ul>
      <li>
        <a href="#the-process-for-mysql-databases"><span>The process for MySQL databases</span></a>
      </li>
      <li>
        <a href="#the-process-for-postgres-databases"><span>The process for Postgres databases</span></a>
      </li>
    </ul>
  </li>
  <li>
    <a href="#rotating-application-credentials"><span>Rotating Application Credentials</span></a>
    <ul>
      <li>
        <a href="#create-a-bastion-or-jump-box-pod"><span>Create a bastion or “jump box” Pod</span></a>
      </li>
      <li>
        <a href="#getting-the-aws_db_admin-rds-admin-user-credentials"><span>Getting the aws_db_admin RDS admin user credentials</span></a>
      </li>
    </ul>
  </li>
  <li>
    <a href="#managing-credentials-for-mysql-instances"><span>Managing credentials for MySQL instances</span></a>
    <ul>
      <li>
        <a href="#authenticating-to-the-mysql-terminal-with-the-aws_db_admin-user"><span>Authenticating to the MySQL terminal with the aws_db_admin user</span></a>
      </li>
      <li>
        <a href="#identifying-existing-users"><span>Identifying existing users</span></a>
      </li>
      <li>
        <a href="#get-existing-permissions"><span>Get existing permissions</span></a>
      </li>
      <li>
        <a href="#create-new-user"><span>Create new user</span></a>
      </li>
      <li>
        <a href="#check-for-other-mysql-objects"><span>Check for other MySQL objects</span></a>
      </li>
      <li>
        <a href="#rotate-credentials-in-aws-secretsmanager"><span>Rotate credentials in AWS SecretsManager</span></a>
        <ul>
          <li>
            <a href="#force-sync-of-kubernetes-secrets"><span>Force sync of Kubernetes secrets</span></a>
          </li>
          <li>
            <a href="#check-application-variables"><span>Check application variables</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#verify-rotation"><span>Verify rotation</span></a>
        <ul>
          <li>
            <a href="#repeat-process-in-lower-environments-if-necessary"><span>Repeat process in lower environments (if necessary)</span></a>
          </li>
          <li>
            <a href="#deleting-the-old-user"><span>Deleting the old user</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="#managing-credentials-for-postgres-instances"><span>Managing credentials for Postgres instances</span></a>
    <ul>
      <li>
        <a href="#authenticating-to-the-postgres-terminal-with-the-aws_db_admin-user"><span>Authenticating to the Postgres terminal with the aws_db_admin user</span></a>
      </li>
      <li>
        <a href="#identifying-existing-roles-users-and-ownerships"><span>Identifying existing roles (users) and ownerships</span></a>
      </li>
      <li>
        <a href="#create-new-user-for-postgres-database"><span>Create new user for Postgres database</span></a>
        <ul>
          <li>
            <a href="#verify-role-inheritance"><span>Verify role inheritance</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#rotate-credentials-in-aws-secretsmanager"><span>Rotate credentials in AWS SecretsManager</span></a>
        <ul>
          <li>
            <a href="#force-sync-of-kubernetes-secrets"><span>Force sync of Kubernetes secrets</span></a>
          </li>
          <li>
            <a href="#check-application-variables"><span>Check application variables</span></a>
          </li>
        </ul>
      </li>
      <li>
        <a href="#retiring-old-credentials"><span>Retiring old credentials</span></a>
        <ul>
          <li>
            <a href="#check-lingering-connections"><span>Check lingering connections</span></a>
          </li>
          <li>
            <a href="#wait-for-production-to-staging-sync-overnight"><span>Wait for Production-to-Staging sync overnight</span></a>
          </li>
          <li>
            <a href="#final-check-for-temporary-or-recent-objects"><span>Final check for temporary or recent objects</span></a>
          </li>
          <li>
            <a href="#delete-the-old-user"><span>Delete the old user</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <a href="#rotating-admin-credentials"><span>Rotating admin credentials</span></a>
    <ul>
      <li>
        <a href="#troubleshooting"><span>Troubleshooting</span></a>
        <ul>
          <li>
            <a href="#force-kill-connections-for-a-user-mysql"><span>Force-kill connections for a user (MySQL)</span></a>
          </li>
          <li>
            <a href="#force-kill-connections-for-a-user-postgres"><span>Force-kill connections for a user (Postgres)</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled" aria-label="Content">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
                
<script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "item": {
        "name": "Home",
        "@id": "http://www.dev.gov.uk/"
      }
    },
    {
      "@type": "ListItem",
      "position": 2,
      "item": {
        "name": "Databases",
        "@id": "http://www.dev.gov.uk/manual.html#databases"
      }
    }
  ]
}
</script>

<nav data-module="ga4-link-tracker" aria-label="Breadcrumb" class="gem-c-breadcrumbs govuk-breadcrumbs">
  <ol class="govuk-breadcrumbs__list">
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;1&quot;,&quot;index_total&quot;:&quot;2&quot;}" class="govuk-breadcrumbs__link" href="/">Home</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;2&quot;,&quot;index_total&quot;:&quot;2&quot;}" class="govuk-breadcrumbs__link" href="/manual.html#databases">Databases</a>
        </li>
  </ol>
</nav>
   <div class="govuk-!-font-size-16 govuk-!-margin-top-6">

  Last updated: <a href="https://github.com/alphagov/govuk-developer-docs/commit/227c5af9376a58c12fc090d35d8ed0b69ebbfa6a">4 Feb 2026</a>
</div>

 <h1 id='header'>Rotate Relational Database Service (RDS) Credentials for GOV.UK Applications</h1> <p>This documentation explains how to rotate (or create) <strong><a href="#rotating-application-credentials">Application Credentials</a></strong> for an RDS Database (backed by MySQL or Postgres). <a href="#rotating-admin-credentials">Admin Credentials</a> are managed by terraform and are rotated differently to application credentials.</p>
<h2 id='the-process-for-mysql-databases'>The process for MySQL databases</h2><p>The process for rotating credentials in MySQL Databases:</p>

<ol>
<li>Access the Database Instance (inside the VPC)</li>
<li>Create a new user</li>
<li>Grant the new user access the same rights to the Database as the current/old user</li>
<li>Update the credentials used by the application</li>
<li>Repeat the changes in the other environments</li>
<li>Confirm the old credentials are no longer in use</li>
<li>Delete the old users in each environment</li>
</ol>
<h2 id='the-process-for-postgres-databases'>The process for Postgres databases</h2><p>The process for Postgres databases is a bit different, due to the way Postgres handles permissions differently from MySQL:</p>

<ol>
<li>Access the Database Instance (inside the VPC) in Production</li>
<li>Make sure Database and Object owners are set to an &ldquo;owner role&rdquo; (across all environments)</li>
<li>Create a new user (in Production)</li>
<li>Update the credentials used by the application in Production</li>
<li>Wait overnight for the changes to be replicated into Staging</li>
<li>Validate the previous changes have synchronised into Staging</li>
<li>Update the credentials used by the application in Staging</li>
<li>Delete the old user in Production (the change will replicate into Staging overnight)</li>
</ol>
<h1 id='rotating-application-credentials'>Rotating Application Credentials</h1><h2 id='create-a-bastion-or-jump-box-pod'>Create a bastion or &ldquo;jump box&rdquo; Pod</h2><p>Before you can interact with MySQL or Postgres, you will need a way to interact with the RDS instance that sits inside the VPC.</p>
<p>Follow the <a href="/manual/create-bastion-pod.html">Bastion Documentation</a> for detailed instructions on how to do this.</p>
<h2 id='getting-the-aws_db_admin-rds-admin-user-credentials'>Getting the <code>aws_db_admin</code> RDS admin user credentials</h2><p>First, log in to the relevant AWS Console environment:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$ </span>gds aws govuk-some-environment-developer <span class="nt">-l</span>
</code></pre></div><p>You can find the database root password in the [env-name]-rds-admin-passwords secret in SecretsManager (where [env-name] is the name of an environment), under the key with the matching database name.</p>
<p>If you also need to find the hostname and Database Name for the relevant RDS instance, you can view it in the relevant secret under <code>govuk/[app-name]/[db-engine]</code> - substitute <code>[app-name]</code> and <code>[db-engine]</code> as relevant.</p>
<h1 id='managing-credentials-for-mysql-instances'>Managing credentials for MySQL instances</h1><p>Next, you will need to use the Jumpbox to start an interactive session with the Database Engine.</p>
<p>For the purpose of demonstrating the process, we will assume the Database you are rotating the credentials for is the <code>signon</code> Database.</p>
<h2 id='authenticating-to-the-mysql-terminal-with-the-aws_db_admin-user'>Authenticating to the MySQL terminal with the <code>aws_db_admin</code> user</h2><p>With a valid &ldquo;fulladmin&rdquo; AWS role, use <code>kubectl exec</code> against the Jumpbox you created earlier to start a bash session:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$ </span>gds aws govuk-some-environment-fulladmin <span class="nt">--</span> kubectl <span class="nt">-n</span> apps <span class="nb">exec</span> <span class="nt">-it</span> mysql-jumpbox <span class="nt">--</span> bash
</code></pre></div><p>If everything worked, you should now have a bash prompt inside the container.</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$ </span>mysql <span class="nt">--host</span> <span class="o">[</span>rds-hostname] <span class="nt">-p</span> <span class="nt">-u</span> aws_db_admin
</code></pre></div><p>Replace <code>[rds-hostname]</code> with the relevant hostname. You will be prompted for the password you fetched earlier. If successful you will now have an authenticated interactive MySQL session.</p>
<h2 id='identifying-existing-users'>Identifying existing users</h2><p>First check to see which users currently exist on the MySQL server:</p>
<div class="highlight"><pre class="highlight sql" tabindex="0"><code><span class="k">SELECT</span>
    <span class="k">User</span><span class="p">,</span>
    <span class="k">Host</span><span class="p">,</span>
    <span class="n">plugin</span> <span class="k">as</span> <span class="n">Auth_Method</span><span class="p">,</span>
    <span class="n">password_expired</span> <span class="k">as</span> <span class="n">Password_Expired</span><span class="p">,</span>
    <span class="n">account_locked</span> <span class="k">as</span> <span class="n">Account_Locked</span><span class="p">,</span>
    <span class="n">Super_priv</span> <span class="k">as</span> <span class="n">Is_Superuser</span><span class="p">,</span>
    <span class="n">Grant_priv</span> <span class="k">as</span> <span class="n">Can_Grant_Access</span>
<span class="k">FROM</span> <span class="n">mysql</span><span class="p">.</span><span class="k">user</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="k">User</span><span class="p">;</span>
</code></pre></div><p>This will give you a table that should look like this:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>+--------------------+-----------+-----------------------+------------------+----------------+--------------+------------------+
| User               | Host      | Auth_Method           | Password_Expired | Account_Locked | Is_Superuser | Can_Grant_Access |
+--------------------+-----------+-----------------------+------------------+----------------+--------------+------------------+
| aws_db_admin       | %         | mysql_native_password | N                | N              | N            | Y                |
| mysql.infoschema   | localhost | caching_sha2_password | N                | Y              | N            | N                |
| mysql.sys          | localhost | caching_sha2_password | N                | Y              | N            | N                |
| rds_superuser_role | %         | mysql_native_password | Y                | Y              | N            | Y                |
| rdsadmin           | localhost | auth_socket           | N                | N              | Y            | Y                |
| signon             | %         | mysql_native_password | N                | N              | N            | N                |
+--------------------+-----------+-----------------------+------------------+----------------+--------------+------------------+
</code></pre></div><p>In this example, we can see the existing <code>signon</code> user.</p>
<h2 id='get-existing-permissions'>Get existing permissions</h2><p>Next we will want to get the permissions for the <code>signon</code> user:</p>
<div class="highlight"><pre class="highlight sql" tabindex="0"><code><span class="k">SHOW</span> <span class="n">GRANTS</span> <span class="k">for</span> <span class="s1">'signon'</span><span class="p">;</span>
</code></pre></div><p>This will return a table that looks like:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>+---------------------------------------------------------------+
| Grants for signon@%                                           |
+---------------------------------------------------------------+
| GRANT USAGE ON *.* TO `signon`@`%`                            |
| GRANT ALL PRIVILEGES ON `signon_production`.* TO `signon`@`%` |
+---------------------------------------------------------------+
</code></pre></div><p>Take note of these permissions - you will want to make sure your new user has the same set of permissions.</p>
<h2 id='create-new-user'>Create new user</h2><p>Prepare a new randomly-generated password for the user that does not contain any &ldquo;special&rdquo; characters that would need to be URL-encoded. For example, you could use the <code>pwgen</code> command:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>pwgen <span class="nt">-s</span> 32 1
</code></pre></div><p>Create the new user in MySQL by using:</p>
<div class="highlight"><pre class="highlight sql" tabindex="0"><code><span class="c1">-- Create a new user, maybe date the user to make it clear when it was rotated.</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="s1">'signon_user_20260121'</span><span class="o">@</span><span class="s1">'%'</span> <span class="n">IDENTIFIED</span> <span class="k">BY</span> <span class="s1">'a-secret-password'</span><span class="p">;</span>
</code></pre></div><p>Then grant the necessary permissions to the new user:</p>
<div class="highlight"><pre class="highlight sql" tabindex="0"><code><span class="k">GRANT</span> <span class="k">ALL</span> <span class="k">PRIVILEGES</span> <span class="k">ON</span> <span class="n">signon_production</span><span class="p">.</span><span class="o">*</span> <span class="k">TO</span> <span class="s1">'signon_user_20260121'</span><span class="o">@</span><span class="s1">'%'</span><span class="p">;</span>
</code></pre></div><h2 id='check-for-other-mysql-objects'>Check for other MySQL objects</h2><p>MySQL has some specific objects that are &ldquo;defined&rdquo; (by default) by the database user that created them - specifically: Events, Functions, Procedures and Views. If your application uses any of these features, you will need to manually re-create these for the new user.</p>
<p>Run these lines to identify any Stored Procedures or Triggers you may need to migrate manually:</p>
<div class="highlight"><pre class="highlight sql" tabindex="0"><code><span class="k">SHOW</span> <span class="k">FUNCTION</span> <span class="n">STATUS</span> <span class="k">WHERE</span> <span class="n">db</span><span class="o">=</span><span class="s1">'signon_production'</span><span class="p">;</span>
<span class="k">SHOW</span> <span class="k">PROCEDURE</span> <span class="n">STATUS</span> <span class="k">WHERE</span> <span class="n">db</span><span class="o">=</span><span class="s1">'signon_production'</span><span class="p">;</span>
<span class="k">SHOW</span> <span class="n">TRIGGERS</span> <span class="k">FROM</span> <span class="n">signon_production</span><span class="p">;</span>
</code></pre></div><p>Run this to find any Views you may need to re-create:</p>
<div class="highlight"><pre class="highlight sql" tabindex="0"><code><span class="k">SELECT</span> <span class="k">TABLE_NAME</span><span class="p">,</span> <span class="k">DEFINER</span>
<span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">VIEWS</span>
<span class="k">WHERE</span> <span class="n">TABLE_SCHEMA</span> <span class="o">=</span> <span class="s1">'signon_production'</span><span class="p">;</span>
</code></pre></div><p>If the command returns&hellip;</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>Empty set (0.00 sec)
</code></pre></div><p>&hellip;then you can continue. However, if it returns a response like&hellip;</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>+----------------------+------------------+
| TABLE_NAME           | DEFINER          |
+----------------------+------------------+
| active_users_summary | signon@%         |
| daily_login_stats    | aws_db_admin@%   |
| gdpr_audit_log       | signon@%         |
+----------------------+------------------+
3 rows in set (0.00 sec)
</code></pre></div><p>&hellip;then you will need to migrate any views that are not owned by the admin user. Use SQL queries like <code>SHOW CREATE</code> to backup the definitions of your Procedures and Views and re-create them using the <code>aws_db_admin</code> user to prevent a recurrence of this problem.</p>
<h2 id='rotate-credentials-in-aws-secretsmanager'>Rotate credentials in AWS SecretsManager</h2><p>Next, you should access the AWS Console for the relevant environment with the <code>fulladmin</code> role and locate the relevant Secret in AWS SecretsManager.</p>
<p>Authenticate with the <code>fulladmin</code> role:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>gds aws govuk-[environmentname]-fulladmin <span class="nt">-l</span>
</code></pre></div><p>Also make sure your shell has a current <code>fulladmin</code> or <code>platformengineer</code> session - you will need this momentarily:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>gds aws govuk-[environmentname]-fulladmin <span class="nt">--shell</span>
</code></pre></div><p>Locate the secret named <code>govuk/signon/mysql</code> and edit the <code>username</code> and <code>password</code> keys to match the values of the new MySQL user you created earlier.</p>
<h3 id='force-sync-of-kubernetes-secrets'>Force sync of Kubernetes secrets</h3><p>Once you have updated the stored secrets in AWS SecretsManager, you will want to force a sync of the ExternalSecret objects held by Kubernetes.</p>
<p>If you are not sure which secret needs to be reloaded, you can search for potential matches with:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>kubectl <span class="nt">-n</span> apps get externalsecrets | <span class="nb">grep </span>signon
</code></pre></div><p>&hellip;which should return a list like&hellip;</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>signon-devise-pepper                                        ClusterSecretStore   aws-secretsmanager   1h                 SecretSynced    True
signon-devise-secret                                        ClusterSecretStore   aws-secretsmanager   1h                 SecretSynced    True
signon-mysql                                                ClusterSecretStore   aws-secretsmanager   1h                 SecretSynced    True
signon-notify                                               ClusterSecretStore   aws-secretsmanager   1h                 SecretSynced    True
signon-rails-secret-key-base                                ClusterSecretStore   aws-secretsmanager   1h                 SecretSynced    True
signon-sentry                                               ClusterSecretStore   aws-secretsmanager   1h                 SecretSynced    True
</code></pre></div><p>Once you have found the name of the ExternalSecrets object, annotate it to force a sync:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>kubectl annotate <span class="nt">-n</span> apps externalsecrets.external-secrets.io <span class="se">\</span>
  signon-mysql force-sync<span class="o">=</span><span class="si">$(</span><span class="nb">date</span> +%s<span class="si">)</span> <span class="nt">--overwrite</span>
</code></pre></div><p>Then run this command to verify that the Secret in Kubernetes has updated:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>kubectl get secret signon-mysql <span class="nt">-o</span> json | jq <span class="s1">'.data.DATABASE_URL | @base64d'</span>
</code></pre></div><p>You should see a connection string that looks similar to <code>mysql2://signon-user2:a-secret-password@hostname/signon_production</code> - check that the <code>username:password</code> bit matches what you expect it to.</p>
<h3 id='check-application-variables'>Check application variables</h3><p>Wait a few minutes before doing this to allow the cluster to complete a rollout.</p>
<p>Check one of the application pods to see if the DATABASE_URL environment variable has the correct secret (proving the pods have restarted with the new credentials):</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment/signon <span class="nt">--container</span><span class="o">=</span>app <span class="nt">--</span> <span class="nb">env</span> | <span class="nb">grep</span> <span class="s2">"DATABASE_URL"</span>
</code></pre></div><p>You should see the same connection string as earlier.</p>
<h2 id='verify-rotation'>Verify rotation</h2><p>Check that the new user is now being used to make connections:</p>
<div class="highlight"><pre class="highlight sql" tabindex="0"><code><span class="k">SELECT</span> <span class="k">USER</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">PROCESSLIST</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="k">USER</span><span class="p">;</span>
</code></pre></div><p>You should see a table similar to this, showing no connections for the old database user and some connections for the new one:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>+-------------------------+----------+
| USER                    | count(*) |
+-------------------------+----------+
| rdsadmin                |        2 |
| signon_user_20260121    |        2 |
| event_scheduler         |        1 |
| aws_db_admin            |        1 |
+-------------------------+----------+
</code></pre></div><p>If you have any dangling connections for your old user, you can kill them (see in Troubleshooting).</p>
<h3 id='repeat-process-in-lower-environments-if-necessary'>Repeat process in lower environments (if necessary)</h3><p>If you are following this process to rotate credentials in Production and Staging, you should repeat the process in other environments. Unlike our Postgres databases, MySQL&rsquo;s internal authentication and permission tables are not synced between environments. This means you will need to follow the process for each environment.</p>
<h3 id='deleting-the-old-user'>Deleting the old user</h3><p>Finally, you can delete the old user with:</p>
<div class="highlight"><pre class="highlight sql" tabindex="0"><code><span class="k">DROP</span> <span class="k">USER</span> <span class="s1">'signon'</span><span class="p">;</span>
</code></pre></div><p>You will want to do this for each environment where you have rotated the credentials.</p>
<h1 id='managing-credentials-for-postgres-instances'>Managing credentials for Postgres instances</h1><p>For the purpose of demonstrating the process, we will assume the Database you are rotating the credentials for is the <code>account-api</code> Database.</p>
<h2 id='authenticating-to-the-postgres-terminal-with-the-aws_db_admin-user'>Authenticating to the Postgres terminal with the <code>aws_db_admin</code> user</h2><p>With a valid &ldquo;fulladmin&rdquo; AWS role, use <code>kubectl exec</code> against the Jumpbox you created earlier to start a bash session:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$ </span>gds aws govuk-some-environment-fulladmin <span class="nt">--</span> kubectl <span class="nt">-n</span> apps <span class="nb">exec</span> <span class="nt">-it</span> postgres-jumpbox <span class="nt">--</span> bash
</code></pre></div><p>If everything worked, you should now have a bash prompt inside the container:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>I have no name!@postgres-jumpbox:/<span class="err">$</span>
</code></pre></div><p>You should now be able to use the Bash Prompt to start an interactive Postgres session:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="nv">$ </span>psql <span class="nt">--host</span> <span class="o">[</span>rds-hostname] <span class="nt">--username</span> aws_db_admin <span class="nt">--password</span> <span class="o">[</span>database-name]
</code></pre></div><p>Replace <code>[rds-hostname]</code> with the relevant hostname. You will be prompted for the password you fetched earlier. If successful you will now have an authenticated interactive Postgres session.</p>
<h2 id='identifying-existing-roles-users-and-ownerships'>Identifying existing roles (users) and ownerships</h2><p>Before you continue, you may want to check what roles and users currently exist for the Database.</p>
<p>Running <code>\du</code> should return a list of roles that looks like this:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>                                List of roles
    Role name    |                         Attributes
-----------------+------------------------------------------------------------
 account-api     |
 aws_db_admin    | Create role, Create DB                                    +
                 | Password valid until infinity
 rds_ad          | Cannot login
 rds_extension   | No inheritance, Cannot login
 rds_iam         | Cannot login
 rds_password    | Cannot login
 rds_replication | Cannot login
 rds_reserved    | No inheritance, Cannot login
 rds_superuser   | Cannot login
 rdsadmin        | Superuser, Create role, Create DB, Replication, Bypass RLS+
                 | Password valid until infinity
</code></pre></div><p>Running <code>\dt</code> will produce a list of tables and each of their owner roles, similar to:</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>                   List of tables
 Schema |         Name         | Type  |    Owner
--------+----------------------+-------+-------------
 public | ar_internal_metadata | table | account-api
 public | auth_requests        | table | account-api
 public | email_subscriptions  | table | account-api
 public | oidc_users           | table | account-api
 public | schema_migrations    | table | account-api
 public | sensitive_exceptions | table | account-api
 public | tombstones           | table | account-api
 public | users                | table | account-api
</code></pre></div><p>Unlike MySQL Databases, Postgres uses a different permissions model and has a concept of object owners that need to be managed correctly.</p>
<p>If the active application user (in these examples, <code>account-api</code>) owns the database objects and tables, you will need standardise the ownership of the Database and associated Tables.</p>
<p>Follow the <a href="/manual/convert-postgres-to-use-owner-roles.html">Convert Postgres to use Owner Roles</a> documentation before continuing.</p>
<h2 id='create-new-user-for-postgres-database'>Create new user for Postgres database</h2><p>Skip this stage if you are planning to rotate credentials in Staging only - any changes you make will be overwritten (and therefore undone) by the overnight backup-and-restore job.</p>
<p>Prepare a new randomly-generated password for the user that does not contain any &ldquo;special&rdquo; characters that would need to be URL-encoded. For example, you could use the <code>pwgen</code> command:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>pwgen <span class="nt">-s</span> 32 1
</code></pre></div><p>Create a new user with the password you just generated:</p>
<div class="highlight"><pre class="highlight sql" tabindex="0"><code><span class="c1">-- Create a new user, maybe date the user to make it clear when it was rotated.</span>
<span class="k">CREATE</span> <span class="k">USER</span> <span class="nv">"account-api-user-20260121"</span> <span class="k">WITH</span> <span class="n">password</span> <span class="s1">'a-secret-password'</span><span class="p">;</span>
</code></pre></div><p>Then you will need to &ldquo;grant&rdquo; the new user to inherit the ownership role that owns the database, its objects and tables:</p>
<div class="highlight"><pre class="highlight sql" tabindex="0"><code><span class="k">GRANT</span> <span class="nv">"account-api-owner-role"</span> <span class="k">TO</span> <span class="nv">"account-api-user-20260121"</span><span class="p">;</span>
</code></pre></div><h3 id='verify-role-inheritance'>Verify role inheritance</h3><p>Run this command to verify the new user has the correct inheritance:</p>
<div class="highlight"><pre class="highlight sql" tabindex="0"><code><span class="k">SELECT</span> <span class="n">r</span><span class="p">.</span><span class="n">rolname</span> <span class="k">as</span> <span class="n">user_name</span><span class="p">,</span> <span class="n">m</span><span class="p">.</span><span class="n">rolname</span> <span class="k">as</span> <span class="n">member_of</span>
<span class="k">FROM</span> <span class="n">pg_roles</span> <span class="n">r</span>
<span class="k">JOIN</span> <span class="n">pg_auth_members</span> <span class="n">am</span> <span class="k">ON</span> <span class="n">r</span><span class="p">.</span><span class="n">oid</span> <span class="o">=</span> <span class="n">am</span><span class="p">.</span><span class="n">member</span>
<span class="k">JOIN</span> <span class="n">pg_roles</span> <span class="n">m</span> <span class="k">ON</span> <span class="n">am</span><span class="p">.</span><span class="n">roleid</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">oid</span>
<span class="k">WHERE</span> <span class="n">r</span><span class="p">.</span><span class="n">rolname</span> <span class="o">=</span> <span class="s1">'account-api-user-20260121'</span><span class="p">;</span>
</code></pre></div><h2 id='rotate-credentials-in-aws-secretsmanager'>Rotate credentials in AWS SecretsManager</h2><p>Next, you should access the AWS Console for the relevant environment with the <code>fulladmin</code> role:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>gds aws govuk-[environmentname]-fulladmin <span class="nt">-l</span>
</code></pre></div><p>Also make sure your shell has a current <code>fulladmin</code> or <code>platformengineer</code> session:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>gds aws govuk-[environmentname]-fulladmin <span class="nt">--shell</span>
</code></pre></div><p>Then locate the relevant Secret in AWS SecretsManager. Locate the secret named <code>govuk/account-api/postgres</code> and edit the <code>username</code> and <code>password</code> keys to match the values of the new Postgres user you created earlier.</p>
<h3 id='force-sync-of-kubernetes-secrets'>Force sync of Kubernetes secrets</h3><p>Once you have updated the stored secrets in AWS SecretsManager, you will want to force a sync of the ExternalSecret objects held by Kubernetes:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>kubectl annotate <span class="nt">-n</span> apps externalsecrets.external-secrets.io <span class="se">\</span>
  account-api-postgres force-sync<span class="o">=</span><span class="si">$(</span><span class="nb">date</span> +%s<span class="si">)</span> <span class="nt">--overwrite</span>
</code></pre></div><p>Then run this command to verify that the Secret in Kubernetes has updated:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>kubectl get secret account-api-postgres <span class="nt">-o</span> json | jq <span class="s1">'.data.DATABASE_URL | @base64d'</span>
</code></pre></div><p>You should see a connection string that looks similar to <code>postgresql://account-api-user-20260121:a-secret-password@hostname/account-api_production</code> - check that the <code>username:password</code> bit matches what you expect it to.</p>
<h3 id='check-application-variables'>Check application variables</h3><p>Wait a few minutes before doing this to allow the cluster to complete a rollout.</p>
<p>Check one of the application pods that the DATABASE_URL environment variable has the correct secret (proving the pods have restarted with the new credentials):</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>kubectl <span class="nb">exec</span> <span class="nt">-it</span> deployment/account-api <span class="nt">--container</span><span class="o">=</span>app <span class="nt">--</span> <span class="nb">env</span> | <span class="nb">grep</span> <span class="s2">"DATABASE_URL"</span>
</code></pre></div><p>You should see the same connection string as earlier.</p>
<h2 id='retiring-old-credentials'>Retiring old credentials</h2><p>If you have completed the earlier steps correctly and the application is working with the new credentials, you can now proceed to retire the old credentials.</p>
<h3 id='check-lingering-connections'>Check lingering connections</h3><p>Run this command to see if there are any remaining connections from the old user:</p>
<div class="highlight"><pre class="highlight sql" tabindex="0"><code><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">active_connections</span><span class="p">,</span> <span class="n">application_name</span><span class="p">,</span> <span class="n">usename</span>
<span class="k">FROM</span> <span class="n">pg_stat_activity</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">application_name</span><span class="p">,</span> <span class="n">usename</span><span class="p">;</span>
</code></pre></div><p>If you can only see active connections from your new user and not the old one, you are free to proceed.</p>
<h3 id='wait-for-production-to-staging-sync-overnight'>Wait for Production-to-Staging sync overnight</h3><p>If you are following this process to rotate credentials in Production and Staging, you should now wait overnight for the changes to be replicated in Staging.</p>
<p>If you are following this procedure to retire compromised credentials, skip the wait for the overnight sync and repeat this guide manually for each environment (ensure you use the same username and password pair for the new credentials in Production and Staging).</p>
<p>If you are not following this guide for Production or Staging, you can skip the wait and continue to the next step.</p>
<h3 id='final-check-for-temporary-or-recent-objects'>Final check for temporary or recent objects</h3><p>Run the re-assign command to catch any temporary or last-minute objects the old user might have created prior to the credential switchover:</p>
<div class="highlight"><pre class="highlight sql" tabindex="0"><code><span class="n">REASSIGN</span> <span class="n">OWNED</span> <span class="k">BY</span> <span class="nv">"account-api"</span> <span class="k">TO</span> <span class="nv">"account-api-owner-role"</span><span class="p">;</span>
</code></pre></div><p>Then strip away any orphaned direct privileges:</p>
<div class="highlight"><pre class="highlight sql" tabindex="0"><code><span class="k">DROP</span> <span class="n">OWNED</span> <span class="k">BY</span> <span class="nv">"account-api"</span><span class="p">;</span>
</code></pre></div><h3 id='delete-the-old-user'>Delete the old user</h3><p>Finally, this deletes the old user in Production:</p>
<div class="highlight"><pre class="highlight sql" tabindex="0"><code><span class="k">DROP</span> <span class="k">USER</span> <span class="nv">"account-api"</span><span class="p">;</span>
</code></pre></div><h1 id='rotating-admin-credentials'>Rotating admin credentials</h1><p>Rotating Admin Credentials requires a platform engineer to taint and reapply terraform, following these steps:</p>

<ol>
<li>cd into <code>govuk-infrastructure/terraform/deployments/rds/</code></li>
<li><code>terraform login</code></li>
<li><code>terraform workspace select rds-&lt;environment&gt;</code></li>
<li><code>terraform init</code></li>
<li><code>terraform state list</code> to list all of the resources. The database password will have a resource name like <code>random_string.database_password[&quot;&lt;db_name&gt;&quot;]</code></li>
<li><code>terraform show &#39;random_string.database_password[&quot;&lt;db_name&gt;&quot;]&#39;</code> to verify this is the correct resource to change, this will output sensitive data to your console.</li>
<li><code>terraform taint &#39;random_string.database_password[&quot;&lt;db_name&gt;&quot;]&#39;</code>. Tainting informs Terraform that this object is degraded and will prompt Terraform to replace the object in the next plan and apply.</li>
<li>Visit Terraform Cloud in your browser and start a new run (plan and apply) in the correct workspace. This will update the SecretsManager version, recreate the terraform random_password and update the db instance with the new password</li>
<li>The SecretsManager secret <code>govuk/db-backup/passwd</code> is updated manually so login to the correct aws environment with &ldquo;platformengineer&rdquo; and copy the new password value to the correct db in the secret, you can copy the value out of the <code>&lt;env&gt;-rds-admin-passwords</code> secret (which is updated by terraform).</li>
<li>Lastly, roll the db-backup secret with <code>kubectl annotate -n apps externalsecrets.external-secrets.io db-backup-passwd force-sync=$(date +%s) --overwrite</code></li>
</ol>
<h2 id='troubleshooting'>Troubleshooting</h2><h3 id='force-kill-connections-for-a-user-mysql'>Force-kill connections for a user (MySQL)</h3><p>If you have connections that aren&rsquo;t going away, you can forcibly close them by running:</p>
<div class="highlight"><pre class="highlight sql" tabindex="0"><code><span class="k">SELECT</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">'CALL mysql.rds_kill('</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="s1">');'</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">information_schema</span><span class="p">.</span><span class="n">PROCESSLIST</span>
<span class="k">WHERE</span> <span class="k">USER</span> <span class="o">=</span> <span class="s1">'signon'</span><span class="p">;</span> <span class="c1">--Replace with the user to disconnect</span>
</code></pre></div><h3 id='force-kill-connections-for-a-user-postgres'>Force-kill connections for a user (Postgres)</h3><p>If you have connections that do not appear to be going away, you can force-kill any connections from a user by running the following command:</p>
<div class="highlight"><pre class="highlight sql" tabindex="0"><code><span class="k">SELECT</span> <span class="n">pg_terminate_backend</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">pg_stat_activity</span>
<span class="k">WHERE</span> <span class="n">usename</span> <span class="o">=</span> <span class="s1">'account-api'</span><span class="p">;</span> <span class="c1">--The username you want to drop connections for</span>
</code></pre></div>
  <div class='related-content'>

    <h3>More in the Databases section</h3>

    <div class='govuk-grid-row'>

        <div class='govuk-grid-column-one-half'>
          <h4>How to...</h4>

          <ul class="govuk-list">
            <li><a href="/manual/convert-postgres-to-use-owner-roles.html">Convert Postgres Instances to use Owner Roles</a></li>
            <li><a href="/manual/create-bastion-pod.html">Create a Bastion or "Jump box" to Access Databases</a></li>
            <li><a href="/manual/documentdb-mongo.html">DocumentDB and MongoDB Management</a></li>
            <li><a href="/manual/how-to-query-mysql-database-on-eks.html">How to query MySQL database on EKS</a></li>
          </ul>
        </div>

    </div>
</div>


            
          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/govuk-developer-docs/blob/master/source/manual/rotating-rds.credentials.html.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?body=Problem+with+%27Rotate+Relational+Database+Service+%28RDS%29+Credentials+for+GOV.UK+Applications%27+%28https%3A%2F%2Fdocs.publishing.service.gov.uk%2Fmanual%2Frotating-rds.credentials.html%29&amp;labels=bug&amp;title=Re%3A+%27Rotate+Relational+Database+Service+%28RDS%29+Credentials+for+GOV.UK+Applications%27">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <svg focusable="false" role="presentation" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 60" height="30" width="32" fill="currentcolor" class="govuk-footer__crown">
    <g>
      <circle cx="20" cy="17.6" r="3.7"></circle>
      <circle cx="10.2" cy="23.5" r="3.7"></circle>
      <circle cx="3.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <circle cx="43.3" cy="17.6" r="3.7"></circle>
      <circle cx="53.2" cy="23.5" r="3.7"></circle>
      <circle cx="59.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
    </g>
  </svg>
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/accessibility.html">Accessibility</a>
            </li>
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/cookies.html">Cookies</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/govuk_frontend.js" type="module"></script>
    <script src="/javascripts/application.js"></script>
  </body>
</html>
