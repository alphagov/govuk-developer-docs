





<!doctype html>
<html lang="en" class="govuk-template govuk-template--rebranded no-js">
  <head>
    
    

    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Fall back to AWS CloudFront - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/manual/fall-back-to-aws-cloudfront.html">
      <link rel="icon" sizes="48x48" href="/assets/govuk/assets/rebrand/images/favicon.ico">
      <link rel="icon" sizes="any" href="/assets/govuk/assets/rebrand/images/favicon.svg" type="image/svg+xml">
      <link rel="mask-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-mask.svg" color="#0b0c0c">
      <link rel="apple-touch-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-180.png">
      <link rel="manifest" href="/assets/govuk/assets/rebrand/manifest.json">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta name="twitter:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta name="twitter:title" content="Fall back to AWS CloudFront - GOV.UK Developer Documentation" />
      <meta name="twitter:url" content="https://docs.publishing.service.gov.uk/manual/fall-back-to-aws-cloudfront.html" />

      <meta property="og:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="Fall back to AWS CloudFront" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/manual/fall-back-to-aws-cloudfront.html" />

      <script>
  document.addEventListener('DOMContentLoaded', function () {
    var markup = `<div id="global-cookie-message" data-module="cookie-banner" data-nosnippet="" aria-label="Can we store analytics cookies on your device?" class="gem-c-cookie-banner govuk-clearfix govuk-cookie-banner js-banner-wrapper" role="region" hidden="hidden" title="Can we store analytics cookies on your device?"> <div class="govuk-cookie-banner__message govuk-width-container"> <div class="govuk-grid-row"> <div class="govuk-grid-column-two-thirds"> <h2 class="govuk-cookie-banner__heading govuk-heading-m">Can we store analytics cookies on your device?</h2> <div tabindex="-1" class="govuk-cookie-banner__content gem-c-cookie-banner__confirmation"> <div class="gem-c-cookie-banner__content"><p class='govuk-body'>We’d like to set some cookies to understand how you use this site and remember your settings.</p><p class='govuk-body'>We also use cookies set by other sites to help us deliver content from their services.</p></div> <p class="gem-c-cookie-banner__confirmation-message--accepted govuk-body" hidden data-ga4-cookie-banner data-module="ga4-link-tracker" data-ga4-track-links-only data-ga4-set-indexes data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" >You have accepted additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> <p class="gem-c-cookie-banner__confirmation-message--rejected govuk-body" hidden>You have rejected additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> </div> </div> </div> <div class="js-confirmation-buttons govuk-button-group"> <button class="gem-c-button govuk-button" type="submit" data-accept-cookies="true" data-cookie-types="all">Accept additional cookies</button> <button class="gem-c-button govuk-button" type="submit" data-reject-cookies="true">Reject additional cookies</button> <a class="govuk-link" href="/cookies.html">View cookies</a> </div> <div hidden class="js-hide-button govuk-button-group"> <button class="gem-c-cookie-banner__hide-button govuk-button" data-hide-cookie-banner="true" data-module="ga4-event-tracker" data-ga4-event="{&quot;event_name&quot;:&quot;select_content&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;action&quot;:&quot;closed&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" > Hide cookie message </button> </div> </div> </div>`;
    var banner = document.createElement('div');
    banner.innerHTML = markup;
    document.body.prepend(banner);
  })
</script>


  </head>

  <body class="govuk-template__body">
    <script>document.body.className += ' js-enabled' + ('noModule' in HTMLScriptElement.prototype ? ' govuk-frontend-supported' : '');</script>

    <div class="app-pane">
      
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <svg
          focusable="false"
          role="img"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 324 60"
          height="30"
          width="162"
          fill="currentcolor"
          class="govuk-header__logotype"
          aria-label="GOV.UK">
          <title>GOV.UK</title>
          <g>
            <circle cx="20" cy="17.6" r="3.7"></circle>
            <circle cx="10.2" cy="23.5" r="3.7"></circle>
            <circle cx="3.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <circle cx="43.3" cy="17.6" r="3.7"></circle>
            <circle cx="53.2" cy="23.5" r="3.7"></circle>
            <circle cx="59.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
          </g>
          <circle class="govuk-logo-dot" cx="226" cy="36" r="7.3"/>
          <path d="M93.94 41.25c.4 1.81 1.2 3.21 2.21 4.62 1 1.4 2.21 2.41 3.61 3.21s3.21 1.2 5.22 1.2 3.61-.4 4.82-1c1.4-.6 2.41-1.4 3.21-2.41.8-1 1.4-2.01 1.61-3.01s.4-2.01.4-3.01v.14h-10.86v-7.02h20.07v24.08h-8.03v-5.56c-.6.8-1.38 1.61-2.19 2.41-.8.8-1.81 1.2-2.81 1.81-1 .4-2.21.8-3.41 1.2s-2.41.4-3.81.4a18.56 18.56 0 0 1-14.65-6.63c-1.6-2.01-3.01-4.41-3.81-7.02s-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83a20.45 20.45 0 0 1 19.46-13.65c3.21 0 4.01.2 5.82.8 1.81.4 3.61 1.2 5.02 2.01 1.61.8 2.81 2.01 4.01 3.21s2.21 2.61 2.81 4.21l-7.63 4.41c-.4-1-1-1.81-1.61-2.61-.6-.8-1.4-1.4-2.21-2.01-.8-.6-1.81-1-2.81-1.4-1-.4-2.21-.4-3.61-.4-2.01 0-3.81.4-5.22 1.2-1.4.8-2.61 1.81-3.61 3.21s-1.61 2.81-2.21 4.62c-.4 1.81-.6 3.71-.6 5.42s.8 5.22.8 5.22Zm57.8-27.9c3.21 0 6.22.6 8.63 1.81 2.41 1.2 4.82 2.81 6.62 4.82S170.2 24.39 171 27s1.4 5.62 1.4 8.83-.4 6.02-1.4 8.83-2.41 5.02-4.01 7.02-4.01 3.61-6.62 4.82-5.42 1.81-8.63 1.81-6.22-.6-8.63-1.81-4.82-2.81-6.42-4.82-3.21-4.41-4.01-7.02-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83 2.41-5.02 4.01-7.02 4.01-3.61 6.42-4.82 5.42-1.81 8.63-1.81Zm0 36.73c1.81 0 3.61-.4 5.02-1s2.61-1.81 3.61-3.01 1.81-2.81 2.21-4.41c.4-1.81.8-3.61.8-5.62 0-2.21-.2-4.21-.8-6.02s-1.2-3.21-2.21-4.62c-1-1.2-2.21-2.21-3.61-3.01s-3.21-1-5.02-1-3.61.4-5.02 1c-1.4.8-2.61 1.81-3.61 3.01s-1.81 2.81-2.21 4.62c-.4 1.81-.8 3.61-.8 5.62 0 2.41.2 4.21.8 6.02.4 1.81 1.2 3.21 2.21 4.41s2.21 2.21 3.61 3.01c1.4.8 3.21 1 5.02 1Zm36.32 7.96-12.24-44.15h9.83l8.43 32.77h.4l8.23-32.77h9.83L200.3 58.04h-12.24Zm74.14-7.96c2.18 0 3.51-.6 3.51-.6 1.2-.6 2.01-1 2.81-1.81s1.4-1.81 1.81-2.81a13 13 0 0 0 .8-4.01V13.9h8.63v28.15c0 2.41-.4 4.62-1.4 6.62-.8 2.01-2.21 3.61-3.61 5.02s-3.41 2.41-5.62 3.21-4.62 1.2-7.02 1.2-5.02-.4-7.02-1.2c-2.21-.8-4.01-1.81-5.62-3.21s-2.81-3.01-3.61-5.02-1.4-4.21-1.4-6.62V13.9h8.63v26.95c0 1.61.2 3.01.8 4.01.4 1.2 1.2 2.21 2.01 2.81.8.8 1.81 1.4 2.81 1.81 0 0 1.34.6 3.51.6Zm34.22-36.18v18.92l15.65-18.92h10.82l-15.03 17.32 16.03 26.83h-10.21l-11.44-20.21-5.62 6.22v13.99h-8.83V13.9"/>
        </svg>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <nav class="govuk-header__navigation govuk-header__navigation--end" aria-label="Menu">
        <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" hidden>Menu</button>
        <ul id="navigation" class="govuk-header__navigation-list">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/manual.html" aria-current="page">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/kubernetes/">Kubernetes</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/apps.html">Apps</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/repos.html">Repos</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/mobile/">Mobile</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1">
              <div class="search" data-module="search" data-path-to-site-root="/">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input
      type="search"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <a href='/manual.html' class="toc__back-link govuk-link">&lsaquo; Manual</a>
  <ul>
  <li>
    <a href="#header"><span>Fall back to AWS CloudFront</span></a>
    <ul>
      <li>
        <a href="#fail-over-checklist"><span>Fail over checklist</span></a>
        <ul>
          <li>
            <a href="#initial-steps"><span>Initial steps</span></a>
          </li>
          <li>
            <a href="#production"><span>Production</span></a>
          </li>
          <li>
            <a href="#staging"><span>Staging</span></a>
          </li>
          <li>
            <a href="#finishing-up"><span>Finishing up</span></a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>


              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled" aria-label="Content">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
                
<script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "item": {
        "name": "Home",
        "@id": "http://www.dev.gov.uk/"
      }
    },
    {
      "@type": "ListItem",
      "position": 2,
      "item": {
        "name": "Deployment",
        "@id": "http://www.dev.gov.uk/manual.html#deployment"
      }
    }
  ]
}
</script>

<nav data-module="ga4-link-tracker" aria-label="Breadcrumb" class="gem-c-breadcrumbs govuk-breadcrumbs">
  <ol class="govuk-breadcrumbs__list">
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;1&quot;,&quot;index_total&quot;:&quot;2&quot;}" class="govuk-breadcrumbs__link" href="/">Home</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;2&quot;,&quot;index_total&quot;:&quot;2&quot;}" class="govuk-breadcrumbs__link" href="/manual.html#deployment">Deployment</a>
        </li>
  </ol>
</nav>
   <div class="govuk-!-font-size-16 govuk-!-margin-top-6">

  Last updated: <a href="https://github.com/alphagov/govuk-developer-docs/commit/36df86ad1ec20f8270c99fdd047895cb7a5da357">16 Jan 2026</a>
</div>

 <h1 id='header'>Fall back to AWS CloudFront</h1> <p>There is a backup Content Delivery Network (CDN) that can be used if Fastly is down.
This backup CDN is currently provided by AWS CloudFront.</p>

<blockquote>
<p><strong>Important</strong>: The failover CloudFront distribution does not have feature parity with the primary Fastly service.
<a href="https://docs.google.com/document/d/17_dfWvKNmqyLX1h_PPY6_Cd6IggrrSsP-Peh2De6JQk/edit">Most features</a> will continue to work, including search, smart answers, and postcode lookups. Some features, including
A/B testing, will not work.</p>
</blockquote>
<h2 id='fail-over-checklist'>Fail over checklist</h2>
<blockquote>
<p>Note: The last time we needed to initiate a CDN failover, we found that Terraform does not work reliably when Fastly is
having a major incident. The situation might have changed since then, but it is still recommended to perform the
failover manually, before attempting to update our Terraform configuration.</p>
</blockquote>

<!-- Force separation between these two blockquotes -->

<blockquote>
<p>Note: These steps will have you make changes to our production environment. This is because our DNS records and domains for our integration and staging environments are configured in our AWS and GCP production accounts.</p>
</blockquote>
<h3 id='initial-steps'>Initial steps</h3>
<ol>
<li>Confirm that Fastly is the cause of the incident (check <a href="https://status.fastly.com/">https://status.fastly.com/</a>
and keep an eye on X/Bluesky/Mastodon - if there&rsquo;s a major Fastly outage there will be a lot of noise)</li>
<li>Escalate to GOV.UK SMT as soon as you begin to consider failing over</li>
<li>Sign in to the AWS console as a fulladmin in the appropriate environment using the gds cli (or however you prefer to sign in to AWS):

<ul>
<li>For production: <code>gds aws govuk-production-fulladmin -l</code></li>
<li>For staging: <code>gds aws govuk-staging-fulladmin -l</code></li>
</ul></li>
<li>Sign in to <a href="https://console.cloud.google.com/home/dashboard?project=govuk-production">the <code>govuk-production</code> project on GCP console</a></li>
</ol>
<p>Now follow the steps below for <a href="#production"><strong>Production</strong></a> or for <a href="#staging"><strong>Staging</strong></a>, depending on your scenario:</p>

<blockquote>
<p>Note: If you are undertaking this as a drill, follow the steps for <strong>Staging</strong>.</p>
</blockquote>
<h3 id='production'>Production</h3><p>Open the following four pages as separate tabs:</p>

<ul>
<li><a href="https://console.cloud.google.com/net-services/dns/zones/govuk-service-gov-uk/rrsets/www-cdn.production.govuk.service.gov.uk./CNAME/edit?project=govuk-production">GCP Cloud DNS www-cdn.production.govuk.service.gov.uk</a></li>
<li><a href="https://console.aws.amazon.com/route53/v2/hostedzones#ListRecordSets/Z22RPYZA77J620">AWS Route 53 govuk.service.gov.uk</a></li>
<li><a href="https://console.cloud.google.com/net-services/dns/zones/publishing-service-gov-uk/rrsets/assets.publishing.service.gov.uk./CNAME/edit?project=govuk-production">GCP Cloud DNS assets.publishing.service.gov.uk</a></li>
<li><a href="https://console.aws.amazon.com/route53/v2/hostedzones#ListRecordSets/Z3SBFBO09PD5HF">AWS Route 53 publishing.service.gov.uk</a></li>
</ul>
<p>You are going to update the <code>CNAME</code> records for two different domains, in both GCP and AWS. These two domains are:</p>

<ul>
<li><code>www-cdn.production.govuk.service.gov.uk</code></li>
<li><code>assets.publishing.service.gov.uk</code></li>
</ul>
<p>Their values can be found in <a href="https://github.com/alphagov/govuk-infrastructure/blob/main/terraform/deployments/tfc-configuration/variables-production.tf">the Terraform configuration</a> for GOV.UK publishing infrastructure.</p>
<p>In order to stop these being reverted accidentally go to the <a href="https://app.terraform.io/app/govuk/workspaces/govuk-publishing-infrastructure-production">govuk-publishing-infrastructure-production terraform workspace</a>
and lock the workspace (press the Lock button in the top right of the page).</p>
<p>You can also get the <code>CNAME</code>s to use for the secondary CDN from the AWS CLI:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>  <span class="c"># www-cdn.production.govuk.service.gov.uk</span>
  gds aws govuk-production-developer aws cloudfront list-distributions <span class="nt">--output</span> text <span class="se">\</span>
    <span class="nt">--query</span> <span class="s2">"DistributionList.Items[?Aliases.Items[0]=='www.gov.uk'].DomainName | [0]"</span>
  <span class="c"># assets.publishing.service.gov.uk</span>
  gds aws govuk-production-developer aws cloudfront list-distributions <span class="nt">--output</span> text <span class="se">\</span>
    <span class="nt">--query</span> <span class="s2">"DistributionList.Items[?Aliases.Items[0]=='assets.publishing.service.gov.uk'].DomainName | [0]"</span>
</code></pre></div><p>The records should look like <code>d0000000000000.cloudfront.net.</code> (with 0s replaced with letters and numbers). Now you can manually update the <code>CNAME</code> records for both domains in both GCP and AWS, via the tabs you opened in your web browser earlier:</p>
<p>Prior to changing the CNAMEs, do a quick test to ensure CloudFront is serving requests:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>curl <span class="nt">--fail</span> <span class="nt">-vs</span> <span class="se">\</span>
  <span class="nt">--connect-to</span> www.gov.uk:443:&lt;www cloudfront domain e.g. d0000000000000.cloudfront.net&gt; <span class="se">\</span>
  https://www.gov.uk/browse/benefits <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"Success"</span>

curl <span class="nt">--fail</span> <span class="nt">-vs</span> <span class="se">\</span>
  <span class="nt">--connect-to</span> assets.publishing.service.gov.uk:443:&lt;assets cloudfront domain e.g. d0000000000000.cloudfront.net&gt; <span class="se">\</span>
  https://assets.publishing.service.gov.uk/media/662a74aa45f183ec818a72c2/dvsa-earned-recognition-vehicle-operators-accredited-list.csv/preview <span class="o">&amp;&amp;</span> <span class="nb">echo </span>success
</code></pre></div>
<ul>
<li>Change the canonical name from <code>www-gov-uk.map.fastly.net.</code> to the CloudFront domain name you found before, including the trailing period (e.g. <code>d0000000000000.cloudfront.net.</code>), and also set the TTL to 60 seconds</li>
<li>Test if the new Cloudfront domain is serving assets correctly, for example:</li>
</ul>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>curl <span class="nt">-vs</span> https://www.gov.uk/browse/benefits

curl <span class="nt">-vs</span> https://assets.publishing.service.gov.uk/media/662a74aa45f183ec818a72c2/dvsa-earned-recognition-vehicle-operators-accredited-list.csv/preview
</code></pre></div>
<ul>
<li>Two ways to check if the Cloudfront domains are working correctly (do this for both curl requests above):

<ul>
<li>There will <strong>not</strong> be an HTTP header returned with the name: <code>fastly-backend-name</code></li>
<li>Look for a value of <code>xxxxx.cloudfront.net</code> in the responses <code>via</code> HTTP Header.</li>
</ul></li>
<li>After performing the manual failover, you should also update our infrastructure-as-code to match the changes you just made:

<ul>
<li>Raise and merge a PR in <code>govuk-infrastructure</code> to fail over to CloudFront</li>
<li>Terraform Cloud should automatically perform a plan when your PR is merged, but the apply will require manual approval - you can do this in the <a href="https://app.terraform.io/app/govuk/workspaces/govuk-publishing-infrastructure-production">govuk-publishing-inrastructure-production workspace</a></li>
<li><a href="/repos/govuk-e2e-tests.html#running-the-tests-manually">Manually run the e2e tests</a> to confirm the core functionality is working as expected.</li>
</ul></li>
</ul>
<h3 id='staging'>Staging</h3><p><em>NOTE</em> Staging does not use GCP as a failover DNS provider, so for staging you will only be updating AWS Route53.</p>
<p>You must be on the Cabinet Office VPN, a DSIT laptop with ZScaler authenticated, or either of the WiFi networks in the White Chapel building to test any changes on staging.</p>
<p>Open the following page:</p>

<ul>
<li><a href="https://us-east-1.console.aws.amazon.com/route53/v2/hostedzones#ListRecordSets/Z05513091E15C53LVTH47">AWS Route 53 publishing.service.gov.uk (in the staging AWS account)</a></li>
</ul>
<p>You are going to update the <code>CNAME</code> records for two different domains, in AWS. These two domains are:</p>

<ul>
<li><code>www.staging.publishing.service.gov.uk</code></li>
<li><code>assets.staging.publishing.service.gov.uk</code></li>
</ul>
<p>In order to stop these being reverted accidentally go to the <a href="https://app.terraform.io/app/govuk/workspaces/govuk-publishing-infrastructure-staging">govuk-publishing-infrastructure-staging terraform workspace</a>
and lock the workspace (press the Lock button in the top right of the page).</p>
<p>You can get the <code>CNAME</code>s to use for the secondary CDN from the AWS CLI:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>  <span class="c"># www.staging.publishing.service.gov.uk</span>
  gds aws govuk-staging-developer aws cloudfront list-distributions <span class="nt">--output</span> text <span class="se">\</span>
    <span class="nt">--query</span> <span class="s2">"DistributionList.Items[?Aliases.Items[0]=='www.staging.publishing.service.gov.uk'].DomainName | [0]"</span>
  <span class="c"># assets.staging.publishing.service.gov.uk</span>
  gds aws govuk-staging-developer aws cloudfront list-distributions <span class="nt">--output</span> text <span class="se">\</span>
    <span class="nt">--query</span> <span class="s2">"DistributionList.Items[?Aliases.Items[0]=='assets.staging.publishing.service.gov.uk'].DomainName | [0]"</span>
</code></pre></div><p>The records should look like <code>d0000000000000.cloudfront.net.</code> (with 0s replaced with letters and numbers). Now you can manually update the <code>CNAME</code> records for both domains in AWS, via the tab you opened in your web browser earlier:</p>
<p>Prior to changing the CNAMEs, do a quick test to ensure CloudFront is serving requests:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>curl <span class="nt">--fail</span> <span class="nt">-vs</span> <span class="se">\</span>
  <span class="nt">--connect-to</span> www.staging.publishing.service.gov.uk:443:&lt;www cloudfront domain e.g. d0000000000000.cloudfront.net&gt; <span class="se">\</span>
  https://www.staging.publishing.service.gov.uk/browse/benefits <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">"Success"</span>

curl <span class="nt">--fail</span> <span class="nt">-vs</span> <span class="se">\</span>
  <span class="nt">--connect-to</span> assets.staging.publishing.service.gov.uk:443:&lt;assets cloudfront domain e.g. d0000000000000.cloudfront.net&gt; <span class="se">\</span>
  https://assets.staging.publishing.service.gov.uk/media/662a74aa45f183ec818a72c2/dvsa-earned-recognition-vehicle-operators-accredited-list.csv/preview <span class="o">&amp;&amp;</span> <span class="nb">echo </span>success

</code></pre></div>
<ul>
<li>Change the canonical name from <code>www-gov-uk.map.fastly.net.</code> to the CloudFront domain name you found before, including the trailing period (e.g. <code>d0000000000000.cloudfront.net.</code>), and also set the TTL to 60 seconds.</li>
<li>Test if the new Cloudfront domain is serving assets correctly, for example:</li>
</ul>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>curl <span class="nt">-vs</span> https://www.staging.publishing.service.gov.uk/browse/benefits

curl <span class="nt">-vs</span> https://assets.staging.publishing.service.gov.uk/media/662a74aa45f183ec818a72c2/dvsa-earned-recognition-vehicle-operators-accredited-list.csv/preview
</code></pre></div>
<ul>
<li><p>Two ways to check if the Cloudfront domains are working correctly (do this for both curl requests above):</p>

<ul>
<li>There will <strong>not</strong> be an HTTP header returned with the name: <code>fastly-backend-name</code></li>
<li>Look for a value of <code>xxxxx.cloudfront.net</code> in the responses <code>via</code> HTTP Header.</li>
</ul></li>
<li><p><a href="/repos/govuk-e2e-tests.html#running-the-tests-manually">Manually run the e2e tests</a> to confirm the core functionality is working as expected.</p></li>
</ul>
<h3 id='finishing-up'>Finishing up</h3>
<ul>
<li>Once you&rsquo;ve failed over, keep a close eye on Fastly&rsquo;s status</li>
<li>As soon as you are confident that Fastly has recovered

<ul>
<li>Manually set each of the <code>CNAME</code> records you changed above back to <code>www-gov-uk.map.fastly.net.</code></li>
<li>If you previously raised a PR in <a href="https://github.com/alphagov/govuk-infrastructure">govuk-infrastructure</a>, raise another PR to revert your changes and restore the old records.</li>
<li>Apply the <a href="https://app.terraform.io/app/govuk/workspaces/tfc-configuration">tfc-configuration terraform workspace</a>.</li>
<li>Apply the appropriate govuk-publishing terraform workspace:</li>
<li><a href="https://app.terraform.io/app/govuk/workspaces/govuk-publishing-infrastructure-production">govuk-publishing-infrastructure-production terraform workspace</a></li>
<li><a href="https://app.terraform.io/app/govuk/workspaces/govuk-publishing-infrastructure-staging">govuk-publishing-infrastructure-staging terraform workspace</a></li>
</ul></li>
</ul>

  <div class='related-content'>

    <h3>More in the Deployment section</h3>

    <div class='govuk-grid-row'>
        <div class='govuk-grid-column-one-half'>
          <h4>Learn</h4>

          <ul class="govuk-list">
            <li><a href="/manual/development-pipeline.html">The development pipeline</a></li>
          </ul>
        </div>

        <div class='govuk-grid-column-one-half'>
          <h4>How to...</h4>

          <ul class="govuk-list">
            <li><a href="/manual/github-unavailable.html">Deploy when GitHub is unavailable</a></li>
            <li><a href="/manual/deployments.html">Deployments</a></li>
            <li><a href="/manual/fall-back-to-mirror.html">GOV.UK content mirrors</a></li>
            <li><a href="/manual/publish-special-routes.html">Publish special routes</a></li>
            <li><a href="/manual/running-rake-tasks.html">Run a rake task</a></li>
            <li><a href="/manual/review-apps.html">Set up Heroku review apps for pull requests</a></li>
          </ul>
        </div>

    </div>
</div>


            
          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/govuk-developer-docs/blob/master/source/manual/fall-back-to-aws-cloudfront.html.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?body=Problem+with+%27Fall+back+to+AWS+CloudFront%27+%28https%3A%2F%2Fdocs.publishing.service.gov.uk%2Fmanual%2Ffall-back-to-aws-cloudfront.html%29&amp;labels=bug&amp;title=Re%3A+%27Fall+back+to+AWS+CloudFront%27">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <svg focusable="false" role="presentation" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 60" height="30" width="32" fill="currentcolor" class="govuk-footer__crown">
    <g>
      <circle cx="20" cy="17.6" r="3.7"></circle>
      <circle cx="10.2" cy="23.5" r="3.7"></circle>
      <circle cx="3.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <circle cx="43.3" cy="17.6" r="3.7"></circle>
      <circle cx="53.2" cy="23.5" r="3.7"></circle>
      <circle cx="59.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
    </g>
  </svg>
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/accessibility.html">Accessibility</a>
            </li>
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/cookies.html">Cookies</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/govuk_frontend.js" type="module"></script>
    <script src="/javascripts/application.js"></script>
  </body>
</html>
