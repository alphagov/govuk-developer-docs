name: Dependabot auto-merge
on: pull_request_target

permissions: 
  pull-requests: write
  contents: write

auto_merge:
  - package-ecosystem: bundler
    packages:
      - name: govuk_publishing_components
        semver: patches_only # or 'patches_and_minor' or 'all'
      # - name: gds-api-adapters
      #   semver: patches_only

jobs:
  dependabot:
  runs-on: ubuntu-latest
  if: ${{ github.actor == 'dependabot[bot]' }}
  steps:
    - name: Checkout source code
      uses: actions/checkout@v2

    - name: Dependabot metadata
      id: metadata
      uses: dependabot/fetch-metadata@v1.1.1
      with: 
        github_token: ${{ secrets.GITHUB_TOKEN }}

    - name: Enable auto-merge for Dependabot PRs
      if: ${{contains(steps.metadata.outputs.dependency-names, 'govuk_publishing_components') && steps.metadata.outputs.update-type == 'version-update:semver-patch'}}
      run: gh pr merge --auto --merge "$PR_URL"
      env:
        PR_URL: ${{ github.event.pull_request.html_url }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        ACTIONS_RUNNER_DEBUG: true