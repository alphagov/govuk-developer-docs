

<!doctype html>
<html lang="en" class="govuk-template govuk-template--rebranded no-js">
  <head>
    
    

    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>account-api: 002-progressive-enhancement - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/repos/account-api/adr/002-progressive-enhancement.html">
      <link rel="icon" sizes="48x48" href="/assets/govuk/assets/rebrand/images/favicon.ico">
      <link rel="icon" sizes="any" href="/assets/govuk/assets/rebrand/images/favicon.svg" type="image/svg+xml">
      <link rel="mask-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-mask.svg" color="#0b0c0c">
      <link rel="apple-touch-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-180.png">
      <link rel="manifest" href="/assets/govuk/assets/rebrand/manifest.json">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta name="twitter:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta name="twitter:title" content="account-api: 002-progressive-enhancement - GOV.UK Developer Documentation" />
      <meta name="twitter:url" content="https://docs.publishing.service.gov.uk/repos/account-api/adr/002-progressive-enhancement.html" />

      <meta property="og:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="account-api: 002-progressive-enhancement" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/repos/account-api/adr/002-progressive-enhancement.html" />

      <script>
  document.addEventListener('DOMContentLoaded', function () {
    var markup = `<div id="global-cookie-message" data-module="cookie-banner" data-nosnippet="" aria-label="Can we store analytics cookies on your device?" class="gem-c-cookie-banner govuk-clearfix govuk-cookie-banner js-banner-wrapper" role="region" hidden="hidden" title="Can we store analytics cookies on your device?"> <div class="govuk-cookie-banner__message govuk-width-container"> <div class="govuk-grid-row"> <div class="govuk-grid-column-two-thirds"> <h2 class="govuk-cookie-banner__heading govuk-heading-m">Can we store analytics cookies on your device?</h2> <div tabindex="-1" class="govuk-cookie-banner__content gem-c-cookie-banner__confirmation"> <div class="gem-c-cookie-banner__content"><p class='govuk-body'>We’d like to set some cookies to understand how you use this site and remember your settings.</p><p class='govuk-body'>We also use cookies set by other sites to help us deliver content from their services.</p></div> <p class="gem-c-cookie-banner__confirmation-message--accepted govuk-body" hidden data-ga4-cookie-banner data-module="ga4-link-tracker" data-ga4-track-links-only data-ga4-set-indexes data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" >You have accepted additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> <p class="gem-c-cookie-banner__confirmation-message--rejected govuk-body" hidden>You have rejected additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> </div> </div> </div> <div class="js-confirmation-buttons govuk-button-group"> <button class="gem-c-button govuk-button" type="submit" data-accept-cookies="true" data-cookie-types="all">Accept additional cookies</button> <button class="gem-c-button govuk-button" type="submit" data-reject-cookies="true">Reject additional cookies</button> <a class="govuk-link" href="/cookies.html">View cookies</a> </div> <div hidden class="js-hide-button govuk-button-group"> <button class="gem-c-cookie-banner__hide-button govuk-button" data-hide-cookie-banner="true" data-module="ga4-event-tracker" data-ga4-event="{&quot;event_name&quot;:&quot;select_content&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;action&quot;:&quot;closed&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" > Hide cookie message </button> </div> </div> </div>`;
    var banner = document.createElement('div');
    banner.innerHTML = markup;
    document.body.prepend(banner);
  })
</script>


  </head>

  <body class="govuk-template__body">
    <script>document.body.className += ' js-enabled' + ('noModule' in HTMLScriptElement.prototype ? ' govuk-frontend-supported' : '');</script>

    <div class="app-pane">
      
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <svg
          focusable="false"
          role="img"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 324 60"
          height="30"
          width="162"
          fill="currentcolor"
          class="govuk-header__logotype"
          aria-label="GOV.UK">
          <title>GOV.UK</title>
          <g>
            <circle cx="20" cy="17.6" r="3.7"></circle>
            <circle cx="10.2" cy="23.5" r="3.7"></circle>
            <circle cx="3.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <circle cx="43.3" cy="17.6" r="3.7"></circle>
            <circle cx="53.2" cy="23.5" r="3.7"></circle>
            <circle cx="59.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
          </g>
          <circle class="govuk-logo-dot" cx="226" cy="36" r="7.3"/>
          <path d="M93.94 41.25c.4 1.81 1.2 3.21 2.21 4.62 1 1.4 2.21 2.41 3.61 3.21s3.21 1.2 5.22 1.2 3.61-.4 4.82-1c1.4-.6 2.41-1.4 3.21-2.41.8-1 1.4-2.01 1.61-3.01s.4-2.01.4-3.01v.14h-10.86v-7.02h20.07v24.08h-8.03v-5.56c-.6.8-1.38 1.61-2.19 2.41-.8.8-1.81 1.2-2.81 1.81-1 .4-2.21.8-3.41 1.2s-2.41.4-3.81.4a18.56 18.56 0 0 1-14.65-6.63c-1.6-2.01-3.01-4.41-3.81-7.02s-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83a20.45 20.45 0 0 1 19.46-13.65c3.21 0 4.01.2 5.82.8 1.81.4 3.61 1.2 5.02 2.01 1.61.8 2.81 2.01 4.01 3.21s2.21 2.61 2.81 4.21l-7.63 4.41c-.4-1-1-1.81-1.61-2.61-.6-.8-1.4-1.4-2.21-2.01-.8-.6-1.81-1-2.81-1.4-1-.4-2.21-.4-3.61-.4-2.01 0-3.81.4-5.22 1.2-1.4.8-2.61 1.81-3.61 3.21s-1.61 2.81-2.21 4.62c-.4 1.81-.6 3.71-.6 5.42s.8 5.22.8 5.22Zm57.8-27.9c3.21 0 6.22.6 8.63 1.81 2.41 1.2 4.82 2.81 6.62 4.82S170.2 24.39 171 27s1.4 5.62 1.4 8.83-.4 6.02-1.4 8.83-2.41 5.02-4.01 7.02-4.01 3.61-6.62 4.82-5.42 1.81-8.63 1.81-6.22-.6-8.63-1.81-4.82-2.81-6.42-4.82-3.21-4.41-4.01-7.02-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83 2.41-5.02 4.01-7.02 4.01-3.61 6.42-4.82 5.42-1.81 8.63-1.81Zm0 36.73c1.81 0 3.61-.4 5.02-1s2.61-1.81 3.61-3.01 1.81-2.81 2.21-4.41c.4-1.81.8-3.61.8-5.62 0-2.21-.2-4.21-.8-6.02s-1.2-3.21-2.21-4.62c-1-1.2-2.21-2.21-3.61-3.01s-3.21-1-5.02-1-3.61.4-5.02 1c-1.4.8-2.61 1.81-3.61 3.01s-1.81 2.81-2.21 4.62c-.4 1.81-.8 3.61-.8 5.62 0 2.41.2 4.21.8 6.02.4 1.81 1.2 3.21 2.21 4.41s2.21 2.21 3.61 3.01c1.4.8 3.21 1 5.02 1Zm36.32 7.96-12.24-44.15h9.83l8.43 32.77h.4l8.23-32.77h9.83L200.3 58.04h-12.24Zm74.14-7.96c2.18 0 3.51-.6 3.51-.6 1.2-.6 2.01-1 2.81-1.81s1.4-1.81 1.81-2.81a13 13 0 0 0 .8-4.01V13.9h8.63v28.15c0 2.41-.4 4.62-1.4 6.62-.8 2.01-2.21 3.61-3.61 5.02s-3.41 2.41-5.62 3.21-4.62 1.2-7.02 1.2-5.02-.4-7.02-1.2c-2.21-.8-4.01-1.81-5.62-3.21s-2.81-3.01-3.61-5.02-1.4-4.21-1.4-6.62V13.9h8.63v26.95c0 1.61.2 3.01.8 4.01.4 1.2 1.2 2.21 2.01 2.81.8.8 1.81 1.4 2.81 1.81 0 0 1.34.6 3.51.6Zm34.22-36.18v18.92l15.65-18.92h10.82l-15.03 17.32 16.03 26.83h-10.21l-11.44-20.21-5.62 6.22v13.99h-8.83V13.9"/>
        </svg>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <nav class="govuk-header__navigation govuk-header__navigation--end" aria-label="Menu">
        <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" hidden>Menu</button>
        <ul id="navigation" class="govuk-header__navigation-list">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual.html">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/kubernetes/">Kubernetes</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/apps.html" aria-current="page">Apps</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/repos.html">Repos</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/mobile/">Mobile</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1">
              <div class="search" data-module="search" data-path-to-site-root="/">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input
      type="search"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <ul>
    <li>
      <a href="/repos/account-api.html" rel="noopener" class="govuk-link">account-api</a>
    </li>
    <li>
      <ul>
            <li><a href="/repos/account-api/api.html" rel="noopener" class="govuk-link">API documentation</a></li>
    <li><a href="/repos/account-api/one-login-pipeline.html" rel="noopener" class="govuk-link">One Login to GOV.UK pipeline</a></li>
    <li><a href="/repos/account-api/one-login.html" rel="noopener" class="govuk-link">One Login</a></li>
    <li class="subdir__heading">adr</li>
    <ul class="subdir__menu">
          <li><a href="/repos/account-api/adr/001-flash-messages.html" rel="noopener" class="govuk-link">001-flash-messages</a></li>
    <li><a href="/repos/account-api/adr/002-progressive-enhancement.html" rel="noopener" class="govuk-link">002-progressive-enhancement</a></li>
    <li><a href="/repos/account-api/adr/003-cookie-consent.html" rel="noopener" class="govuk-link">003-cookie-consent</a></li>
    <li><a href="/repos/account-api/adr/004-tombstone-records.html" rel="noopener" class="govuk-link">Tombstone records</a></li>

    </ul>
    <li class="subdir__heading">support</li>
    <ul class="subdir__menu">
          <li><a href="/repos/account-api/support/rake_tasks.html" rel="noopener" class="govuk-link">Rake Tasks</a></li>

    </ul>

      </ul>
    </li>
  </ul>

              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled" aria-label="Content">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              
<script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "item": {
        "name": "Home",
        "@id": "http://www.dev.gov.uk/"
      }
    },
    {
      "@type": "ListItem",
      "position": 2,
      "item": {
        "name": "Apps",
        "@id": "http://www.dev.gov.uk/apps.html"
      }
    },
    {
      "@type": "ListItem",
      "position": 3,
      "item": {
        "name": "account-api",
        "@id": "http://www.dev.gov.uk/repos/account-api.html"
      }
    }
  ]
}
</script>

<nav data-module="ga4-link-tracker" aria-label="Breadcrumb" class="gem-c-breadcrumbs govuk-breadcrumbs">
  <ol class="govuk-breadcrumbs__list">
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;1&quot;,&quot;index_total&quot;:&quot;3&quot;}" class="govuk-breadcrumbs__link" href="/">Home</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;2&quot;,&quot;index_total&quot;:&quot;3&quot;}" class="govuk-breadcrumbs__link" href="/apps.html">Apps</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;3&quot;,&quot;index_total&quot;:&quot;3&quot;}" class="govuk-breadcrumbs__link" href="/repos/account-api.html">account-api</a>
        </li>
  </ol>
</nav>
  <div class="govuk-!-font-size-16 govuk-!-margin-top-6">
    <div class="govuk-warning-text">
      <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
      <strong class="govuk-warning-text__text">
        <span class="govuk-warning-text__assistive">Warning</span>
        This document has not been updated for a while now. It may be out of date.
      </strong>
    </div>

  Last updated: <a href="https://github.com/alphagov/account-api/commit/4db254641ddfd5969ca79c8d152300084fd0246b">17 Aug 2021</a>
</div>

  <h1 class="page-title">account-api: 002-progressive-enhancement</h1>

  
<p>We think that there are three sorts of account related functionality
on GOV.UK:</p>
<ol>
<li>
<p><strong>The Skeleton Account:</strong> the core mechanics of signing in,
registering, account management, navigating to services, and so on.</p>
</li>
<li>
<p><strong>Navigation:</strong> some content will adjust based on whether the user
is logged in or not.  For example the global header navigation
needs to give the user the appropriate links to sign in or to sign
out.</p>
</li>
<li>
<p><strong>Personalisation:</strong> some content will adjust based on what we know
about the user.  For example, telling the user that some content is
not relevant to them, or showing an email notifications sign up
button in a different state if the user has already signed up.</p>
</li>
</ol>
<p>Arguably, Navigation is part of the Skeleton Account.  But they have
slightly different implications on implementation (one uses user data,
the other does not), so I'll discuss them separately.</p>
<p>The summary of this ADR is that <strong>we have decided Personalisation will
be done, at least initially, in the frontend, with JavaScript, as a
form of progressive enhancement.</strong></p>
<p>The rest of this ADR explains why.</p>
<h2 id="whats-the-skeleton-account">What's the Skeleton Account?</h2>
<p>This is the core value proposition of the GOV.UK account: joining up
services and providing one place where a user can see their activity
and manage their settings and data.</p>
<p>If we don't have this, we have failed in our mission.</p>
<p>So far the Skeleton Account is implemented across the <a href="https://github.com/alphagov/govuk-account-manager-prototype/">account
manager</a>, running on the PaaS, and <a href="https://github.com/alphagov/frontend">frontend</a>.  We're bringing
<a href="https://github.com/alphagov/email-alert-frontend/">email-alert-frontend</a> into the fold and, later on, the account
manager will go away and those parts of the Skeleton Account will be
replaced by a Digital Identity service.</p>
<p>The <a href="http://www.gov.uk">www.gov.uk</a> parts of the Skeleton Account live under
<code>https://www.gov.uk/account/</code>.</p>
<p><strong>Implications on implementation:</strong></p>
<ul>
<li>
<p>This is critical functionality, so it has to work for all users.</p>
</li>
<li>
<p>This is personalised.  Pages will show users their data, let users
manage that data, show the user's activity, and so on.  So requests
have to come through to our origin servers, which is where the data
lives.</p>
</li>
<li>
<p>This is non-cacheable.  Because it's personalised, at best we can
cache one copy per user.  But we might not even want to do that,
because there's a risk of a user seeing slightly out-of-date data.</p>
</li>
</ul>
<h2 id="whats-navigation">What's Navigation?</h2>
<p>This is likely just going to be the global navigation bar, which we
want to show in one of two states based on whether the user is logged
in or not.  I'm not sure where else we only care that the user is
logged in, and not who they are.</p>
<p>We currently show account navigation:</p>
<ul>
<li>On the Brexit landing page</li>
<li>In the Brexit checker</li>
<li>In the Skeleton Account pages</li>
</ul>
<p>But the way we do this right now is by caching based on user ID.  This
is not good, as it means that a request for a new user is sent to our
origin servers, even though (since there is no user-specific
information here) we could serve a cached copy which had been served
to a different user.</p>
<p><strong>Implications on implementation:</strong></p>
<ul>
<li>
<p>This is also critical functionality, so it has to work for all
users.  We've seen in user research how lost people are without a
"Sign In" link in the header.</p>
</li>
<li>
<p>This is <em>not</em> personalised.  All the logged in users will see the
same navigation.  All the logged out users will see the same
navigation.</p>
</li>
<li>
<p>This is cacheable.  If a page only has navigation, and nothing
personalised, it's perfectly safe to cache two copies of that page:
one for logged in users, one for logged out users.</p>
</li>
</ul>
<h2 id="whats-personalisation">What's Personalisation?</h2>
<p>This is the nice-to-have of the GOV.UK account.  If the Skeleton
Account is the cross-gov part of accounts, this is the GOV.UK-specific
part.  Personalisation features could be things like:</p>
<ul>
<li>
<p>Changing the state of a button to sign up for notifications based on
whether the user has already done so.</p>
</li>
<li>
<p>Displaying a message saying that this content is not relevant to the
user based on what we know about them.</p>
</li>
<li>
<p>Pre-selecting a tab on the Bank Holidays page based on knowing the
user's location.</p>
</li>
</ul>
<p>Unlike the Skeleton Account, Personalisation may end up touching
almost every page on GOV.UK.</p>
<p><strong>Implications on implementation:</strong></p>
<ul>
<li>
<p>This is <em>not</em> critical functionality.  It is an addition to the core
value proposition of the GOV.UK account, but this by itself would
not justify a GOV.UK account, and it wouldn't be a big loss to have
the cross-gov part but not this.</p>
</li>
<li>
<p>Like the Skeleton Account, this is personalised.  Pages are adjusted
based on what we know about the current user.  So requests have to
come through to our origin servers, which is where the data lives.</p>
</li>
<li>
<p>Like the Skeleton Account, this is non-cacheable.  We could cache
per-user, but might not want to because there is a risk of showing
stale data.</p>
</li>
</ul>
<h2 id="decisions">Decisions</h2>
<p>We will use server-side rendering for the Skeleton Account pages and
for the Navigation.  We will treat Personalisation as a progressive
enhancement and do it client-side with JavaScript.</p>
<p>The upside is that we delay needing to change GOV.UK's architecture
for a world where almost nothing is cached.  That will be a difficult
task and take a while.  Iterating things will likely be quicker if
they're done in the frontend.</p>
<p>The downside is that we will have two versions of GOV.UK: one with
personalisation (which JavaScript users see) and one without.  Almost
all users have JavaScript enabled, but we still need to make sure the
non-JavaScript version works, and we will have to deal with a "flash
of unpersonalised content" - where users briefly see the generic page
before a personalised part loads.</p>
<h3 id="improving-caching-for-navigation">Improving caching for Navigation</h3>
<p>To get the nice one-copy-for-all-logged-in-users caching behaviour for
Navigation, we'll need to add a new custom request header:</p>
<p><a href="https://github.com/alphagov/govuk-cdn-config/blob/8fd27e2a555f6fcb3edbd9d326210e53dbc2c66b/vcl_templates/www.vcl.erb#L368-L371">In <code>vcl_recv</code></a>:</p>
<pre lang="vcl"><code>  # RFC 134
  if (req.http.Cookie ~ "__Host-govuk_account_session") {
    set req.http.GOVUK-Account-Session = req.http.Cookie:__Host-govuk_account_session;
    set req.http.GOVUK-Account-Session-Exists = "1";
  }
</code></pre>
<p><a href="https://github.com/alphagov/govuk-cdn-config/blob/8fd27e2a555f6fcb3edbd9d326210e53dbc2c66b/vcl_templates/www.vcl.erb#L523-L537">In <code>vcl_deliver</code></a>:</p>
<pre lang="vcl"><code>  # RFC 134
  if (resp.http.GOVUK-Account-End-Session) {
    add resp.http.Set-Cookie = "__Host-govuk_account_session=; secure; httponly; samesite=lax; path=/; max-age=0";
  } else if (resp.http.GOVUK-Account-Session) {
    add resp.http.Set-Cookie = "__Host-govuk_account_session=" + resp.http.GOVUK-Account-Session + "; secure; httponly; samesite=lax; path=/";
  }

  if (resp.http.Vary ~ "GOVUK-Account-Session") {
    set resp.http.Vary:Cookie = "";
    set resp.http.Cache-Control:private = "";
  } else if (resp.http.Vary ~ "GOVUK-Account-Session-Exists") {
    set resp.http.Vary:Cookie = "";
    set resp.http.Cache-Control:private = "";
  }

  unset resp.http.GOVUK-Account-Session;
  unset resp.http.GOVUK-Account-End-Session;
  unset resp.http.Vary:GOVUK-Account-Session;
  unset resp.http.Vary:GOVUK-Account-Session-Exists;
</code></pre>
<p>Unfortunately, this means we will need navigation-selection logic in
every frontend app, which will be something like:</p>
<pre lang="ruby"><code>  before_action do
    logged_in = request.headers["HTTP_GOVUK_ACCOUNT_SESSION_EXISTS"].present?
    set_slimmer_headers(remove_search: true, show_accounts: logged_in ? "signed-in" : "signed-out")
    response.headers["Vary"] = [response.headers["Vary"], "GOVUK-Account-Session-Exists"].compact.join(", ")
  end
</code></pre>
<p>But this can be added to <a href="https://github.com/alphagov/govuk_personalisation/blob/main/lib/govuk_personalisation/controller_concern.rb">the <code>ControllerConcern</code> in govuk_personalisation</a>.</p>
<h3 id="progressively-enhancing-navigation">Progressively enhancing Navigation</h3>
<p>Even though every user gets the same Navigation HTML we can still
personalise it with progressive enhancement.  For example, say we want
to list a user's most visited pages in the header so they can get to
them quickly.  We'd do this like so:</p>
<ol>
<li>The logged in header just has a link going to a page which lists
their top pages.</li>
<li>JavaScript queries an API to fetch the top pages, and replaces the
link in the header with this list.</li>
</ol>
<p>Then users with JavaScript see their top pages, and users without
JavaScript get a link to go see them instead.</p>
<p>We will have to make sure that the unenhanced version of GOV.UK
(GOV.UK with just the Skeleton Account and Navigation) works.</p>
<h3 id="dealing-with-the-flash-of-unpersonalised-content">Dealing with the Flash of Unpersonalised Content</h3>
<p>This is the main problem with the JavaScript approach.  Imagine if we
display a box at the top of a page telling the user that it's not
relevant to them, and it takes half a second for that box to appear
after the page has loaded: the content will move around and, if the
user has already started scrolling down, they may not see the box.</p>
<p>It's not a great user experience.  But we think the ease of
implementation is worth this cost.</p>
<p>Furthermore, as we demonstrate user value, we can begin to migrate
functionality out of JavaScript and into something like Compute@Edge
or Edge Side Includes.  It's better to be able to iterate on something
quickly and prove its value (even if with a less-than-ideal user
experience) before putting in the hard work to get it up to our usual
standards.</p>

  <script>
    /*
      Manually trigger the styling of the 'current page' in the sidebar,
      as it does not happen automatically because we are still technically
      in single page mode.
    */
    (function () {
        'use strict'
        /*
          Cannot use `$(document).ready` on next line as jQuery has not loaded
          yet. But we can use jQuery in the callback.
        */
        window.addEventListener('load', function () {
            try {
                new GOVUK.Modules.InPageNavigation().start($("html"));
            }
            catch (error) {
                /* Fail without causing other JS in the page to break */
                console.log("Error calling GOVUK's InPageNavigation module", error);
            }
        })
    }());
</script>


            
          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/account-api/blob/main/docs/adr/002-progressive-enhancement.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?body=Problem+with+%27%27+%28https%3A%2F%2Fdocs.publishing.service.gov.uk%2Frepos%2Faccount-api%2Fadr%2F002-progressive-enhancement.html%29&amp;labels=bug&amp;title=Re%3A+%27%27">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <svg focusable="false" role="presentation" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 60" height="30" width="32" fill="currentcolor" class="govuk-footer__crown">
    <g>
      <circle cx="20" cy="17.6" r="3.7"></circle>
      <circle cx="10.2" cy="23.5" r="3.7"></circle>
      <circle cx="3.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <circle cx="43.3" cy="17.6" r="3.7"></circle>
      <circle cx="53.2" cy="23.5" r="3.7"></circle>
      <circle cx="59.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
    </g>
  </svg>
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/accessibility.html">Accessibility</a>
            </li>
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/cookies.html">Cookies</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/govuk_frontend.js" type="module"></script>
    <script src="/javascripts/application.js"></script>
  </body>
</html>
