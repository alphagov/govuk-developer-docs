

<!doctype html>
<html lang="en" class="govuk-template govuk-template--rebranded no-js">
  <head>
    
    

    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>content-data-api: data-warehouse-schema - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/repos/content-data-api/data-warehouse-schema.html">
      <link rel="icon" sizes="48x48" href="/assets/govuk/assets/rebrand/images/favicon.ico">
      <link rel="icon" sizes="any" href="/assets/govuk/assets/rebrand/images/favicon.svg" type="image/svg+xml">
      <link rel="mask-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-mask.svg" color="#0b0c0c">
      <link rel="apple-touch-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-180.png">
      <link rel="manifest" href="/assets/govuk/assets/rebrand/manifest.json">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta name="twitter:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta name="twitter:title" content="content-data-api: data-warehouse-schema - GOV.UK Developer Documentation" />
      <meta name="twitter:url" content="https://docs.publishing.service.gov.uk/repos/content-data-api/data-warehouse-schema.html" />

      <meta property="og:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="content-data-api: data-warehouse-schema" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/repos/content-data-api/data-warehouse-schema.html" />

      <script>
  document.addEventListener('DOMContentLoaded', function () {
    var markup = `<div id="global-cookie-message" data-module="cookie-banner" data-nosnippet="" aria-label="Can we store analytics cookies on your device?" class="gem-c-cookie-banner govuk-clearfix govuk-cookie-banner js-banner-wrapper" role="region" hidden="hidden" title="Can we store analytics cookies on your device?"> <div class="govuk-cookie-banner__message govuk-width-container"> <div class="govuk-grid-row"> <div class="govuk-grid-column-two-thirds"> <h2 class="govuk-cookie-banner__heading govuk-heading-m">Can we store analytics cookies on your device?</h2> <div tabindex="-1" class="govuk-cookie-banner__content gem-c-cookie-banner__confirmation"> <div class="gem-c-cookie-banner__content"><p class='govuk-body'>We’d like to set some cookies to understand how you use this site and remember your settings.</p><p class='govuk-body'>We also use cookies set by other sites to help us deliver content from their services.</p></div> <p class="gem-c-cookie-banner__confirmation-message--accepted govuk-body" hidden data-ga4-cookie-banner data-module="ga4-link-tracker" data-ga4-track-links-only data-ga4-set-indexes data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" >You have accepted additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> <p class="gem-c-cookie-banner__confirmation-message--rejected govuk-body" hidden>You have rejected additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> </div> </div> </div> <div class="js-confirmation-buttons govuk-button-group"> <button class="gem-c-button govuk-button" type="submit" data-accept-cookies="true" data-cookie-types="all">Accept additional cookies</button> <button class="gem-c-button govuk-button" type="submit" data-reject-cookies="true">Reject additional cookies</button> <a class="govuk-link" href="/cookies.html">View cookies</a> </div> <div hidden class="js-hide-button govuk-button-group"> <button class="gem-c-cookie-banner__hide-button govuk-button" data-hide-cookie-banner="true" data-module="ga4-event-tracker" data-ga4-event="{&quot;event_name&quot;:&quot;select_content&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;action&quot;:&quot;closed&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" > Hide cookie message </button> </div> </div> </div>`;
    var banner = document.createElement('div');
    banner.innerHTML = markup;
    document.body.prepend(banner);
  })
</script>


  </head>

  <body class="govuk-template__body">
    <script>document.body.className += ' js-enabled' + ('noModule' in HTMLScriptElement.prototype ? ' govuk-frontend-supported' : '');</script>

    <div class="app-pane">
      
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <svg
          focusable="false"
          role="img"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 324 60"
          height="30"
          width="162"
          fill="currentcolor"
          class="govuk-header__logotype"
          aria-label="GOV.UK">
          <title>GOV.UK</title>
          <g>
            <circle cx="20" cy="17.6" r="3.7"></circle>
            <circle cx="10.2" cy="23.5" r="3.7"></circle>
            <circle cx="3.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <circle cx="43.3" cy="17.6" r="3.7"></circle>
            <circle cx="53.2" cy="23.5" r="3.7"></circle>
            <circle cx="59.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
          </g>
          <circle class="govuk-logo-dot" cx="226" cy="36" r="7.3"/>
          <path d="M93.94 41.25c.4 1.81 1.2 3.21 2.21 4.62 1 1.4 2.21 2.41 3.61 3.21s3.21 1.2 5.22 1.2 3.61-.4 4.82-1c1.4-.6 2.41-1.4 3.21-2.41.8-1 1.4-2.01 1.61-3.01s.4-2.01.4-3.01v.14h-10.86v-7.02h20.07v24.08h-8.03v-5.56c-.6.8-1.38 1.61-2.19 2.41-.8.8-1.81 1.2-2.81 1.81-1 .4-2.21.8-3.41 1.2s-2.41.4-3.81.4a18.56 18.56 0 0 1-14.65-6.63c-1.6-2.01-3.01-4.41-3.81-7.02s-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83a20.45 20.45 0 0 1 19.46-13.65c3.21 0 4.01.2 5.82.8 1.81.4 3.61 1.2 5.02 2.01 1.61.8 2.81 2.01 4.01 3.21s2.21 2.61 2.81 4.21l-7.63 4.41c-.4-1-1-1.81-1.61-2.61-.6-.8-1.4-1.4-2.21-2.01-.8-.6-1.81-1-2.81-1.4-1-.4-2.21-.4-3.61-.4-2.01 0-3.81.4-5.22 1.2-1.4.8-2.61 1.81-3.61 3.21s-1.61 2.81-2.21 4.62c-.4 1.81-.6 3.71-.6 5.42s.8 5.22.8 5.22Zm57.8-27.9c3.21 0 6.22.6 8.63 1.81 2.41 1.2 4.82 2.81 6.62 4.82S170.2 24.39 171 27s1.4 5.62 1.4 8.83-.4 6.02-1.4 8.83-2.41 5.02-4.01 7.02-4.01 3.61-6.62 4.82-5.42 1.81-8.63 1.81-6.22-.6-8.63-1.81-4.82-2.81-6.42-4.82-3.21-4.41-4.01-7.02-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83 2.41-5.02 4.01-7.02 4.01-3.61 6.42-4.82 5.42-1.81 8.63-1.81Zm0 36.73c1.81 0 3.61-.4 5.02-1s2.61-1.81 3.61-3.01 1.81-2.81 2.21-4.41c.4-1.81.8-3.61.8-5.62 0-2.21-.2-4.21-.8-6.02s-1.2-3.21-2.21-4.62c-1-1.2-2.21-2.21-3.61-3.01s-3.21-1-5.02-1-3.61.4-5.02 1c-1.4.8-2.61 1.81-3.61 3.01s-1.81 2.81-2.21 4.62c-.4 1.81-.8 3.61-.8 5.62 0 2.41.2 4.21.8 6.02.4 1.81 1.2 3.21 2.21 4.41s2.21 2.21 3.61 3.01c1.4.8 3.21 1 5.02 1Zm36.32 7.96-12.24-44.15h9.83l8.43 32.77h.4l8.23-32.77h9.83L200.3 58.04h-12.24Zm74.14-7.96c2.18 0 3.51-.6 3.51-.6 1.2-.6 2.01-1 2.81-1.81s1.4-1.81 1.81-2.81a13 13 0 0 0 .8-4.01V13.9h8.63v28.15c0 2.41-.4 4.62-1.4 6.62-.8 2.01-2.21 3.61-3.61 5.02s-3.41 2.41-5.62 3.21-4.62 1.2-7.02 1.2-5.02-.4-7.02-1.2c-2.21-.8-4.01-1.81-5.62-3.21s-2.81-3.01-3.61-5.02-1.4-4.21-1.4-6.62V13.9h8.63v26.95c0 1.61.2 3.01.8 4.01.4 1.2 1.2 2.21 2.01 2.81.8.8 1.81 1.4 2.81 1.81 0 0 1.34.6 3.51.6Zm34.22-36.18v18.92l15.65-18.92h10.82l-15.03 17.32 16.03 26.83h-10.21l-11.44-20.21-5.62 6.22v13.99h-8.83V13.9"/>
        </svg>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <nav class="govuk-header__navigation govuk-header__navigation--end" aria-label="Menu">
        <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" hidden>Menu</button>
        <ul id="navigation" class="govuk-header__navigation-list">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual.html">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/kubernetes/">Kubernetes</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/apps.html" aria-current="page">Apps</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/repos.html">Repos</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/mobile/">Mobile</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1">
              <div class="search" data-module="search" data-path-to-site-root="/">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input
      type="search"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <ul>
    <li>
      <a href="/repos/content-data-api.html" rel="noopener" class="govuk-link">content-data-api</a>
    </li>
    <li>
      <ul>
            <li><a href="/repos/content-data-api/data-warehouse-schema.html" rel="noopener" class="govuk-link">data-warehouse-schema</a></li>
    <li><a href="/repos/content-data-api/data-warehouse-what-and-why.html" rel="noopener" class="govuk-link">data-warehouse-what-and-why</a></li>
    <li><a href="/repos/content-data-api/etl-process.html" rel="noopener" class="govuk-link">Collecting user metrics</a></li>
    <li><a href="/repos/content-data-api/google_analytics_setup.html" rel="noopener" class="govuk-link">Set up Google Analytics credentials in development</a></li>
    <li><a href="/repos/content-data-api/how_to_handle_errors.html" rel="noopener" class="govuk-link">How to proceed with Sentry Errors</a></li>
    <li><a href="/repos/content-data-api/import_production_data.html" rel="noopener" class="govuk-link">Import Production Data</a></li>
    <li><a href="/repos/content-data-api/processing_publishing_api_messages.html" rel="noopener" class="govuk-link">Processing messages from the Publishing API</a></li>
    <li><a href="/repos/content-data-api/requeue_all_content.html" rel="noopener" class="govuk-link">Re-queue all content from the Publishing API</a></li>
    <li class="subdir__heading">arch</li>
    <ul class="subdir__menu">
          <li><a href="/repos/content-data-api/arch/adr-000-document-architectural-decisions.html" rel="noopener" class="govuk-link">ADR 000: Document architectural decisions</a></li>
    <li><a href="/repos/content-data-api/arch/adr-003-use-google-tag-manager.html" rel="noopener" class="govuk-link">ADR 003: Use Google Tag Manager</a></li>
    <li><a href="/repos/content-data-api/arch/adr-005-split-audit-tool-cpm.html" rel="noopener" class="govuk-link">ADR 005: Split Audit Tool and Content Performance Manager</a></li>
    <li><a href="/repos/content-data-api/arch/adr-006-track-metrics-via-time-dimension.html" rel="noopener" class="govuk-link">ADR 006: Track metrics through a time dimension</a></li>
    <li><a href="/repos/content-data-api/arch/adr-007-etl-publishing-api-content-store.html" rel="noopener" class="govuk-link">ADR 007: ETL to populate Content Items' dimension.</a></li>
    <li><a href="/repos/content-data-api/arch/adr-008-focus-on-english-content.html" rel="noopener" class="govuk-link">ADR 008: Focus on english content in the first iterations.</a></li>
    <li><a href="/repos/content-data-api/arch/adr-009-consume-from-publishing-api.html" rel="noopener" class="govuk-link">ADR 009: Consume content items only from the publishing API</a></li>
    <li><a href="/repos/content-data-api/arch/adr-009-track-metrics-by-basepath.html" rel="noopener" class="govuk-link">ADR 009: Track metrics by basepath instead of by Content Item</a></li>
    <li><a href="/repos/content-data-api/arch/adr-010-track-content-items-in-all-languages.html" rel="noopener" class="govuk-link">ADR 011: Track content items in all languages</a></li>
    <li><a href="/repos/content-data-api/arch/adr-011-new-app-for-ui-management.html" rel="noopener" class="govuk-link">ADR 011: Create a new application for UI management</a></li>
    <li><a href="/repos/content-data-api/arch/adr-012-use-sidekiq-for-proessing-rabbitmq-messages.html" rel="noopener" class="govuk-link">ADR 012: Process each RabbitMQ message in a Sidekiq Job</a></li>
    <li><a href="/repos/content-data-api/arch/adr-013-store-json-from-events-that-carry-content-changes.html" rel="noopener" class="govuk-link">Store Content Item JSON that makes the dimensions grow</a></li>
    <li><a href="/repos/content-data-api/arch/adr-014-track-attribute-changes-per-basepath.html" rel="noopener" class="govuk-link">Track attribute changes through time for basepaths</a></li>
    <li><a href="/repos/content-data-api/arch/adr-015-convention-for-data-warehouse-unique-id.html" rel="noopener" class="govuk-link">Use compound id instead of a random UUID</a></li>
    <li><a href="/repos/content-data-api/arch/adr-016-rename-content-performance-manager.html" rel="noopener" class="govuk-link">ADR 016: Rename Content Performance Manager to Content Data API</a></li>

    </ul>

      </ul>
    </li>
  </ul>

              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled" aria-label="Content">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              
<script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "item": {
        "name": "Home",
        "@id": "http://www.dev.gov.uk/"
      }
    },
    {
      "@type": "ListItem",
      "position": 2,
      "item": {
        "name": "Apps",
        "@id": "http://www.dev.gov.uk/apps.html"
      }
    },
    {
      "@type": "ListItem",
      "position": 3,
      "item": {
        "name": "content-data-api",
        "@id": "http://www.dev.gov.uk/repos/content-data-api.html"
      }
    }
  ]
}
</script>

<nav data-module="ga4-link-tracker" aria-label="Breadcrumb" class="gem-c-breadcrumbs govuk-breadcrumbs">
  <ol class="govuk-breadcrumbs__list">
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;1&quot;,&quot;index_total&quot;:&quot;3&quot;}" class="govuk-breadcrumbs__link" href="/">Home</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;2&quot;,&quot;index_total&quot;:&quot;3&quot;}" class="govuk-breadcrumbs__link" href="/apps.html">Apps</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;3&quot;,&quot;index_total&quot;:&quot;3&quot;}" class="govuk-breadcrumbs__link" href="/repos/content-data-api.html">content-data-api</a>
        </li>
  </ol>
</nav>
  <div class="govuk-!-font-size-16 govuk-!-margin-top-6">
    <div class="govuk-warning-text">
      <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
      <strong class="govuk-warning-text__text">
        <span class="govuk-warning-text__assistive">Warning</span>
        This document has not been updated for a while now. It may be out of date.
      </strong>
    </div>

  Last updated: <a href="https://github.com/alphagov/content-data-api/commit/a14b7e95c083bf45ecc098760985f02e023da2ea">18 Mar 2021</a>
</div>

  <h1 class="page-title">content-data-api: data-warehouse-schema</h1>

  <!-- raw HTML omitted -->
<p><strong>Table of Contents</strong></p>
<ul>
<li>
<a href="#data-warehouse-schema">Data warehouse schema</a>
<ul>
<li>
<a href="#erd---schema">ERD - schema</a>
<ul>
<li><a href="#how-to-generate-the-schema">How to generate the schema</a></li>
</ul>
</li>
<li>
<a href="#introduction">Introduction</a>
<ul>
<li><a href="#facts-tables">Facts tables</a></li>
<li><a href="#dimensional-tables">Dimensional tables</a></li>
</ul>
</li>
<li>
<a href="#star-schema-for-govuk">Star Schema for GOV.UK</a>
<ul>
<li>
<a href="#intro">Intro</a>
<ul>
<li><a href="#questions-to-answer-with-the-schema">Questions to answer with the schema</a></li>
<li><a href="#patterns-of-all-questions">Patterns of all questions</a></li>
</ul>
</li>
<li>
<a href="#design-fact-tables">Design: Fact tables</a>
<ul>
<li><a href="#daily-metrics-table-factsmetrics">Daily metrics: table <code>facts_metrics</code></a></li>
<li><a href="#facts-editions-table-factseditions">Facts Editions: table <code>facts_editions</code></a></li>
</ul>
</li>
<li>
<a href="#dimensions">Dimensions</a>
<ul>
<li><a href="#editions-dimension">Editions dimension</a></li>
<li><a href="#dates-dimension">Dates dimension</a></li>
</ul>
</li>
<li>
<a href="#aggregations">Aggregations</a>
<ul>
<li>
<a href="#monthly-aggregations">Monthly aggregations</a>
<ul>
<li><a href="#monthly-metrics-table-monthlymetrics">Monthly metrics: table <code>monthly_metrics</code></a></li>
<li><a href="#month-dimension-table-monthdimensions">Month dimension: table <code>month_dimensions</code></a></li>
<li><a href="#benefits">Benefits</a></li>
<li><a href="#drawbacks">Drawbacks</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->

<p>In order to get a better understanding of the problem that the data warehouse
aims to solve, it is recommended to first read <a href="/repos/content-data-api/data-warehouse-what-and-why.html">what is a data wareouse and why
GOV.UK uses one</a></p>
<h2 id="erd-schema">ERD - schema</h2>
<p>The image below represents the schema for the data warehouse (start schema).
There are not many tables but some of them contains a big number of rows. It is
imporant to understand their associations and the type of data that each table
stores.</p>
<p><img src="https://raw.githubusercontent.com/alphagov/content-data-api/main/docs/images/schema.png" alt="data warehouse Database Schema"></p>
<h3 id="how-to-generate-the-schema">How to generate the schema</h3>
<p>The schema is generated using [Rails ERD][rails-erd] running the following
command:</p>
<pre lang="bash"><code>$ bundle exec erd --filetype=png --connected --title 'Schema' --filename docs/images/schema
</code></pre>
<p><em>Developer note</em>: The schema might not be an exact representation of the latest
version of the schema, but it should be close enough to get an understanding of
it.</p>
<h2 id="introduction">Introduction</h2>
<p>Data warehouses use a different design from standard operational databases
(OLTP). The latter are optimized to maintain strict accuracy of data by updating
real-time information. Data warehouses, by contrast, are designed to give a
long-range view of data over time. They trade off transaction volume and instead
specialize in data aggregation.</p>
<p>The data warehouse for GOV.UK:</p>
<ol>
<li>Stores data collected from other sources (<a href="http://github.com/alphagov/support">Feedex</a>, <a href="http://analytics.google.com">Google
Analytics</a>, ...)</li>
<li>Uses a start schema database design to organise data.</li>
</ol>
<pre><code>The star schema consists of one or more fact tables referencing any number of
dimension tables; it separates data into `facts` and `dimensions`:
</code></pre>
<h3 id="facts-tables">Facts tables</h3>
<p>A fact table is the central table in a star schema of a data warehouse. A fact
table stores quantitative information for analysis and is often denormalized.</p>
<pre><code>Record meassurements or metrics for specific events. They usually consist of
numeric values and foreign keys to dimensional data.
</code></pre>
<p>A fact table consists of two types of columns (foreign keys and meassures).</p>
<p>The <strong>foreign keys</strong> column allows joins with dimension tables, and the
<strong>measures</strong> columns contain the data that is being analyzed.</p>
<p>In the data warehouse facts tables store metrics about content. These metrics are
collected on a daily basis or with each content change.</p>
<h3 id="dimensional-tables">Dimensional tables</h3>
<p>Define facts characteristics, and usually have a relatively small number of
records, compared with the facts tables, but higher number of attributes
(columns) for filtering and grouping.</p>
<pre><code>Categorizes facts and measures to enable users to answer business questions.
</code></pre>
<h2 id="star-schema-for-data-warehouse">Star Schema for Data Warehouse</h2>
<h3 id="intro">Intro</h3>
<p>At a high level, we have the following technical requirements:</p>
<ol>
<li>Store performance metrics on a daily basis for each GOV.UK content item.</li>
<li>Store content quality metrics each time a content item is updated or created.</li>
<li>Store the exact version of the content item that is linked to a metric.</li>
</ol>
<h4 id="questions-to-answer-with-the-schema">Questions to answer with the schema</h4>
<p>The database schema should provide efficient ways to answer the
following questions:</p>
<ol>
<li>List <strong>all the content items</strong> from <strong>HMRC</strong> that had no visits for the
<strong>last 3 months</strong>.</li>
<li>Which <strong>organisations</strong> have the <strong>lowest satisfaction score</strong>?</li>
<li>Which <strong>guides</strong> take the <strong>most time to read</strong>?.</li>
<li>
<strong>What formats</strong> have a <strong>high number of PDFs</strong> attachments?</li>
<li>List <strong>all the editions for a content item</strong> and the <strong>number of unique
visits.</strong>
</li>
<li>What is the <strong>relationship between user satisfaction and reading time</strong>?
<strong>long documents</strong>.</li>
</ol>
<h4 id="patterns-of-all-questions">Patterns of all questions</h4>
<p>All the questions or requests listed abover follow a similar pattern:</p>
<ol>
<li>Filter content items by content characteristics.</li>
<li>Select metrics that are interesting.</li>
<li>Apply a filter to the metrics.</li>
<li>Decide grouping criteria.</li>
<li>Select time range.</li>
</ol>
<h3 id="design-fact-tables">Design: Fact tables</h3>
<p>Based on the patterns listed above, we have decided to use two facts tables: one
to track performance metrics (<code>facts_metrics</code>) and another one to track content
quality metrics (<code>facts_editions</code>). The reason for breaking the metrics in two
tables is that they are updated with different frequency. Performance metrics are updated daily, whereas quality metrics are only updated as new editions are published.</p>
<h4 id="daily-metrics-table-facts_metrics">Daily metrics: table <code>facts_metrics</code>
</h4>
<pre><code>Stores performance metrics for each content item in GOV.UK. It is updated daily.
</code></pre>
<p>These are some of the metrics that we currently store:</p>
<table>
<thead>
<tr>
<th>metric name</th>
<th>source</th>
</tr>
</thead>
<tbody>
<tr>
<td>feedex</td>
<td>Number of comments in Feedex</td>
</tr>
<tr>
<td>pviews</td>
<td>Number of page views</td>
</tr>
<tr>
<td>upviews</td>
<td>Numnber of unique page views</td>
</tr>
<tr>
<td>useful_yes</td>
<td>Number of positive reponses in user survey</td>
</tr>
<tr>
<td>searches</td>
<td>Number of internal searches</td>
</tr>
</tbody>
</table>
<p>For each content item that is live in GOV.UK, on a daily basis, we create a
row in the <code>facts_metrics</code> table containing performance metrics that are
collected from external systems like <a href="http://github.com/alphagov/support">Feedex</a> or <a href="http://analytics.google.com">Google
Analytics</a>.</p>
<h4 id="facts-editions-table-facts_editions">Facts Editions: table <code>facts_editions</code>
</h4>
<pre><code>Stores content metrics for each version of a content item. It is updated each
time a content item is modified or created.
</code></pre>
<table>
<thead>
<tr>
<th>metric name</th>
<th>source</th>
</tr>
</thead>
<tbody>
<tr>
<td>pdf_count</td>
<td>Number of pdf attachments</td>
</tr>
<tr>
<td>word_count</td>
<td>Number of word attachments</td>
</tr>
<tr>
<td>reading_time</td>
<td>Reading time for page content</td>
</tr>
<tr>
<td>words</td>
<td>Number of words</td>
</tr>
</tbody>
</table>
<p>For each update or creation of a content item we have a new entry in the
<code>facts_edition</code> table so we track the exact version of the content item attached
to the metrics.</p>
<h3 id="dimensions">Dimensions</h3>
<p>Dimensions provide contextual information to Facts tables. They are usually
referenced from the facts tables via a foreign key: <code>many-to-one</code> association.</p>
<h4 id="editions-dimension">Editions dimension</h4>
<pre><code>Contains the attributes of the content item and it is updated each time a new
edition is published.
</code></pre>
<p>Each time a content item is updated or edited (via
<a href="http://github.com/alphagov/publishing_api">publishing-api</a>), a new edition is created in the data
warehouse. This way we can track changes to content
within the data warehouse and metrics associated with each edition
the metrics.</p>
<p>Important attributes of the dimension editions table are:</p>
<table>
<thead>
<tr>
<th>metric name</th>
<th>source</th>
</tr>
</thead>
<tbody>
<tr>
<td>base_path</td>
<td>The base path for the edition</td>
</tr>
<tr>
<td>content_identifier</td>
<td>The content id for the edition</td>
</tr>
<tr>
<td>warehouse_item_id</td>
<td>Uniq identifier (<a href="https://github.com/alphagov/content-data-api/blob/main/docs/arch/adr-015-convention-for-data-warehouse-unique-id.md">see ADR</a>)</td>
</tr>
<tr>
<td>title</td>
<td>The title for the edition</td>
</tr>
</tbody>
</table>
<p>It is important to understand the grain of the data warehouse. We are not
storing metrics at a content item level, but at a base_path level (page level).
This is due to the existence of some content items, like guides, that share the
same content id for muliple pages.</p>
<p>Please, read the following ADRs to get additional information.</p>
<ol>
<li><a href="https://github.com/alphagov/content-data-api/blob/main/docs/arch/adr-009-track-metrics-by-basepath.md">Track collected metrics by base_path</a></li>
<li><a href="https://github.com/alphagov/content-data-api/blob/main/docs/arch/adr-014-track-attribute-changes-per-basepath.md">Track attribute changes by base_path</a></li>
<li><a href="https://github.com/alphagov/content-data-api/blob/main/docs/arch/adr-015-convention-for-data-warehouse-unique-id.md">Convention for unique warehoue identifier</a></li>
</ol>
<h4 id="dates-dimension">Dates dimension</h4>
<pre><code>Contains date attributes that are used to add time context to metrics and
editions.
</code></pre>
<p>All metrics and editions needs time to be complete, because:</p>
<ol>
<li>Each metric has a <strong>foreign key to the day</strong> the meassure was collected.</li>
<li>Each edition has a <strong>foreign key to the day</strong> the edition was created.</li>
</ol>
<p>You can also observe that we have other attributes in the dimension (year,
week, month...), these attributes are used to enable grouping and aggregations;
This is a common practices in data warehouses.</p>
<h3 id="aggregations">Aggregations</h3>
<p>g
Aggregations are a common practice in data warehouses. There is no simpler way
to speed up queries than aggregating data.</p>
<p>Usually aggregations are created from fact tables. In our case, we are creating
monthly aggregations from facts metrics table.</p>
<h4 id="monthly-aggregations">Monthly aggregations</h4>
<p>There are two tables involved in montly aggregations:</p>
<h5 id="monthly-metrics-table-monthly_metrics">Monthly metrics: table <code>monthly_metrics</code>
</h5>
<pre><code>Stores the sum of all aggregable metrics in a month. It also stores the
aggregation for the current month.
</code></pre>
<p>On a daily basis, the system will update the aggregations for the current month,
creating a new entry at the beginning of each month.</p>
<h5 id="month-dimension-table-month_dimensions">Month dimension: table <code>month_dimensions</code>
</h5>
<pre><code>Contains all the months to current day. It is updated automatically each month.
</code></pre>
<p>We reference each metric in the aggregations table to the month in which it was
collected (via a foreign key to the monthly dimensions table).</p>
<h5 id="benefits">Benefits</h5>
<p>The improvement in performance is substantial. Let's see the difference in
nunber of rows performing a simple calculation: Total number of unique pageviews
in a year for HMRC:</p>
<ul>
<li>
<strong>With no aggregation</strong>:</li>
</ul>
<pre><code>80,000 editions x 365 days = 29,200,000 rows
</code></pre>
<ul>
<li>
<strong>With no aggregation</strong>:</li>
</ul>
<pre><code>80,000 editions x 12 days = 960,000 rows
</code></pre>
<p>Aggregations result in a 30x decrease in the number of rows needed to be queried. For example,
if the query on the facts table takes 60 seconds, running the same query on the
aggregated table would take around 2 seconds.</p>
<h5 id="drawbacks">Drawbacks</h5>
<p>We should not create aggregations just to improve a query. Aggregations add
complexity to the data warehouse and can be a source for bugs. Before creating
new aggregations we would need to think about:</p>
<ol>
<li>How frequently do we use the Aggregation.</li>
<li>Who is the user of the information? Is longer query latency acceptable for queries that only run occasionally?
runs the report occassionally?</li>
<li>What is the impact on the database when running the query. Is it taking too
many resources?</li>
</ol>

  <script>
    /*
      Manually trigger the styling of the 'current page' in the sidebar,
      as it does not happen automatically because we are still technically
      in single page mode.
    */
    (function () {
        'use strict'
        /*
          Cannot use `$(document).ready` on next line as jQuery has not loaded
          yet. But we can use jQuery in the callback.
        */
        window.addEventListener('load', function () {
            try {
                new GOVUK.Modules.InPageNavigation().start($("html"));
            }
            catch (error) {
                /* Fail without causing other JS in the page to break */
                console.log("Error calling GOVUK's InPageNavigation module", error);
            }
        })
    }());
</script>


            
          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/content-data-api/blob/main/docs/data-warehouse-schema.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?body=Problem+with+%27%27+%28https%3A%2F%2Fdocs.publishing.service.gov.uk%2Frepos%2Fcontent-data-api%2Fdata-warehouse-schema.html%29&amp;labels=bug&amp;title=Re%3A+%27%27">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <svg focusable="false" role="presentation" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 60" height="30" width="32" fill="currentcolor" class="govuk-footer__crown">
    <g>
      <circle cx="20" cy="17.6" r="3.7"></circle>
      <circle cx="10.2" cy="23.5" r="3.7"></circle>
      <circle cx="3.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <circle cx="43.3" cy="17.6" r="3.7"></circle>
      <circle cx="53.2" cy="23.5" r="3.7"></circle>
      <circle cx="59.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
    </g>
  </svg>
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/accessibility.html">Accessibility</a>
            </li>
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/cookies.html">Cookies</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/govuk_frontend.js" type="module"></script>
    <script src="/javascripts/application.js"></script>
  </body>
</html>
