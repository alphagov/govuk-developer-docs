

<!doctype html>
<html lang="en" class="govuk-template govuk-template--rebranded no-js">
  <head>
    
    

    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Application: govuk-knowledge-graph-gcp - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/repos/govuk-knowledge-graph-gcp.html">
      <link rel="icon" sizes="48x48" href="/assets/govuk/assets/rebrand/images/favicon.ico">
      <link rel="icon" sizes="any" href="/assets/govuk/assets/rebrand/images/favicon.svg" type="image/svg+xml">
      <link rel="mask-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-mask.svg" color="#0b0c0c">
      <link rel="apple-touch-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-180.png">
      <link rel="manifest" href="/assets/govuk/assets/rebrand/manifest.json">

      <meta name="description" content="Everything about govuk-knowledge-graph-gcp (GOV.UK content data and cloud infrastructure for the GovSearch app)" />
      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta name="twitter:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta name="twitter:title" content="Application: govuk-knowledge-graph-gcp - GOV.UK Developer Documentation" />
      <meta name="twitter:url" content="https://docs.publishing.service.gov.uk/repos/govuk-knowledge-graph-gcp.html" />

      <meta property="og:description" content="Everything about govuk-knowledge-graph-gcp (GOV.UK content data and cloud infrastructure for the GovSearch app)" />
      <meta property="og:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="Application: govuk-knowledge-graph-gcp" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/repos/govuk-knowledge-graph-gcp.html" />

      <script>
  document.addEventListener('DOMContentLoaded', function () {
    var markup = `<div id="global-cookie-message" data-module="cookie-banner" data-nosnippet="" aria-label="Can we store analytics cookies on your device?" class="gem-c-cookie-banner govuk-clearfix govuk-cookie-banner js-banner-wrapper" role="region" hidden="hidden" title="Can we store analytics cookies on your device?"> <div class="govuk-cookie-banner__message govuk-width-container"> <div class="govuk-grid-row"> <div class="govuk-grid-column-two-thirds"> <h2 class="govuk-cookie-banner__heading govuk-heading-m">Can we store analytics cookies on your device?</h2> <div tabindex="-1" class="govuk-cookie-banner__content gem-c-cookie-banner__confirmation"> <div class="gem-c-cookie-banner__content"><p class='govuk-body'>We’d like to set some cookies to understand how you use this site and remember your settings.</p><p class='govuk-body'>We also use cookies set by other sites to help us deliver content from their services.</p></div> <p class="gem-c-cookie-banner__confirmation-message--accepted govuk-body" hidden data-ga4-cookie-banner data-module="ga4-link-tracker" data-ga4-track-links-only data-ga4-set-indexes data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" >You have accepted additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> <p class="gem-c-cookie-banner__confirmation-message--rejected govuk-body" hidden>You have rejected additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> </div> </div> </div> <div class="js-confirmation-buttons govuk-button-group"> <button class="gem-c-button govuk-button" type="submit" data-accept-cookies="true" data-cookie-types="all">Accept additional cookies</button> <button class="gem-c-button govuk-button" type="submit" data-reject-cookies="true">Reject additional cookies</button> <a class="govuk-link" href="/cookies.html">View cookies</a> </div> <div hidden class="js-hide-button govuk-button-group"> <button class="gem-c-cookie-banner__hide-button govuk-button" data-hide-cookie-banner="true" data-module="ga4-event-tracker" data-ga4-event="{&quot;event_name&quot;:&quot;select_content&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;action&quot;:&quot;closed&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" > Hide cookie message </button> </div> </div> </div>`;
    var banner = document.createElement('div');
    banner.innerHTML = markup;
    document.body.prepend(banner);
  })
</script>


  </head>

  <body class="govuk-template__body">
    <script>document.body.className += ' js-enabled' + ('noModule' in HTMLScriptElement.prototype ? ' govuk-frontend-supported' : '');</script>

    <div class="app-pane">
      
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <svg
          focusable="false"
          role="img"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 324 60"
          height="30"
          width="162"
          fill="currentcolor"
          class="govuk-header__logotype"
          aria-label="GOV.UK">
          <title>GOV.UK</title>
          <g>
            <circle cx="20" cy="17.6" r="3.7"></circle>
            <circle cx="10.2" cy="23.5" r="3.7"></circle>
            <circle cx="3.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <circle cx="43.3" cy="17.6" r="3.7"></circle>
            <circle cx="53.2" cy="23.5" r="3.7"></circle>
            <circle cx="59.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
          </g>
          <circle class="govuk-logo-dot" cx="226" cy="36" r="7.3"/>
          <path d="M93.94 41.25c.4 1.81 1.2 3.21 2.21 4.62 1 1.4 2.21 2.41 3.61 3.21s3.21 1.2 5.22 1.2 3.61-.4 4.82-1c1.4-.6 2.41-1.4 3.21-2.41.8-1 1.4-2.01 1.61-3.01s.4-2.01.4-3.01v.14h-10.86v-7.02h20.07v24.08h-8.03v-5.56c-.6.8-1.38 1.61-2.19 2.41-.8.8-1.81 1.2-2.81 1.81-1 .4-2.21.8-3.41 1.2s-2.41.4-3.81.4a18.56 18.56 0 0 1-14.65-6.63c-1.6-2.01-3.01-4.41-3.81-7.02s-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83a20.45 20.45 0 0 1 19.46-13.65c3.21 0 4.01.2 5.82.8 1.81.4 3.61 1.2 5.02 2.01 1.61.8 2.81 2.01 4.01 3.21s2.21 2.61 2.81 4.21l-7.63 4.41c-.4-1-1-1.81-1.61-2.61-.6-.8-1.4-1.4-2.21-2.01-.8-.6-1.81-1-2.81-1.4-1-.4-2.21-.4-3.61-.4-2.01 0-3.81.4-5.22 1.2-1.4.8-2.61 1.81-3.61 3.21s-1.61 2.81-2.21 4.62c-.4 1.81-.6 3.71-.6 5.42s.8 5.22.8 5.22Zm57.8-27.9c3.21 0 6.22.6 8.63 1.81 2.41 1.2 4.82 2.81 6.62 4.82S170.2 24.39 171 27s1.4 5.62 1.4 8.83-.4 6.02-1.4 8.83-2.41 5.02-4.01 7.02-4.01 3.61-6.62 4.82-5.42 1.81-8.63 1.81-6.22-.6-8.63-1.81-4.82-2.81-6.42-4.82-3.21-4.41-4.01-7.02-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83 2.41-5.02 4.01-7.02 4.01-3.61 6.42-4.82 5.42-1.81 8.63-1.81Zm0 36.73c1.81 0 3.61-.4 5.02-1s2.61-1.81 3.61-3.01 1.81-2.81 2.21-4.41c.4-1.81.8-3.61.8-5.62 0-2.21-.2-4.21-.8-6.02s-1.2-3.21-2.21-4.62c-1-1.2-2.21-2.21-3.61-3.01s-3.21-1-5.02-1-3.61.4-5.02 1c-1.4.8-2.61 1.81-3.61 3.01s-1.81 2.81-2.21 4.62c-.4 1.81-.8 3.61-.8 5.62 0 2.41.2 4.21.8 6.02.4 1.81 1.2 3.21 2.21 4.41s2.21 2.21 3.61 3.01c1.4.8 3.21 1 5.02 1Zm36.32 7.96-12.24-44.15h9.83l8.43 32.77h.4l8.23-32.77h9.83L200.3 58.04h-12.24Zm74.14-7.96c2.18 0 3.51-.6 3.51-.6 1.2-.6 2.01-1 2.81-1.81s1.4-1.81 1.81-2.81a13 13 0 0 0 .8-4.01V13.9h8.63v28.15c0 2.41-.4 4.62-1.4 6.62-.8 2.01-2.21 3.61-3.61 5.02s-3.41 2.41-5.62 3.21-4.62 1.2-7.02 1.2-5.02-.4-7.02-1.2c-2.21-.8-4.01-1.81-5.62-3.21s-2.81-3.01-3.61-5.02-1.4-4.21-1.4-6.62V13.9h8.63v26.95c0 1.61.2 3.01.8 4.01.4 1.2 1.2 2.21 2.01 2.81.8.8 1.81 1.4 2.81 1.81 0 0 1.34.6 3.51.6Zm34.22-36.18v18.92l15.65-18.92h10.82l-15.03 17.32 16.03 26.83h-10.21l-11.44-20.21-5.62 6.22v13.99h-8.83V13.9"/>
        </svg>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <nav class="govuk-header__navigation govuk-header__navigation--end" aria-label="Menu">
        <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" hidden>Menu</button>
        <ul id="navigation" class="govuk-header__navigation-list">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual.html">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/kubernetes/">Kubernetes</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/apps.html" aria-current="page">Apps</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/repos.html">Repos</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/mobile/">Mobile</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1">
              <div class="search" data-module="search" data-path-to-site-root="/">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input
      type="search"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <ul>
    <li>
      <a href="/repos/govuk-knowledge-graph-gcp.html" rel="noopener" class="govuk-link">govuk-knowledge-graph-gcp</a>
    </li>
    <li>
      <ul>
            <li><a href="/repos/govuk-knowledge-graph-gcp/how-to-write-queries.html" rel="noopener" class="govuk-link">How to query the Knowledge Graph</a></li>
    <li><a href="/repos/govuk-knowledge-graph-gcp/technical-debt.html" rel="noopener" class="govuk-link">Technical debt</a></li>
    <li><a href="/repos/govuk-knowledge-graph-gcp/terraform-transitions.html" rel="noopener" class="govuk-link">Terraform state transitions</a></li>
    <li><a href="/repos/govuk-knowledge-graph-gcp/terraform.html" rel="noopener" class="govuk-link">Terraform</a></li>
    <li><a href="/repos/govuk-knowledge-graph-gcp/zendesk-workflow.html" rel="noopener" class="govuk-link">Zendesk workflow</a></li>
    <li class="subdir__heading">arch</li>
    <ul class="subdir__menu">
          <li><a href="/repos/govuk-knowledge-graph-gcp/arch/adr-001-consume-smart-survey-api.html" rel="noopener" class="govuk-link">Decision record: Consume the Smart Survey API</a></li>

    </ul>

      </ul>
    </li>
  </ul>

              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled" aria-label="Content">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              
<script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "item": {
        "name": "Home",
        "@id": "http://www.dev.gov.uk/"
      }
    },
    {
      "@type": "ListItem",
      "position": 2,
      "item": {
        "name": "Apps",
        "@id": "http://www.dev.gov.uk/apps.html"
      }
    }
  ]
}
</script>

<nav data-module="ga4-link-tracker" aria-label="Breadcrumb" class="gem-c-breadcrumbs govuk-breadcrumbs">
  <ol class="govuk-breadcrumbs__list">
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;1&quot;,&quot;index_total&quot;:&quot;2&quot;}" class="govuk-breadcrumbs__link" href="/">Home</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;2&quot;,&quot;index_total&quot;:&quot;2&quot;}" class="govuk-breadcrumbs__link" href="/apps.html">Apps</a>
        </li>
  </ol>
</nav>
  
  <h1 class="page-title">Application: govuk-knowledge-graph-gcp</h1>

  <p>GOV.UK content data and cloud infrastructure for the GovSearch app</p>

<div class="gem-c-summary-list">

      <dl class="govuk-summary-list">
          <div class="govuk-summary-list__row">

            <dt class="govuk-summary-list__key">GitHub</dt>
            <dd class="govuk-summary-list__value"><a href="https://github.com/alphagov/govuk-knowledge-graph-gcp">govuk-knowledge-graph-gcp</a></dd>



</div>          <div class="govuk-summary-list__row">

            <dt class="govuk-summary-list__key">Ownership</dt>
            <dd class="govuk-summary-list__value"><a href="https://gds.slack.com/channels/insights-and-analytics-alerts">#insights-and-analytics-alerts</a></dd>



</div>          <div class="govuk-summary-list__row">

            <dt class="govuk-summary-list__key">Category</dt>
            <dd class="govuk-summary-list__value">Data engineering</dd>



</div>          <div class="govuk-summary-list__row">

            <dt class="govuk-summary-list__key">Links</dt>
            <dd class="govuk-summary-list__value"><ul class="govuk-list">
    <li></li>
    <li><a href="https://sentry.io/govuk/app-govuk-knowledge-graph-gcp" class="govuk-link">Sentry (error tracking)</a></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
</dd>



</div></dl>
    
</div>
<h2 id='readme'>README</h2><p><div class="embedded-readme"></p>

<ul>
<li>GOV.UK content data in BigQuery, for analytical workloads.</li>
<li>Cloud infrastructure for the <a href="https://github.com/alphagov/govuk-knowledge-graph-search">GovSearch</a> app.</li>
</ul>

<h2 id="documentation">Documentation</h2>

<p>Most documentation is in <code>README.md</code> files and <a href="https://github.com/alphagov/govuk-knowledge-graph-gcp/blob/main/docs"><code>docs</code></a> directory in this repository.  There is also <a href="https://gds-data-docs-bkbishsofa-nw.a.run.app/engineering/knowledge-graph-pipeline-v2/#advantages-of-the-new-pipeline">GOV.UK Data Community Technical Documentation</a>.</p>

<h2 id="data-pipeline-overview">Data pipeline overview</h2>

<ol>
<li>A workflow subscribes to notifications from the GOV.UK S3 Mirror that a new database backup of the Publishing API is available.  The workflow creates an instance of a virtual machine.</li>
<li>The virtual machine fetches the database backup file, extracts its data, and uploads that into BigQuery.</li>
<li>Some SQL queries are scheduled to run daily, which call other SQL routines to refresh various tables from the newly uploaded data.</li>
</ol>

<h2 id="access-and-permissions">Access and permissions</h2>

<p>People are granted access by membership of Google Groups.  Other Google Cloud Platform projects are granted access via service accounts.  Access is granted by editing each environment&rsquo;s tfvars file, such as <code>terraform-dev/environment.auto.tfvars</code>.</p>

<h3 id="google-groups">Google Groups</h3>

<ul>
<li>
<a href="https://groups.google.com/a/digital.cabinet-office.gov.uk/g/govgraph-private-data-readers/about">govgraph-private-data-readers</a> has <code>roles/bigquery.dataViewer</code> in relation to each BigQuery dataset except &lsquo;test&rsquo;, and <code>roles/bigquery.jobUser</code> to be able to run queries that are billed to the billing account of the <code>govuk-knowledge-graph*</code> projects.</li>
<li>
<a href="https://groups.google.com/a/digital.cabinet-office.gov.uk/g/govsearch-developers/members">govgraph-developers</a> has the <code>roles/owner</code> role in relation to each <code>govuk-knowledge-graph*</code> project.</li>
</ul>

<h3 id="iam-rolespermissions-required-in-other-projects">IAM roles/Permissions required in other projects</h3>

<h4 id="govuk-s3-mirror">govuk-s3-mirror</h4>

<p>Search for <code>govuk-knowledge-graph</code> in <a href="https://github.com/alphagov/govuk-s3-mirror">https://github.com/alphagov/govuk-s3-mirror</a> to see what permissions are granted there. That project also publishes to Pub/Sub topics in this project.</p>

<h4 id="gds-bq-reporting">gds-bq-reporting</h4>

<p>The service accounts that this project uses to publish logs to the <code>gds-bq-reporting</code> project must be given the <code>roles/logging.bucketWriter</code> role in that project.</p>

<h2 id="tests">Tests</h2>

<p>There are hardly any tests.</p>

<h3 id="sql">SQL</h3>

<p>The most likely cause of an error in GovSearch queries is a change to the data and document schemas in the Publishing API.</p>

<p>It is difficult, in general, to test chains of SQL statements.  DBT is popular for doing so, but adds a considerable abstraction, as well as requiring Python, which is discouraged in GOV.UK.</p>

<p>A <a href="https://console.cloud.google.com/bigquery/scheduled-queries/locations/europe-west2/configs/646d78e5-0000-2cd4-94b2-94eb2c1b665a/runs?project=govuk-knowledge-graph">scheduled query</a> runs every hour, and raises an error if any tables have zero rows or have not been updated in the past 25 hours.  The error is automatically detected in the logs, and an <a href="https://console.cloud.google.com/monitoring/alerting?project=govuk-knowledge-graph">alert</a> is raised, which sends an email to the <a href="https://groups.google.com/a/digital.cabinet-office.gov.uk/g/govsearch-developers/members">govsearch-developers</a> Google Group.  Once the problem has been addressed, close the issue.</p>

<h3 id="ruby">Ruby</h3>

<p>Two of the BigQuery Remote Functions are implemented in Ruby and have unit tests.  They are <a href="https://github.com/alphagov/govuk-knowledge-graph-gcp/blob/main/src/cloud-functions/parse-html">parse-html</a> and <a href="https://github.com/alphagov/govuk-knowledge-graph-gcp/blob/main/docker/html-to-text">html-to-text</a>.  Other BigQuery Remote Functions are somewhat trivial.</p>

<h2 id="maintainers">Maintainers</h2>

<p>This project is maintained by the GOV.UK Insights and Analytics team, which is part of the Government Digital Service. They can be reached on Slack - <a href="https://gds.slack.com/archives/C06E0JUDMUZ">#govuk-insights-and-analytics-team</a>.</p>

<h2 id="common-tasks">Common tasks</h2>

<h3 id="import-data-from-somewhere-new">Import data from somewhere new</h3>

<p>Look at <a href="https://github.com/alphagov/govuk-knowledge-graph-gcp/pull/594">https://github.com/alphagov/govuk-knowledge-graph-gcp/pull/594</a>, which derives data from the Publisher app database and puts it into BigQuery.</p>

<h2 id="troubleshooting">Troubleshooting</h2>

<h3 id="outdated-or-empty-bigquery-tables">Outdated or empty BigQuery tables</h3>

<p>If GovSearch gives unexpected results, then the tables in BigQuery might not have been updated correctly.  Usually that means a table either hasn&rsquo;t been updated at all within the last 24 hours, or it has been updated and is now empty.  You can quickly check every table by querying a view called <code>test.tables-metadata</code> by writing a query like <code>SELECT * FROM test.tables-metadata;</code>. The table is checked automatically every hour, and if it finds old or empty tables then an &lsquo;incident&rsquo; is created, and an email is sent to <a href="mailto:govgraph-developers@digital.cabinet-office.gov.uk">govgraph-developers@digital.cabinet-office.gov.uk</a>.</p>

<h3 id="source-data-glitch">Source data glitch</h3>

<p>Check that the database backup files in the <a href="https://github.com/alphagov/govuk-s3-mirror">govuk-s3-mirror</a> are the expected size (many gigabytes) by looking in the <a href="https://console.cloud.google.com/storage/browser/govuk-s3-mirror_govuk-database-backups?project=govuk-s3-mirror">bucket</a>.</p>

<p>Check that the Publishing API hasn&rsquo;t changed its schemas.</p>

<h2 id="other-representations-of-gov-uk-content">Other representations of GOV.UK content</h2>

<p>There are several different representations of GOV.UK content, including:</p>

<ul>
<li>Publishing API</li>
<li>Content Store</li>
<li>Search API</li>
<li>CDN cache (content delivery network)</li>
<li>Mirror (HTML pages crawled nightly)</li>
<li>National Archives (snapshots of content over time)</li>
</ul>

<p>None of these representations met a need for advanced searching and filtering for content designers, or a need for low-level structured data for developing data science applications.  Hence the Knowledge Graph was developed.</p>

<h2 id="technical-debt">Technical debt</h2>

<p>See <a href="/repos/govuk-knowledge-graph-gcp/technical-debt.html">Technical debt</a>.</p>

<h2 id="contributing">Contributing</h2>

<p>You are welcome to:</p>

<ul>
<li>ask a question or suggest a change by contacting the <a href="#maintainers">maintainers</a>.</li>
<li>submit a pull request.</li>
</ul>

<h2 id="deployment">Deployment</h2>

<p>This is not yet an exhaustive set of instructions as the deployment process is likely to change very soon at the time of writing. For now its main purpose to is to capture some of the &ldquo;gotchas&rdquo; you may experience during deployments which I have not found documented elsewhere.</p>

<h3 id="github-actions-environments">GitHub Actions Environments</h3>

<p>There are three <a href="https://github.com/alphagov/govuk-knowledge-graph-gcp/settings/environments">GitHub Actions Environments</a> which correspond to, and contain configuration for, three separate GCP projects:
development -&gt; govuk-knowledge-graph-dev
staging -&gt; govuk-knowledge-graph-staging
production -&gt; govuk-knowledge-graph</p>

<p>Any workflow targeting to production environment requires approval.</p>

<h3 id="docker">Docker</h3>

<p>Any changes to code in directories under the <code>docker</code> folder are deployed by GitHub Actions CI. A few key things to be aware of:</p>

<ul>
<li>Each folder corresponds to an image</li>
<li>The name of the folder will be the name of the image</li>
<li>The deployment pipeline assumes the image is to be deployed as a Cloud Run function. If that is not the case (e.g. the image is pulled at runtime by a VM) then you will have to exclude the image in the &lsquo;Cloud Run deploy&rsquo; step explicitly in the build-push-deploy.yml workflow.</li>
</ul>

<h3 id="terraform">Terraform</h3>

<h4 id="google_compute_instance_template">google_compute_instance_template</h4>

<p>Various GCE templates are defined for the VMs (<code>resource google_compute_instance_template</code>).
Google periodically updates the base images upstream and so sometimes a <code>terraform plan/apply</code> may throw up a number of replacement changes to these resources. This is normal and the plan may be applied. However, it is worth monitoring this in dev just to be sure that no low-level binaries in the image cause breaking changes to the ingestion.</p>

<h4 id="google_cloud_run_service-govgraphsearch">google_cloud_run_service.govgraphsearch</h4>

<p>The current deployment process configures most of the Cloud Run services in terraform. However, the deployment of new GovSearch revisions uses the <code>gcloud</code> cli in the CI. This can cause drift in some of the <code>run.googleapis.com/client-*</code> annotations and an apparent update to the image. The image will not be updated, just the tag used to pull it. These updates can be safely applied. This will create a new revision but you can verify that the image hash has not changed between revisions by checking the <code>spec.containers.image</code> property in the revision via the Cloud Run UI.</p>

<h2 id="licence">Licence</h2>

<p>Unless stated otherwise, the codebase is released under <a href="https://github.com/alphagov/govuk-knowledge-graph-gcp/blob/main/LICENCE">the MIT License</a>. This covers both the codebase and any sample code in the documentation.</p>

<p>The documentation is <a href="http://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/">© Crown copyright</a> and available under the terms of the <a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/">Open Government 3.0</a> licence.</p>
<p></div></p>

  <script>
    /*
      Manually trigger the styling of the 'current page' in the sidebar,
      as it does not happen automatically because we are still technically
      in single page mode.
    */
    (function () {
        'use strict'
        /*
          Cannot use `$(document).ready` on next line as jQuery has not loaded
          yet. But we can use jQuery in the callback.
        */
        window.addEventListener('load', function () {
            try {
                new GOVUK.Modules.InPageNavigation().start($("html"));
            }
            catch (error) {
                /* Fail without causing other JS in the page to break */
                console.log("Error calling GOVUK's InPageNavigation module", error);
            }
        })
    }());
</script>


            
          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/govuk-developer-docs/blob/main/data/repos.yml">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?body=Problem+with+%27%27+%28https%3A%2F%2Fdocs.publishing.service.gov.uk%2Frepos%2Fgovuk-knowledge-graph-gcp.html%29&amp;labels=bug&amp;title=Re%3A+%27%27">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <svg focusable="false" role="presentation" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 60" height="30" width="32" fill="currentcolor" class="govuk-footer__crown">
    <g>
      <circle cx="20" cy="17.6" r="3.7"></circle>
      <circle cx="10.2" cy="23.5" r="3.7"></circle>
      <circle cx="3.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <circle cx="43.3" cy="17.6" r="3.7"></circle>
      <circle cx="53.2" cy="23.5" r="3.7"></circle>
      <circle cx="59.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
    </g>
  </svg>
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/accessibility.html">Accessibility</a>
            </li>
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/cookies.html">Cookies</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/govuk_frontend.js" type="module"></script>
    <script src="/javascripts/application.js"></script>
  </body>
</html>
