

<!doctype html>
<html lang="en" class="govuk-template govuk-template--rebranded no-js">
  <head>
    

    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>Repository: govuk-graphql - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/repos/govuk-graphql.html">
      <link rel="icon" sizes="48x48" href="/assets/govuk/assets/rebrand/images/favicon.ico">
      <link rel="icon" sizes="any" href="/assets/govuk/assets/rebrand/images/favicon.svg" type="image/svg+xml">
      <link rel="mask-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-mask.svg" color="#0b0c0c">
      <link rel="apple-touch-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-180.png">
      <link rel="manifest" href="/assets/govuk/assets/rebrand/manifest.json">

      <meta name="description" content="Everything about govuk-graphql (Experimental high-performance GraphQL API for GOV.UK)" />
      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta name="twitter:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta name="twitter:title" content="Repository: govuk-graphql - GOV.UK Developer Documentation" />
      <meta name="twitter:url" content="https://docs.publishing.service.gov.uk/repos/govuk-graphql.html" />

      <meta property="og:description" content="Everything about govuk-graphql (Experimental high-performance GraphQL API for GOV.UK)" />
      <meta property="og:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="Repository: govuk-graphql" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/repos/govuk-graphql.html" />

      <script>
  document.addEventListener('DOMContentLoaded', function () {
    var markup = `<div id="global-cookie-message" data-module="cookie-banner" data-nosnippet="" aria-label="Can we store analytics cookies on your device?" class="gem-c-cookie-banner govuk-clearfix govuk-cookie-banner js-banner-wrapper" role="region" hidden="hidden" title="Can we store analytics cookies on your device?"> <div class="govuk-cookie-banner__message govuk-width-container"> <div class="govuk-grid-row"> <div class="govuk-grid-column-two-thirds"> <h2 class="govuk-cookie-banner__heading govuk-heading-m">Can we store analytics cookies on your device?</h2> <div tabindex="-1" class="govuk-cookie-banner__content gem-c-cookie-banner__confirmation"> <div class="gem-c-cookie-banner__content"><p class='govuk-body'>Weâ€™d like to set some cookies to understand how you use this site and remember your settings.</p><p class='govuk-body'>We also use cookies set by other sites to help us deliver content from their services.</p></div> <p class="gem-c-cookie-banner__confirmation-message--accepted govuk-body" hidden data-ga4-cookie-banner data-module="ga4-link-tracker" data-ga4-track-links-only data-ga4-set-indexes data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" >You have accepted additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> <p class="gem-c-cookie-banner__confirmation-message--rejected govuk-body" hidden>You have rejected additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> </div> </div> </div> <div class="js-confirmation-buttons govuk-button-group"> <button class="gem-c-button govuk-button" type="submit" data-accept-cookies="true" data-cookie-types="all">Accept additional cookies</button> <button class="gem-c-button govuk-button" type="submit" data-reject-cookies="true">Reject additional cookies</button> <a class="govuk-link" href="/cookies.html">View cookies</a> </div> <div hidden class="js-hide-button govuk-button-group"> <button class="gem-c-cookie-banner__hide-button govuk-button" data-hide-cookie-banner="true" data-module="ga4-event-tracker" data-ga4-event="{&quot;event_name&quot;:&quot;select_content&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;action&quot;:&quot;closed&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" > Hide cookie message </button> </div> </div> </div>`;
    var banner = document.createElement('div');
    banner.innerHTML = markup;
    document.body.prepend(banner);
  })
</script>


  </head>

  <body class="govuk-template__body">
    <script>document.body.className += ' js-enabled' + ('noModule' in HTMLScriptElement.prototype ? ' govuk-frontend-supported' : '');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <svg
          focusable="false"
          role="img"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 324 60"
          height="30"
          width="162"
          fill="currentcolor"
          class="govuk-header__logotype"
          aria-label="GOV.UK">
          <title>GOV.UK</title>
          <g>
            <circle cx="20" cy="17.6" r="3.7"></circle>
            <circle cx="10.2" cy="23.5" r="3.7"></circle>
            <circle cx="3.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <circle cx="43.3" cy="17.6" r="3.7"></circle>
            <circle cx="53.2" cy="23.5" r="3.7"></circle>
            <circle cx="59.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
          </g>
          <circle class="govuk-logo-dot" cx="226" cy="36" r="7.3"/>
          <path d="M93.94 41.25c.4 1.81 1.2 3.21 2.21 4.62 1 1.4 2.21 2.41 3.61 3.21s3.21 1.2 5.22 1.2 3.61-.4 4.82-1c1.4-.6 2.41-1.4 3.21-2.41.8-1 1.4-2.01 1.61-3.01s.4-2.01.4-3.01v.14h-10.86v-7.02h20.07v24.08h-8.03v-5.56c-.6.8-1.38 1.61-2.19 2.41-.8.8-1.81 1.2-2.81 1.81-1 .4-2.21.8-3.41 1.2s-2.41.4-3.81.4a18.56 18.56 0 0 1-14.65-6.63c-1.6-2.01-3.01-4.41-3.81-7.02s-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83a20.45 20.45 0 0 1 19.46-13.65c3.21 0 4.01.2 5.82.8 1.81.4 3.61 1.2 5.02 2.01 1.61.8 2.81 2.01 4.01 3.21s2.21 2.61 2.81 4.21l-7.63 4.41c-.4-1-1-1.81-1.61-2.61-.6-.8-1.4-1.4-2.21-2.01-.8-.6-1.81-1-2.81-1.4-1-.4-2.21-.4-3.61-.4-2.01 0-3.81.4-5.22 1.2-1.4.8-2.61 1.81-3.61 3.21s-1.61 2.81-2.21 4.62c-.4 1.81-.6 3.71-.6 5.42s.8 5.22.8 5.22Zm57.8-27.9c3.21 0 6.22.6 8.63 1.81 2.41 1.2 4.82 2.81 6.62 4.82S170.2 24.39 171 27s1.4 5.62 1.4 8.83-.4 6.02-1.4 8.83-2.41 5.02-4.01 7.02-4.01 3.61-6.62 4.82-5.42 1.81-8.63 1.81-6.22-.6-8.63-1.81-4.82-2.81-6.42-4.82-3.21-4.41-4.01-7.02-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83 2.41-5.02 4.01-7.02 4.01-3.61 6.42-4.82 5.42-1.81 8.63-1.81Zm0 36.73c1.81 0 3.61-.4 5.02-1s2.61-1.81 3.61-3.01 1.81-2.81 2.21-4.41c.4-1.81.8-3.61.8-5.62 0-2.21-.2-4.21-.8-6.02s-1.2-3.21-2.21-4.62c-1-1.2-2.21-2.21-3.61-3.01s-3.21-1-5.02-1-3.61.4-5.02 1c-1.4.8-2.61 1.81-3.61 3.01s-1.81 2.81-2.21 4.62c-.4 1.81-.8 3.61-.8 5.62 0 2.41.2 4.21.8 6.02.4 1.81 1.2 3.21 2.21 4.41s2.21 2.21 3.61 3.01c1.4.8 3.21 1 5.02 1Zm36.32 7.96-12.24-44.15h9.83l8.43 32.77h.4l8.23-32.77h9.83L200.3 58.04h-12.24Zm74.14-7.96c2.18 0 3.51-.6 3.51-.6 1.2-.6 2.01-1 2.81-1.81s1.4-1.81 1.81-2.81a13 13 0 0 0 .8-4.01V13.9h8.63v28.15c0 2.41-.4 4.62-1.4 6.62-.8 2.01-2.21 3.61-3.61 5.02s-3.41 2.41-5.62 3.21-4.62 1.2-7.02 1.2-5.02-.4-7.02-1.2c-2.21-.8-4.01-1.81-5.62-3.21s-2.81-3.01-3.61-5.02-1.4-4.21-1.4-6.62V13.9h8.63v26.95c0 1.61.2 3.01.8 4.01.4 1.2 1.2 2.21 2.01 2.81.8.8 1.81 1.4 2.81 1.81 0 0 1.34.6 3.51.6Zm34.22-36.18v18.92l15.65-18.92h10.82l-15.03 17.32 16.03 26.83h-10.21l-11.44-20.21-5.62 6.22v13.99h-8.83V13.9"/>
        </svg>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <nav class="govuk-header__navigation govuk-header__navigation--end" aria-label="Menu">
        <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" hidden>Menu</button>
        <ul id="navigation" class="govuk-header__navigation-list">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual.html">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/kubernetes/">Kubernetes</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/apps.html" aria-current="page">Apps</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/repos.html">Repos</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/mobile/">Mobile</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1">
              <div class="search" data-module="search" data-path-to-site-root="/">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input
      type="search"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <ul>
    <li>
      <a href="/repos/govuk-graphql.html" rel="noopener" class="govuk-link">govuk-graphql</a>
    </li>
    <li>
      <ul>
        
      </ul>
    </li>
  </ul>

              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled" aria-label="Content">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              
<script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "item": {
        "name": "Home",
        "@id": "http://www.dev.gov.uk/"
      }
    },
    {
      "@type": "ListItem",
      "position": 2,
      "item": {
        "name": "Repos",
        "@id": "http://www.dev.gov.uk/repos.html"
      }
    }
  ]
}
</script>

<nav data-module="ga4-link-tracker" aria-label="Breadcrumb" class="gem-c-breadcrumbs govuk-breadcrumbs">
  <ol class="govuk-breadcrumbs__list">
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;1&quot;,&quot;index_total&quot;:&quot;2&quot;}" class="govuk-breadcrumbs__link" href="/">Home</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;2&quot;,&quot;index_total&quot;:&quot;2&quot;}" class="govuk-breadcrumbs__link" href="/repos.html">Repos</a>
        </li>
  </ol>
</nav>
  
  <h1 class="page-title">Repository: govuk-graphql</h1>

  <p>Experimental high-performance GraphQL API for GOV.UK</p>

<div class="gem-c-summary-list">

      <dl class="govuk-summary-list">
          <div class="govuk-summary-list__row">

            <dt class="govuk-summary-list__key">GitHub</dt>
            <dd class="govuk-summary-list__value"><a href="https://github.com/alphagov/govuk-graphql">govuk-graphql</a></dd>



</div>          <div class="govuk-summary-list__row">

            <dt class="govuk-summary-list__key">Ownership</dt>
            <dd class="govuk-summary-list__value"><strong><a href="https://gds.slack.com/channels/govuk-publishing-platform">#govuk-publishing-platform</a></strong> owns the repo. <strong><a href="https://gds.slack.com/channels/UAEH5J62J">UAEH5J62J</a></strong> receives automated alerts for this repo.</dd>



</div>          <div class="govuk-summary-list__row">

            <dt class="govuk-summary-list__key">Category</dt>
            <dd class="govuk-summary-list__value">Publishing apps</dd>



</div>          <div class="govuk-summary-list__row">

            <dt class="govuk-summary-list__key">Links</dt>
            <dd class="govuk-summary-list__value"><ul class="govuk-list">
    <li><a href="https://govuk-graphql.publishing.service.gov.uk" class="govuk-link">govuk-graphql.publishing.service.gov.uk</a></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
    <li></li>
</dd>



</div></dl>
    <div class="gem-c-summary__block"></div>
</div>
<h2 id='readme'>README</h2><p><div class="embedded-readme"></p>
<p><hr>
<p><strong>EXPERIMENTAL - DO NOT USE IN PRODUCTION</strong></p>
<p><strong>Ask Richard Towers if you want more details about this repository</strong></p>
<hr>
<p>TODO list</p>
<ul>
<li>[x] Implement available_translations</li>
<li>[x] Implement change history</li>
<li>[x] Implement a content-store shim</li>
<li>[x] Implement a compare-with-content-store endpoint using hashdiff</li>
<li>[x] Support non-english locales in content-store-shim</li>
<li>[x] Implement embedded editions</li>
<li>[x] Come up with a nicer way to handle taxons and parents</li>
<li>[ ] Test against a realistic subset of pages</li>
<li>[ ] Refactor to use database views to simplify recursive CTE</li>
<li>[ ] Refactor so the code is vaguely understandable and maintainable</li>
</ul>
<hr>
<p>This is a proof of concept <a href="https://graphql.org/">GraphQL</a> API for GOV.UK.</p>
<p>It uses <a href="https://github.com/alphagov/publishing-api">Publishing API</a>&rsquo;s database to efficiently serve the content needed to render pages on GOV.UK.</p>
<p>The goal of this implementation is to be as fast as possible, at all costs. This means that the
code uses some unfamiliar technology, and is at times harder to understand than other implementations,
but it is also (much) faster.</p>
<p>This allows us to set a lower bound on what&rsquo;s possible in terms of performance, so that we can make
an informed decision on the trade off between code readability and performance.</p>
<h2 id="technologies">Technologies</h2>
<p>Like other proof of concepts, we use <a href="https://graphql-ruby.org/">graphql-ruby</a> as the main library to implement the GraphQL API.</p>
<p>We use the <a href="https://sequel.jeremyevans.net/">Sequel</a> ORM instead of ActiveRecord, because the heart of this implementation is a complex SQL
query which is difficult to construct using ActiveRecord.</p>
<p>Rather than requesting one edition at a time from the database, or batching requests up using a dataloader,
this implementation:</p>
<ul>
<li>walks the graphql request using lookahead</li>
<li>works out which link type paths are needed to resolve the request</li>
<li>uses a single SQL query to fetch all the editions needed to resolve the request</li>
<li>reconstructs the tree of editions requested in the graphql query from the database results</li>
</ul>
<p>The resulting SQL query is complex, but initial testing suggests that its performance is very good.</p>
&lt;!&ndash; raw HTML omitted &ndash;&gt;
<pre lang="sql"><code>WITH RECURSIVE
&quot;link_type_paths&quot; AS (
  SELECT trim_array(path, 1) as path, path[array_upper(path, 1)] as next
  FROM json_to_recordset($1) AS paths(path text[])
),
&quot;reverse_link_type_paths&quot; AS (
  SELECT trim_array(path, 1) as path, path[array_upper(path, 1)] as next
  FROM json_to_recordset($2) AS paths(path text[])
),
&quot;edition_links&quot; AS (
  SELECT &#39;root&#39; AS &quot;type&quot;, &#39;{}&#39;::text[] AS &quot;path&quot;, ARRAY[&quot;editions&quot;.&quot;id&quot;]::int[] AS &quot;id_path&quot;, &quot;documents&quot;.&quot;content_id&quot; AS &quot;content_id&quot;, &quot;editions&quot;.&quot;id&quot; AS &quot;edition_id&quot;, &quot;editions&quot;.*
  FROM &quot;editions&quot;
  INNER JOIN &quot;documents&quot; ON (&quot;documents&quot;.&quot;id&quot; = &quot;editions&quot;.&quot;document_id&quot;)
  WHERE ((&quot;state&quot; = &#39;published&#39;) AND (&quot;locale&quot; = &#39;en&#39;) AND (&quot;base_path&quot; = $3)
)
UNION ALL (
    WITH &quot;edition_links&quot; AS (SELECT * FROM &quot;edition_links&quot;)
    SELECT &#39;forward edition&#39; AS &quot;type&quot;, (&quot;edition_links&quot;.&quot;path&quot; || &quot;link_type&quot;) AS &quot;path&quot;, (&quot;edition_links&quot;.&quot;id_path&quot; || &quot;editions&quot;.&quot;id&quot;) AS &quot;id_path&quot;, &quot;documents&quot;.&quot;content_id&quot; AS &quot;content_id&quot;, &quot;editions&quot;.&quot;id&quot; AS &quot;edition_id&quot;, &quot;editions&quot;.*
    FROM &quot;edition_links&quot;
    INNER JOIN &quot;link_type_paths&quot; ON (&quot;link_type_paths&quot;.&quot;path&quot; = &quot;edition_links&quot;.&quot;path&quot;)
    INNER JOIN &quot;links&quot; ON ((&quot;links&quot;.&quot;edition_id&quot; = &quot;edition_links&quot;.&quot;edition_id&quot;) AND (&quot;links&quot;.&quot;link_type&quot; = &quot;link_type_paths&quot;.&quot;next&quot;))
    INNER JOIN &quot;documents&quot; ON ((&quot;documents&quot;.&quot;content_id&quot; = &quot;links&quot;.&quot;target_content_id&quot;) AND (&quot;documents&quot;.&quot;locale&quot; = &#39;en&#39;))
    INNER JOIN &quot;editions&quot; ON ((&quot;editions&quot;.&quot;document_id&quot; = &quot;documents&quot;.&quot;id&quot;) AND (&quot;editions&quot;.&quot;state&quot; = &#39;published&#39;)
  )
  UNION ALL (
    SELECT &#39;reverse edition&#39; AS &quot;type&quot;, (&quot;edition_links&quot;.&quot;path&quot; || &quot;link_type&quot;) AS &quot;path&quot;, (&quot;edition_links&quot;.&quot;id_path&quot; || &quot;editions&quot;.&quot;id&quot;) AS &quot;id_path&quot;, &quot;documents&quot;.&quot;content_id&quot; AS &quot;content_id&quot;, &quot;editions&quot;.&quot;id&quot; AS &quot;edition_id&quot;, &quot;editions&quot;.*
    FROM &quot;edition_links&quot;
    INNER JOIN &quot;reverse_link_type_paths&quot; ON (&quot;reverse_link_type_paths&quot;.&quot;path&quot; = &quot;edition_links&quot;.&quot;path&quot;)
    INNER JOIN &quot;links&quot; ON ((&quot;links&quot;.&quot;target_content_id&quot; = &quot;edition_links&quot;.&quot;content_id&quot;) AND (&quot;links&quot;.&quot;link_type&quot; = &quot;reverse_link_type_paths&quot;.&quot;next&quot;))
    INNER JOIN &quot;editions&quot; ON ((&quot;editions&quot;.&quot;id&quot; = &quot;links&quot;.&quot;edition_id&quot;) AND (&quot;editions&quot;.&quot;state&quot; = &#39;published&#39;))
    INNER JOIN &quot;documents&quot; ON ((&quot;documents&quot;.&quot;id&quot; = &quot;editions&quot;.&quot;document_id&quot;) AND (&quot;documents&quot;.&quot;locale&quot; = &#39;en&#39;))
  )
  UNION ALL (
    SELECT &#39;forward link set&#39; AS &quot;type&quot;, (&quot;edition_links&quot;.&quot;path&quot; || &quot;link_type&quot;) AS &quot;path&quot;, (&quot;edition_links&quot;.&quot;id_path&quot; || &quot;editions&quot;.&quot;id&quot;) AS &quot;id_path&quot;, &quot;documents&quot;.&quot;content_id&quot; AS &quot;content_id&quot;, &quot;editions&quot;.&quot;id&quot; AS &quot;edition_id&quot;, &quot;editions&quot;.*
    FROM &quot;edition_links&quot;
    INNER JOIN &quot;link_type_paths&quot; ON (&quot;link_type_paths&quot;.&quot;path&quot; = &quot;edition_links&quot;.&quot;path&quot;)
    INNER JOIN &quot;link_sets&quot; ON (&quot;link_sets&quot;.&quot;content_id&quot; = &quot;edition_links&quot;.&quot;content_id&quot;)
    INNER JOIN &quot;links&quot; ON ((&quot;links&quot;.&quot;link_set_id&quot; = &quot;link_sets&quot;.&quot;id&quot;) AND (&quot;links&quot;.&quot;link_type&quot; = &quot;link_type_paths&quot;.&quot;next&quot;))
    INNER JOIN &quot;documents&quot; ON ((&quot;documents&quot;.&quot;content_id&quot; = &quot;links&quot;.&quot;target_content_id&quot;) AND (&quot;documents&quot;.&quot;locale&quot; = &#39;en&#39;))
    INNER JOIN &quot;editions&quot; ON ((&quot;editions&quot;.&quot;document_id&quot; = &quot;documents&quot;.&quot;id&quot;) AND (&quot;editions&quot;.&quot;state&quot; = &#39;published&#39;))
  )
  UNION ALL (
    SELECT &#39;reverse link set&#39; AS &quot;type&quot;, (&quot;edition_links&quot;.&quot;path&quot; || &quot;link_type&quot;) AS &quot;path&quot;, (&quot;edition_links&quot;.&quot;id_path&quot; || &quot;editions&quot;.&quot;id&quot;) AS &quot;id_path&quot;, &quot;documents&quot;.&quot;content_id&quot; AS &quot;content_id&quot;, &quot;editions&quot;.&quot;id&quot; AS &quot;edition_id&quot;, &quot;editions&quot;.*
    FROM &quot;edition_links&quot;
    INNER JOIN &quot;reverse_link_type_paths&quot; ON (&quot;reverse_link_type_paths&quot;.&quot;path&quot; = &quot;edition_links&quot;.&quot;path&quot;)
    INNER JOIN &quot;links&quot; ON ((&quot;links&quot;.&quot;target_content_id&quot; = &quot;edition_links&quot;.&quot;content_id&quot;) AND (&quot;links&quot;.&quot;link_type&quot; = &quot;reverse_link_type_paths&quot;.&quot;next&quot;))
    INNER JOIN &quot;link_sets&quot; ON (&quot;link_sets&quot;.&quot;id&quot; = &quot;links&quot;.&quot;link_set_id&quot;)
    INNER JOIN &quot;documents&quot; ON ((&quot;documents&quot;.&quot;content_id&quot; = &quot;link_sets&quot;.&quot;content_id&quot;) AND (&quot;documents&quot;.&quot;locale&quot; = &#39;en&#39;))
    INNER JOIN &quot;editions&quot; ON ((&quot;editions&quot;.&quot;document_id&quot; = &quot;documents&quot;.&quot;id&quot;) AND (&quot;editions&quot;.&quot;state&quot; = &#39;published&#39;)))
  )
)
SELECT * FROM &quot;edition_links&quot;
</code></pre>
&lt;!&ndash; raw HTML omitted &ndash;&gt;
<h2 id="approach">Approach</h2>
<p>This implementation takes a slightly different approach to the GraphQL schema.</p>
<p>The goal is still to be able to produce responses which are compatible with content-store. However,
the schema is designed to be a bit more flexible, allowing queries for arbitrary link types in both forward and reverse
directions.</p>
<p>Specifically, rather than having an explicit field for <code>level_one_taxons</code>, and the implementation knowing that this
is actually a reverse link of type <code>root_taxon</code>, the schema has a <code>links_of_type</code> field which has arguments to specify
the link type and direction. We can use graphql aliases to make the query look like the content-store response.</p>
<pre lang="graphql"><code># Instead of:
level_one_taxons {
  base_path
  content_id
  details
  document_type
  ...
}</p>
<h1 id='we-have'>We have:</h1><p>level_one_taxons: links_of_type(type: root_taxon, reverse: true) {
  base_path
  content_id
  details
  document_type
  ...
}
</code></pre>
<p>A more complete query (for the GOV.UK homepage) might look like this:</p>
<pre lang="graphql"><code>query homepage {
  edition(base_path: &quot;/&quot;) {
    analytics_identifier
    base_path
    content_id
    description
    details
    document_type
    first_published_at</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>links {
  level_one_taxons: links_of_type(type: root_taxon, reverse: true) {
    base_path
    content_id
    details
    document_type
  }
  primary_publishing_organisation: links_of_type(type: primary_publishing_organisation) {
    base_path
    title
    details
    document_type
  }
}

phase
public_updated_at
publishing_app
publishing_request_id
rendering_app
schema_name
title
updated_at
</code></pre></div><p>}
}
</code></pre>
<h2 id="performance">Performance</h2>
<p>The homepage query above completes in about ~35-60ms on my local machine, of which ~13-20ms is spent in the database:</p>
<pre><code># Homepage load times</p>
<p>Sequel::Postgres::Database (12.7ms)
Completed 200 OK in 35ms (Views: 0.6ms | GC: 0.0ms)</p>
<p>Sequel::Postgres::Database (18.9ms)
Completed 200 OK in 54ms (Views: 0.7ms | GC: 0.0ms)</p>
<p>Sequel::Postgres::Database (12.1ms)
Completed 200 OK in 34ms (Views: 0.7ms | GC: 0.0ms)
</code></pre>
<p>More complicated pages such as the ministers index page take longer to load, but still complete in well under a second:</p>
&lt;!&ndash; raw HTML omitted &ndash;&gt;
<pre lang="graphql"><code>fragment Person on Edition {
    title
    base_path
    details
    links {
        role_appointments: links_of_type(type: person, reverse: true) {
            links {
                role: links_of_type(type: role) {
                    title
                    base_path
                }
            }
        }
    }
}</p>
<p>fragment Department on Edition {
    base_path
    links {
        ordered_ministers: links_of_type(type: ordered_ministers) {
            base_path
        }
        ordered_roles: links_of_type(type: ordered_roles) {
            content_id
        }
    }
}</p>
<p>query ministers_index {
    edition(base_path: &quot;/government/ministers&quot;) {
        title
        links {
            ordered_cabinet_ministers: links_of_type(type: ordered_cabinet_ministers) {
                ...Person
            }
            ordered_also_attends_cabinet: links_of_type(
                type: ordered_also_attends_cabinet
            ) {
                ...Person
            }
            ordered_ministerial_departments: links_of_type(
                type: ordered_ministerial_departments
            ) {
                ...Department
            }
            ordered_assistant_whips: links_of_type(type: ordered_assistant_whips) {
                ...Person
            }
            ordered_baronesses_and_lords_in_waiting_whips: links_of_type(
                type: ordered_baronesses_and_lords_in_waiting_whips
            ) {
                ...Person
            }
            ordered_house_lords_whips: links_of_type(type: ordered_house_lords_whips) {
                ...Person
            }
            ordered_house_of_commons_whips: links_of_type(
                type: ordered_house_of_commons_whips
            ) {
                ...Person
            }
            ordered_junior_lords_of_the_treasury_whips: links_of_type(
                type: ordered_junior_lords_of_the_treasury_whips
            ) {
                ...Person
            }
        }
    }
}
</code></pre>
&lt;!&ndash; raw HTML omitted &ndash;&gt;
<pre><code># Ministers index load times</p>
<p>Sequel::Postgres::Database (120.2ms)
Completed 200 OK in 380ms (Views: 4.6ms | GC: 28.1ms)</p>
<p>Sequel::Postgres::Database (107.5ms)
Completed 200 OK in 331ms (Views: 3.7ms | GC: 5.4ms)</p>
<p>Sequel::Postgres::Database (101.1ms)
Completed 200 OK in 379ms (Views: 4.2ms | GC: 37.0ms)
</code></pre>
<h2 id="where-to-look-at-the-code">Where to look at the code?</h2>
<p>The big scary SQL query is in <code>app/graphql/resolvers/expanded_edition_resolver.rb</code>.</p>
<p>The code to walk the graphql lookahead and build link type paths, and the code to build a tree from
the database results is in <code>lib/tasks/path_tree_helpers.rb</code>.</p>
&lt;!&ndash; raw HTML omitted &ndash;&gt;
  </div></p>

  <script>
    /*
      Manually trigger the styling of the 'current page' in the sidebar,
      as it does not happen automatically because we are still technically
      in single page mode.
    */
    (function () {
        'use strict'
        /*
          Cannot use `$(document).ready` on next line as jQuery has not loaded
          yet. But we can use jQuery in the callback.
        */
        window.addEventListener('load', function () {
            try {
                new GOVUK.Modules.InPageNavigation().start($("html"));
            }
            catch (error) {
                /* Fail without causing other JS in the page to break */
                console.log("Error calling GOVUK's InPageNavigation module", error);
            }
        })
    }());
</script>


            
          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/govuk-developer-docs/blob/main/data/repos.yml">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?body=Problem+with+%27%27+%28https%3A%2F%2Fdocs.publishing.service.gov.uk%2Frepos%2Fgovuk-graphql.html%29&amp;labels=bug&amp;title=Re%3A+%27%27">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <svg focusable="false" role="presentation" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 60" height="30" width="32" fill="currentcolor" class="govuk-footer__crown">
    <g>
      <circle cx="20" cy="17.6" r="3.7"></circle>
      <circle cx="10.2" cy="23.5" r="3.7"></circle>
      <circle cx="3.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <circle cx="43.3" cy="17.6" r="3.7"></circle>
      <circle cx="53.2" cy="23.5" r="3.7"></circle>
      <circle cx="59.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
    </g>
  </svg>
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/accessibility.html">Accessibility</a>
            </li>
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/cookies.html">Cookies</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >Â© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/govuk_frontend.js" type="module"></script>
    <script src="/javascripts/application.js"></script>
  </body>
</html>
