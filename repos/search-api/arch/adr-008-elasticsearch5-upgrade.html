

<!doctype html>
<html lang="en" class="govuk-template govuk-template--rebranded no-js">
  <head>
    
    

    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>search-api: Decision record: Upgrade to Elasticsearch 5 - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/repos/search-api/arch/adr-008-elasticsearch5-upgrade.html">
      <link rel="icon" sizes="48x48" href="/assets/govuk/assets/rebrand/images/favicon.ico">
      <link rel="icon" sizes="any" href="/assets/govuk/assets/rebrand/images/favicon.svg" type="image/svg+xml">
      <link rel="mask-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-mask.svg" color="#0b0c0c">
      <link rel="apple-touch-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-180.png">
      <link rel="manifest" href="/assets/govuk/assets/rebrand/manifest.json">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta name="twitter:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta name="twitter:title" content="search-api: Decision record: Upgrade to Elasticsearch 5 - GOV.UK Developer Documentation" />
      <meta name="twitter:url" content="https://docs.publishing.service.gov.uk/repos/search-api/arch/adr-008-elasticsearch5-upgrade.html" />

      <meta property="og:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="search-api: Decision record: Upgrade to Elasticsearch 5" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/repos/search-api/arch/adr-008-elasticsearch5-upgrade.html" />

      <script>
  document.addEventListener('DOMContentLoaded', function () {
    var markup = `<div id="global-cookie-message" data-module="cookie-banner" data-nosnippet="" aria-label="Can we store analytics cookies on your device?" class="gem-c-cookie-banner govuk-clearfix govuk-cookie-banner js-banner-wrapper" role="region" hidden="hidden" title="Can we store analytics cookies on your device?"> <div class="govuk-cookie-banner__message govuk-width-container"> <div class="govuk-grid-row"> <div class="govuk-grid-column-two-thirds"> <h2 class="govuk-cookie-banner__heading govuk-heading-m">Can we store analytics cookies on your device?</h2> <div tabindex="-1" class="govuk-cookie-banner__content gem-c-cookie-banner__confirmation"> <div class="gem-c-cookie-banner__content"><p class='govuk-body'>We’d like to set some cookies to understand how you use this site and remember your settings.</p><p class='govuk-body'>We also use cookies set by other sites to help us deliver content from their services.</p></div> <p class="gem-c-cookie-banner__confirmation-message--accepted govuk-body" hidden data-ga4-cookie-banner data-module="ga4-link-tracker" data-ga4-track-links-only data-ga4-set-indexes data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" >You have accepted additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> <p class="gem-c-cookie-banner__confirmation-message--rejected govuk-body" hidden>You have rejected additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> </div> </div> </div> <div class="js-confirmation-buttons govuk-button-group"> <button class="gem-c-button govuk-button" type="submit" data-accept-cookies="true" data-cookie-types="all">Accept additional cookies</button> <button class="gem-c-button govuk-button" type="submit" data-reject-cookies="true">Reject additional cookies</button> <a class="govuk-link" href="/cookies.html">View cookies</a> </div> <div hidden class="js-hide-button govuk-button-group"> <button class="gem-c-cookie-banner__hide-button govuk-button" data-hide-cookie-banner="true" data-module="ga4-event-tracker" data-ga4-event="{&quot;event_name&quot;:&quot;select_content&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;action&quot;:&quot;closed&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" > Hide cookie message </button> </div> </div> </div>`;
    var banner = document.createElement('div');
    banner.innerHTML = markup;
    document.body.prepend(banner);
  })
</script>


  </head>

  <body class="govuk-template__body">
    <script>document.body.className += ' js-enabled' + ('noModule' in HTMLScriptElement.prototype ? ' govuk-frontend-supported' : '');</script>

    <div class="app-pane">
      
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <svg
          focusable="false"
          role="img"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 324 60"
          height="30"
          width="162"
          fill="currentcolor"
          class="govuk-header__logotype"
          aria-label="GOV.UK">
          <title>GOV.UK</title>
          <g>
            <circle cx="20" cy="17.6" r="3.7"></circle>
            <circle cx="10.2" cy="23.5" r="3.7"></circle>
            <circle cx="3.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <circle cx="43.3" cy="17.6" r="3.7"></circle>
            <circle cx="53.2" cy="23.5" r="3.7"></circle>
            <circle cx="59.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
          </g>
          <circle class="govuk-logo-dot" cx="226" cy="36" r="7.3"/>
          <path d="M93.94 41.25c.4 1.81 1.2 3.21 2.21 4.62 1 1.4 2.21 2.41 3.61 3.21s3.21 1.2 5.22 1.2 3.61-.4 4.82-1c1.4-.6 2.41-1.4 3.21-2.41.8-1 1.4-2.01 1.61-3.01s.4-2.01.4-3.01v.14h-10.86v-7.02h20.07v24.08h-8.03v-5.56c-.6.8-1.38 1.61-2.19 2.41-.8.8-1.81 1.2-2.81 1.81-1 .4-2.21.8-3.41 1.2s-2.41.4-3.81.4a18.56 18.56 0 0 1-14.65-6.63c-1.6-2.01-3.01-4.41-3.81-7.02s-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83a20.45 20.45 0 0 1 19.46-13.65c3.21 0 4.01.2 5.82.8 1.81.4 3.61 1.2 5.02 2.01 1.61.8 2.81 2.01 4.01 3.21s2.21 2.61 2.81 4.21l-7.63 4.41c-.4-1-1-1.81-1.61-2.61-.6-.8-1.4-1.4-2.21-2.01-.8-.6-1.81-1-2.81-1.4-1-.4-2.21-.4-3.61-.4-2.01 0-3.81.4-5.22 1.2-1.4.8-2.61 1.81-3.61 3.21s-1.61 2.81-2.21 4.62c-.4 1.81-.6 3.71-.6 5.42s.8 5.22.8 5.22Zm57.8-27.9c3.21 0 6.22.6 8.63 1.81 2.41 1.2 4.82 2.81 6.62 4.82S170.2 24.39 171 27s1.4 5.62 1.4 8.83-.4 6.02-1.4 8.83-2.41 5.02-4.01 7.02-4.01 3.61-6.62 4.82-5.42 1.81-8.63 1.81-6.22-.6-8.63-1.81-4.82-2.81-6.42-4.82-3.21-4.41-4.01-7.02-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83 2.41-5.02 4.01-7.02 4.01-3.61 6.42-4.82 5.42-1.81 8.63-1.81Zm0 36.73c1.81 0 3.61-.4 5.02-1s2.61-1.81 3.61-3.01 1.81-2.81 2.21-4.41c.4-1.81.8-3.61.8-5.62 0-2.21-.2-4.21-.8-6.02s-1.2-3.21-2.21-4.62c-1-1.2-2.21-2.21-3.61-3.01s-3.21-1-5.02-1-3.61.4-5.02 1c-1.4.8-2.61 1.81-3.61 3.01s-1.81 2.81-2.21 4.62c-.4 1.81-.8 3.61-.8 5.62 0 2.41.2 4.21.8 6.02.4 1.81 1.2 3.21 2.21 4.41s2.21 2.21 3.61 3.01c1.4.8 3.21 1 5.02 1Zm36.32 7.96-12.24-44.15h9.83l8.43 32.77h.4l8.23-32.77h9.83L200.3 58.04h-12.24Zm74.14-7.96c2.18 0 3.51-.6 3.51-.6 1.2-.6 2.01-1 2.81-1.81s1.4-1.81 1.81-2.81a13 13 0 0 0 .8-4.01V13.9h8.63v28.15c0 2.41-.4 4.62-1.4 6.62-.8 2.01-2.21 3.61-3.61 5.02s-3.41 2.41-5.62 3.21-4.62 1.2-7.02 1.2-5.02-.4-7.02-1.2c-2.21-.8-4.01-1.81-5.62-3.21s-2.81-3.01-3.61-5.02-1.4-4.21-1.4-6.62V13.9h8.63v26.95c0 1.61.2 3.01.8 4.01.4 1.2 1.2 2.21 2.01 2.81.8.8 1.81 1.4 2.81 1.81 0 0 1.34.6 3.51.6Zm34.22-36.18v18.92l15.65-18.92h10.82l-15.03 17.32 16.03 26.83h-10.21l-11.44-20.21-5.62 6.22v13.99h-8.83V13.9"/>
        </svg>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <nav class="govuk-header__navigation govuk-header__navigation--end" aria-label="Menu">
        <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" hidden>Menu</button>
        <ul id="navigation" class="govuk-header__navigation-list">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual.html">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/kubernetes/">Kubernetes</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/apps.html" aria-current="page">Apps</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/repos.html">Repos</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/mobile/">Mobile</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1">
              <div class="search" data-module="search" data-path-to-site-root="/">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input
      type="search"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <ul>
    <li>
      <a href="/repos/search-api.html" rel="noopener" class="govuk-link">search-api</a>
    </li>
    <li>
      <ul>
            <li><a href="/repos/search-api/adding-new-fields.html" rel="noopener" class="govuk-link">Adding new fields to a document type</a></li>
    <li><a href="/repos/search-api/autocomplete.html" rel="noopener" class="govuk-link">Autocomplete</a></li>
    <li><a href="/repos/search-api/content-api.html" rel="noopener" class="govuk-link">Internal "content API"</a></li>
    <li><a href="/repos/search-api/documents.html" rel="noopener" class="govuk-link">Documents API (to be deprecated)</a></li>
    <li><a href="/repos/search-api/indexing.html" rel="noopener" class="govuk-link">Indexing</a></li>
    <li><a href="/repos/search-api/new-indexing-process.html" rel="noopener" class="govuk-link">Moving a format to the new indexing process</a></li>
    <li><a href="/repos/search-api/relevancy.html" rel="noopener" class="govuk-link">Relevancy</a></li>
    <li><a href="/repos/search-api/schemas.html" rel="noopener" class="govuk-link">Schema definitions</a></li>
    <li><a href="/repos/search-api/search-quality-metrics.html" rel="noopener" class="govuk-link">Search Quality Metrics</a></li>
    <li><a href="/repos/search-api/updating_popularity.html" rel="noopener" class="govuk-link">How Search API Populates Popularity Fields</a></li>
    <li><a href="/repos/search-api/using-the-search-api.html" rel="noopener" class="govuk-link">Using the search API</a></li>
    <li class="subdir__heading">arch</li>
    <ul class="subdir__menu">
          <li><a href="/repos/search-api/arch/adr-001-use-of-both-rabbitmq-and-sidekiq-queues.html" rel="noopener" class="govuk-link">Decision record: use of both RabbitMQ (bunny) and Redis (Sidekiq) queuing systems</a></li>
    <li><a href="/repos/search-api/arch/adr-002-handle-race-conditions-in-govuk-index.html" rel="noopener" class="govuk-link">Decision record: use versioning to handle race conditions when updating the govuk index</a></li>
    <li><a href="/repos/search-api/arch/adr-003-popularity-updating-without-index-locks.html" rel="noopener" class="govuk-link">Decision record: perform popularity updating without using an index lock</a></li>
    <li><a href="/repos/search-api/arch/adr-004-transition-mainstream-to-publishing-api-index.html" rel="noopener" class="govuk-link">Decision record: Transition mainstream formats to a Publishing API derived search index</a></li>
    <li><a href="/repos/search-api/arch/adr-005-incremental-popularity-updates.html" rel="noopener" class="govuk-link">Decision record: Incremental popularity updates</a></li>
    <li><a href="/repos/search-api/arch/adr-006-transition-whitehall-to-publishing-api-index.html" rel="noopener" class="govuk-link">Decision record: Transition whitehall documents to a Publishing API derived search index</a></li>
    <li><a href="/repos/search-api/arch/adr-007-batch-processing-of-rabbit-mq-messages.html" rel="noopener" class="govuk-link">Decision record: Batch processing of rabbit MQ messages</a></li>
    <li><a href="/repos/search-api/arch/adr-008-elasticsearch5-upgrade.html" rel="noopener" class="govuk-link">Decision record: Upgrade to Elasticsearch 5</a></li>
    <li><a href="/repos/search-api/arch/adr-009-elasticsearch6-upgrade.html" rel="noopener" class="govuk-link">Decision record: Upgrade to Elasticsearch 6</a></li>
    <li><a href="/repos/search-api/arch/adr-010-learn-to-rank.html" rel="noopener" class="govuk-link">Decision record: Learning To Rank</a></li>
    <li><a href="/repos/search-api/arch/adr-011-sagemaker.html" rel="noopener" class="govuk-link">Decision record: Sagemaker</a></li>
    <li><a href="/repos/search-api/arch/adr-012-learn-to-rank.html" rel="noopener" class="govuk-link">Decision record: Decommissioning Learning to Rank</a></li>
    <li><a href="/repos/search-api/arch/adr-013-rabbitmq-sidekiq-removal.html" rel="noopener" class="govuk-link">Decision record: Removing Sidekiq from RabbitMQ queue consumers</a></li>

    </ul>

      </ul>
    </li>
  </ul>

              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled" aria-label="Content">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              
<script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "item": {
        "name": "Home",
        "@id": "http://www.dev.gov.uk/"
      }
    },
    {
      "@type": "ListItem",
      "position": 2,
      "item": {
        "name": "Apps",
        "@id": "http://www.dev.gov.uk/apps.html"
      }
    },
    {
      "@type": "ListItem",
      "position": 3,
      "item": {
        "name": "search-api",
        "@id": "http://www.dev.gov.uk/repos/search-api.html"
      }
    }
  ]
}
</script>

<nav data-module="ga4-link-tracker" aria-label="Breadcrumb" class="gem-c-breadcrumbs govuk-breadcrumbs">
  <ol class="govuk-breadcrumbs__list">
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;1&quot;,&quot;index_total&quot;:&quot;3&quot;}" class="govuk-breadcrumbs__link" href="/">Home</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;2&quot;,&quot;index_total&quot;:&quot;3&quot;}" class="govuk-breadcrumbs__link" href="/apps.html">Apps</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;3&quot;,&quot;index_total&quot;:&quot;3&quot;}" class="govuk-breadcrumbs__link" href="/repos/search-api.html">search-api</a>
        </li>
  </ol>
</nav>
  <div class="govuk-!-font-size-16 govuk-!-margin-top-6">
    <div class="govuk-warning-text">
      <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
      <strong class="govuk-warning-text__text">
        <span class="govuk-warning-text__assistive">Warning</span>
        This document has not been updated for a while now. It may be out of date.
      </strong>
    </div>

  Last updated: <a href="https://github.com/alphagov/search-api/commit/2675a59c7c82a1000f9ac0baf9fa3f97fc68fa26">9 Jun 2020</a>
</div>

  <h1 class="page-title">search-api: Decision record: Upgrade to Elasticsearch 5</h1>

  
<p><strong>Date:</strong> 2019-04-30</p>
<ol>
<li><a href="#high-level-migration-plan">High-level migration plan</a></li>
<li><a href="#running-search-api-and-rummager-in-parallel">Running search-api and rummager in parallel</a></li>
<li><a href="#elasticsearch-5-compatibility">Elasticsearch 5 compatibility</a></li>
<li><a href="#looking-to-the-future-elasticsearch-6-compatibility">Looking to the future: Elasticsearch 6 compatibility</a></li>
<li><a href="#new-cluster-architecture">New cluster architecture</a></li>
<li><a href="#synchronising-the-state">Synchronising the state</a></li>
<li><a href="#switching-over-the-applications">Switching over the applications</a></li>
<li><a href="#staging-teething-problems">Staging teething problems</a></li>
<li><a href="#production-teething-problems">Production teething problems</a></li>
<li><a href="#data-sync-for-production---staging---integration">Data sync for production -&gt; staging -&gt; integration</a></li>
<li><a href="#dockerising-the-development-vm">Dockerising the development VM</a></li>
</ol>
<p>This work was done over 2018/19 Q4.  All of the changes to rummager /
search-api are contained in <a href="https://github.com/alphagov/search-api/pull/1439">PR #1439</a>.  There were also significant
changes in <a href="https://github.com/alphagov/govuk-aws">govuk-aws</a>, <a href="https://github.com/alphagov/govuk-aws-data">govuk-aws-data</a>, and <a href="https://github.com/alphagov/govuk-puppet">govuk-puppet</a>,
with various other repositories having small changes as well.</p>
<p>Terminology:</p>
<ul>
<li>
<p><strong>rummager</strong> is the Elasticsearch 2 search service, and is deployed
to Carrenza (in staging and production).</p>
</li>
<li>
<p><strong>search-api</strong> is the Elasticsearch 5 search service, and is
deployed to AWS.</p>
</li>
</ul>
<h2 id="high-level-migration-plan">High-level migration plan</h2>
<p>We decided on two high-level objectives before any further planning:</p>
<ul>
<li>
<p>This should be a close-to-zero-downtime switch.</p>
</li>
<li>
<p>We don't want to set up new infrastructure in Carrenza.</p>
</li>
</ul>
<p>A consequence of those is that we needed to have, at least
temporarily, two Elasticsearch clusters (Elasticsearch 2 in Carrenza
and Elasticsearch 5 in AWS).  The rest of the plan came out of that
decision:</p>
<ol>
<li>Create a fork of rummager called "search-api", which will run on a
different port and be deployed to AWS.</li>
<li>Make search-api work with Elasticsearch 5.</li>
<li>Arrange for updates sent to rummager to also be sent to search-api.</li>
<li>Set up a new Elasticsearch 5 cluster.</li>
<li>Perform a one-time import of data from Elasticsearch 2 to
Elasticsearch 5, and synchronise any updates missed while this
import was running.</li>
<li>Confirm that the Elasticsearch 2 and Elasticsearch 5 clusters are
consistent.</li>
<li>Use Plek to make applications which only read from search use
search-api.</li>
<li>Use Plek to make applications which write to search use search-api.</li>
<li>Retire rummager, Elasticsearch 2, and anything related.</li>
</ol>
<p><a href="https://github.com/alphagov/licence-finder">licence-finder</a> also uses Elasticsearch.  It only stores a small
amount of data, and can reindex in under a minute, so we decided not
to go through the complication of running a second licence-finder.  As
soon as the new Elasticsearch cluster existed in production, we
switched over licence-finder.</p>
<h2 id="running-search-api-and-rummager-in-parallel">Running search-api and rummager in parallel</h2>
<p>This was largely a matter of following the "<a href="https://docs.publishing.service.gov.uk/manual/setting-up-new-rails-app.html">Set up a new Rails
application</a>" documentation, with the main difference being that we
were basing the configuration for the search-api on the existing
Puppet (etc) code for rummager.</p>
<p>The changes needed to the rummager configuration were:</p>
<ul>
<li>Changing the port from 3009 to 3233 (the first available free port).</li>
<li>Changing the redis namespace from "rummager" to "search-api".</li>
<li>Changing the rabbitmq namespace from "rummager" to "search-api".</li>
</ul>
<p>Additionally, the "search-api" hostname needed adding to the Terraform
configuration.</p>
<h2 id="elasticsearch-5-compatibility">Elasticsearch 5 compatibility</h2>
<p>The Elasticsearch 5 release notes includes <a href="https://www.elastic.co/guide/en/elasticsearch/reference/5.0/breaking-changes-5.0.html">a large section on
breaking changes</a>.  Neither of the developers on the team knew
Elasticsearch at the start of the quarter, so this section served to
guide us into the necessary documentation.</p>
<p>The main changes which we had to address were structural changes to
the query language, which were generally straightforward to resolve.</p>
<p>There were two more complex issues which will need to be revisited
when moving to Elasticsearch 6:</p>
<ul>
<li>
<p>The default text similarity metric changed from the "classic"
algorithm to BM25.  We encountered problems with result ordering,
possibly due to this, and switched back to the classic algorithm.</p>
</li>
<li>
<p>The Elasticsearch 2 <code>string</code> type has been split into two new types,
<code>keywords</code> and <code>text</code>, with different behaviours.  Elasticsearch 5
internally transforms a single <code>string</code> field into two fields of the
new types, transparently handling indexing and querying.  We did not
update our schemas to use <code>text</code>/<code>keywords</code>.</p>
</li>
</ul>
<h2 id="looking-to-the-future-elasticsearch-6-compatibility">Looking to the future: Elasticsearch 6 compatibility</h2>
<p>Elasticsearch 2 and 5 allow having multiple document types in the same
index.  Elasticsearch 6 does not allow this.</p>
<p>There are two ways to solve the problem:</p>
<ul>
<li>Combine all the types into one large type, and add a "type" field
which the application uses.</li>
<li>Add a separate index for each type.</li>
</ul>
<p>We decided to combine all the types in each index into one big type,
and added a <code>document_type</code> field to distinguish them.  As this is
what Elasticsearch 2 did anyway (all documents in the same Lucene
index must be of the same type), we do not think this imposes any
additional overhead.</p>
<p>search-api still validates documents against schemas, it just uses a
different field to hold the type.  The external API has not been
changed.</p>
<h2 id="new-cluster-architecture">New cluster architecture</h2>
<p>We decided to use an AWS managed Elasticsearch cluster.  Self-managing
Elasticsearch is undesirable because:</p>
<ul>
<li>Nobody knows how to manage Elasticsearch.</li>
<li>Our version of Puppet is so old we can't use a version of
<a href="https://github.com/elastic/puppet-elasticsearch">puppet-elasticsearch</a> which supports Elasticsearch 6.</li>
<li>It's much harder to scale.</li>
</ul>
<p>We designed a new cluster architecture based on the resources
allocated to the current Elasticsearch 2 cluster, but it proved to not
be sufficient.  At the time of writing, the cluster has:</p>
<ul>
<li>Three dedicated master nodes, of type <code>c4.large.elasticsearch</code>.</li>
<li>Six data nodes, of type <code>r4.large.elasticsearch</code>.</li>
</ul>
<p>The cluster is configured by the <a href="https://github.com/alphagov/govuk-aws/tree/master/terraform/projects/app-elasticsearch5">app-elasticsearch5</a> Terraform
project.</p>
<h2 id="synchronising-the-state">Synchronising the state</h2>
<p>There are two steps to this:</p>
<ul>
<li>Ensuring search updates sent to rummager are also sent to search-api.</li>
<li>Import the current Elasticsearch 2 data.</li>
</ul>
<p>First we ensured that updates were sent to search-api, as there
wouldn't be any point in importing data which would immediately become
out of date.</p>
<p>There are three ways in which data gets into rummager:</p>
<ul>
<li>From the publishing-api via rabbitmq.</li>
<li>From search-admin over HTTP.</li>
<li>From whitehall over HTTP.</li>
</ul>
<p>The publishing-api updates were already handled by us setting up
search-api in a similar way to rummager.  We handled the HTTP updates
by using traffic replay: all traffic sent to rummager was also sent to
search-api.  This was not 100% reliable, and occasionally dropped
documents, but in such cases re-sending the document from whitehall to
rummager made it also appear in search-api.</p>
<p>For the data import, we have a script to fetch the documents from
Elasticsearch 2, transform them into the new single-type format, and
insert them into Elasticsearch 5: <a href="https://github.com/alphagov/elasticsearch-migration-helpers/">elasticsearch-migration-helpers</a>.</p>
<p>We created fresh search indices, ran the import script, and replayed
any updates that had been missed due to that running.</p>
<h2 id="switching-over-the-applications">Switching over the applications</h2>
<p>We handled the application switch-over with Plek.  We gave each
search-using application a new parameter in Puppet, to specify a URL
which should be set for the <code>PLEK_SERVICE_RUMMAGER_URI</code> and
<code>PLEK_SERVICE_SEARCH_URI</code> environment variables.  We could configure
this through the hieradata, allowing applications to be switched over
independently of other applications or how they were configured in
other environments.</p>
<p>We switched over each environment independently.  The only constraint
on the order of changes is that applications which update search
should be done after applications which query search, to avoid an
inconsistent state where some things are querying rummager but other
things are only updating search-api.</p>
<p>For the production switch-over we divided the applications by
riskiness:</p>
<ol>
<li>collections and licence-finder</li>
<li>finder-frontend</li>
<li>content-tagger and hmrc-manuals-api</li>
<li>search-admin and whitehall (frontend and backend)</li>
</ol>
<p>We then set the rummager <a href="https://aws.amazon.com/xray/">X-Ray</a> recording to 100%, to verify that
only monitoring was still talking to it.</p>
<h2 id="staging-teething-problems">Staging teething problems</h2>
<p>We discovered some significant problems during manual testing in
staging which delayed the production roll-out by a few weeks.  These
were:</p>
<ul>
<li>
<p><strong>Very strange result ordering.</strong> We resolved this by switching back
to the classic text similarity and back to using <code>string</code> fields.
These are mentioned in more detail further up.</p>
</li>
<li>
<p><strong>Every query returned every best bet.</strong> This was due to a mistake
made when combining all the types.</p>
</li>
<li>
<p><strong>Indices would automatically unlock.</strong> This was due to an AWS
process which runs every four minutes: locking the indices if the
cluster is unhealthy and unlocking them if it is healthy.  We
changed to using <code>read_only_allow_delete</code>, which introduced some
benign (but potentially confusing) race conditions in importing page
traffic data and reindexing with a new schema.</p>
<p>These issues are commented on in the code:</p>
<blockquote>
<p>We need to switch the aliases without a lock, since
<code>read_only_allow_delete</code> prevents aliases being changed.</p>
<p>The page traffic loader is is a daily process, so there won't be a
race condition.</p>
</blockquote>
<blockquote>
<p>We need to switch the aliases without a lock, since
<code>read_only_allow_delete</code> prevents aliases being changed.</p>
<p>After running the schema migration, traffic must be represented
anyway, so the race condition is irrelevant.</p>
</blockquote>
</li>
<li>
<p><strong>Equivalent synonyms were not expanded.</strong> We didn't figure out why
this was happening, as the default configuration is to expand
equivalent synonyms, and this configuration is not overrided.  The
problem was fixed by turning all equivalent synonyms into explicit
mappings.</p>
</li>
<li>
<p><strong>Some queries would throw a bad request error during best bet
analysis.</strong> We also didn't figure out why this was happening.  It is
possibly a problem with the Elasticsearch ruby library, as we were
unsuccessful in replicating the problem when <code>curl</code>ing the cluster
directly.  The problem was solved by handling the exception.</p>
</li>
</ul>
<h2 id="production-teething-problems">Production teething problems</h2>
<p>We encountered some issues after switching over production.  We
suspect that these had not been caught in staging because staging
doesn't have publishing activity, and also there is a possibility that
the traffic replay to staging had not been set to 100%.</p>
<p>Elasticsearch performance issues:</p>
<ul>
<li>
<p><strong>Queries queueing up in Elasticsearch.</strong> We didn't realise that
this was a problem at first, due to unfamiliarity with the new
metrics.  We ended up doubling the size of the cluster and also
switching to faster data nodes.</p>
</li>
<li>
<p><strong>Long, slow, queries.</strong> The slow query logs revealed that we were
sometimes getting 3,000+ character queries which would take over a
second each to execute.  We changed search-api to reject queries
over 512 characters in length, and finder-frontend to truncate such
queries.</p>
<p>This was probably also a problem with Elasticsearch 2.</p>
</li>
</ul>
<p>Elasticsearch errors:</p>
<ul>
<li>
<p><strong>Errors due to unmapped types being used for sorting.</strong> Most
queries are over multiple indices, but not all fields exist in all
indices.  We saw many errors trying to sort by a field which was
only present in the <code>govuk</code> index.  This was fine, as all the
results were in the <code>govuk</code> index, but the errors were so frequent
that they obscured any actual problems.  We changed the query
search-api generates to include a default sort behaviour for missing
fields, sorting them to the end.</p>
<p>This was probably also a problem with Elasticsearch 2.</p>
</li>
</ul>
<p>search-api performance issues:</p>
<ul>
<li>
<p><strong>Only two search machines (rather than three) had been
provisioned.</strong> The Terraform configuration for the AWS search
machines only created two machines, whreas we had three in Carrenza.
So search-api could only handle two thirds of the traffic of
rummager.  We initially bumped the unicorn workers in each AWS
search machine by half, and then added the missing third machine
when we realised the problem.</p>
</li>
<li>
<p><strong>Failing to generate the sitemap files.</strong> The AWS search machines
were running out of memory trying to generate sitemap files.  These
were working at one point, but then stopped.  We changed the sitemap
files to only have 25,000 links per file (rather than 50,000).  This
revealed a bug we would have eventually hit anyway, where sitemap
generation failed when there are 10 or more sitemap files.  That bug
was fixed.</p>
</li>
</ul>
<h2 id="data-sync-for-production-staging-integration">Data sync for production -&gt; staging -&gt; integration</h2>
<p>We use Elasticsearch snapshots for the data sync.</p>
<p>There are three snapshot repositories backed by S3 buckets:</p>
<ul>
<li>
<code>govuk-production</code>, backed by <code>govuk-production-elasticsearch5-manual-snapshots</code>.</li>
<li>
<code>govuk-staging</code>, backed by <code>govuk-staging-elasticsearch5-manual-snapshots</code>.</li>
<li>
<code>govuk-integration</code>, backed by <code>govuk-integration-elasticsearch5-manual-snapshots</code>.</li>
</ul>
<p>Elasticsearches write to and read from these repositories:</p>
<ul>
<li>Production <em>writes to</em> <code>govuk-production</code>.</li>
<li>Staging <em>reads from</em> <code>govuk-production</code> and <em>writes to</em> <code>govuk-staging</code>.</li>
<li>Integration <em>reads from</em> <code>govuk-staging</code> and <em>writes to</em> <code>govuk-integration</code>.</li>
</ul>
<p>Sometimes staging writes a metadata file to the production bucket (and
integration writes a metadata file to the staging bucket).  This can't
be avoided, as Elasticsearch requires write access to a snapshot
repository even if it only ever restores snapshots, so we have a
Lambda to fix the object permissions when this happens.</p>
<p>Taking and restoring snapshots is triggered by the <code>govuk_env_sync</code>
script.</p>
<p>Terraform can provision the S3 buckets, but it can't tell
Elasticsearch about them.  This Python script does that:</p>
<pre lang="python"><code>import os
import sys
import boto3
import requests
from requests_aws4auth import AWS4Auth

host = 'http://elasticsearch5/'
region = 'eu-west-1'
service = 'es'
credentials = boto3.Session().get_credentials()
awsauth = AWS4Auth(credentials.access_key, credentials.secret_key, region, service, session_token=credentials.token)

def register_repository(name, role_arn, delete_first=False):
    print(name)

    url = host + '_snapshot/' + name

    if delete_first:
        r = requests.delete(url)
        r.raise_for_status()
        print(r.text)

    payload = {
        "type": "s3",
        "settings": {
            "bucket": name + '-elasticsearch5-manual-snapshots',
            "region": region,
            "role_arn": role_arn
        }
    }

    headers = {"Content-Type": "application/json"}

    r = requests.put(url, auth=awsauth, json=payload, headers=headers)
    r.raise_for_status()
    print(r.text)

delete_first = 'DELETE_FIRST' in os.environ

if sys.argv[1] == 'integration':
    role_arn = 'arn:aws:iam::210287912431:role/blue-elasticsearch5-manual-snapshot-role'
    register_repository('govuk-integration', role_arn, delete_first=delete_first) # write
    register_repository('govuk-staging', role_arn, delete_first=delete_first) # read
elif sys.argv[1] == 'staging':
    role_arn = 'arn:aws:iam::696911096973:role/blue-elasticsearch5-manual-snapshot-role'
    register_repository('govuk-staging', role_arn, delete_first=delete_first) # write
    register_repository('govuk-production', role_arn, delete_first=delete_first) # read
elif sys.argv[1] == 'production':
    role_arn = 'arn:aws:iam::172025368201:role/blue-elasticsearch5-manual-snapshot-role'
    register_repository('govuk-production', role_arn, delete_first=delete_first) # write
else:
    print('expected one of [integration|staging|production]')
</code></pre>
<h2 id="dockerising-the-development-vm">Dockerising the development VM</h2>
<p>We can't mange Elasticsearch 6 through Puppet, due to version
constraints.  Upgrading Puppet so we can upgrade eventually to
Elasticsearch 6 is far too much work, so we dockerised Elasticsearch 5
in the development VM.</p>
<p>The data replication process was changed to download the
<code>govuk-integration-elasticsearch5-manual-snapshots</code> S3 bucket, copy it
into the docker container, and restore the latest snapshot.</p>

  <script>
    /*
      Manually trigger the styling of the 'current page' in the sidebar,
      as it does not happen automatically because we are still technically
      in single page mode.
    */
    (function () {
        'use strict'
        /*
          Cannot use `$(document).ready` on next line as jQuery has not loaded
          yet. But we can use jQuery in the callback.
        */
        window.addEventListener('load', function () {
            try {
                new GOVUK.Modules.InPageNavigation().start($("html"));
            }
            catch (error) {
                /* Fail without causing other JS in the page to break */
                console.log("Error calling GOVUK's InPageNavigation module", error);
            }
        })
    }());
</script>


            
          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/search-api/blob/main/docs/arch/adr-008-elasticsearch5-upgrade.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?body=Problem+with+%27%27+%28https%3A%2F%2Fdocs.publishing.service.gov.uk%2Frepos%2Fsearch-api%2Farch%2Fadr-008-elasticsearch5-upgrade.html%29&amp;labels=bug&amp;title=Re%3A+%27%27">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <svg focusable="false" role="presentation" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 60" height="30" width="32" fill="currentcolor" class="govuk-footer__crown">
    <g>
      <circle cx="20" cy="17.6" r="3.7"></circle>
      <circle cx="10.2" cy="23.5" r="3.7"></circle>
      <circle cx="3.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <circle cx="43.3" cy="17.6" r="3.7"></circle>
      <circle cx="53.2" cy="23.5" r="3.7"></circle>
      <circle cx="59.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
    </g>
  </svg>
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/accessibility.html">Accessibility</a>
            </li>
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/cookies.html">Cookies</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/govuk_frontend.js" type="module"></script>
    <script src="/javascripts/application.js"></script>
  </body>
</html>
