

<!doctype html>
<html lang="en" class="govuk-template govuk-template--rebranded no-js">
  <head>
    

    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>search-api: Decision record: Upgrade to Elasticsearch 6 - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/repos/search-api/arch/adr-009-elasticsearch6-upgrade.html">
      <link rel="icon" sizes="48x48" href="/assets/govuk/assets/rebrand/images/favicon.ico">
      <link rel="icon" sizes="any" href="/assets/govuk/assets/rebrand/images/favicon.svg" type="image/svg+xml">
      <link rel="mask-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-mask.svg" color="#0b0c0c">
      <link rel="apple-touch-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-180.png">
      <link rel="manifest" href="/assets/govuk/assets/rebrand/manifest.json">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta name="twitter:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta name="twitter:title" content="search-api: Decision record: Upgrade to Elasticsearch 6 - GOV.UK Developer Documentation" />
      <meta name="twitter:url" content="https://docs.publishing.service.gov.uk/repos/search-api/arch/adr-009-elasticsearch6-upgrade.html" />

      <meta property="og:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="search-api: Decision record: Upgrade to Elasticsearch 6" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/repos/search-api/arch/adr-009-elasticsearch6-upgrade.html" />

      <script>
  document.addEventListener('DOMContentLoaded', function () {
    var markup = `<div id="global-cookie-message" data-module="cookie-banner" data-nosnippet="" aria-label="Can we store analytics cookies on your device?" class="gem-c-cookie-banner govuk-clearfix govuk-cookie-banner js-banner-wrapper" role="region" hidden="hidden" title="Can we store analytics cookies on your device?"> <div class="govuk-cookie-banner__message govuk-width-container"> <div class="govuk-grid-row"> <div class="govuk-grid-column-two-thirds"> <h2 class="govuk-cookie-banner__heading govuk-heading-m">Can we store analytics cookies on your device?</h2> <div tabindex="-1" class="govuk-cookie-banner__content gem-c-cookie-banner__confirmation"> <div class="gem-c-cookie-banner__content"><p class='govuk-body'>Weâ€™d like to set some cookies to understand how you use this site and remember your settings.</p><p class='govuk-body'>We also use cookies set by other sites to help us deliver content from their services.</p></div> <p class="gem-c-cookie-banner__confirmation-message--accepted govuk-body" hidden data-ga4-cookie-banner data-module="ga4-link-tracker" data-ga4-track-links-only data-ga4-set-indexes data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" >You have accepted additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> <p class="gem-c-cookie-banner__confirmation-message--rejected govuk-body" hidden>You have rejected additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> </div> </div> </div> <div class="js-confirmation-buttons govuk-button-group"> <button class="gem-c-button govuk-button" type="submit" data-accept-cookies="true" data-cookie-types="all">Accept additional cookies</button> <button class="gem-c-button govuk-button" type="submit" data-reject-cookies="true">Reject additional cookies</button> <a class="govuk-link" href="/cookies.html">View cookies</a> </div> <div hidden class="js-hide-button govuk-button-group"> <button class="gem-c-cookie-banner__hide-button govuk-button" data-hide-cookie-banner="true" data-module="ga4-event-tracker" data-ga4-event="{&quot;event_name&quot;:&quot;select_content&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;action&quot;:&quot;closed&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" > Hide cookie message </button> </div> </div> </div>`;
    var banner = document.createElement('div');
    banner.innerHTML = markup;
    document.body.prepend(banner);
  })
</script>


  </head>

  <body class="govuk-template__body">
    <script>document.body.className += ' js-enabled' + ('noModule' in HTMLScriptElement.prototype ? ' govuk-frontend-supported' : '');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <svg
          focusable="false"
          role="img"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 324 60"
          height="30"
          width="162"
          fill="currentcolor"
          class="govuk-header__logotype"
          aria-label="GOV.UK">
          <title>GOV.UK</title>
          <g>
            <circle cx="20" cy="17.6" r="3.7"></circle>
            <circle cx="10.2" cy="23.5" r="3.7"></circle>
            <circle cx="3.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <circle cx="43.3" cy="17.6" r="3.7"></circle>
            <circle cx="53.2" cy="23.5" r="3.7"></circle>
            <circle cx="59.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
          </g>
          <circle class="govuk-logo-dot" cx="226" cy="36" r="7.3"/>
          <path d="M93.94 41.25c.4 1.81 1.2 3.21 2.21 4.62 1 1.4 2.21 2.41 3.61 3.21s3.21 1.2 5.22 1.2 3.61-.4 4.82-1c1.4-.6 2.41-1.4 3.21-2.41.8-1 1.4-2.01 1.61-3.01s.4-2.01.4-3.01v.14h-10.86v-7.02h20.07v24.08h-8.03v-5.56c-.6.8-1.38 1.61-2.19 2.41-.8.8-1.81 1.2-2.81 1.81-1 .4-2.21.8-3.41 1.2s-2.41.4-3.81.4a18.56 18.56 0 0 1-14.65-6.63c-1.6-2.01-3.01-4.41-3.81-7.02s-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83a20.45 20.45 0 0 1 19.46-13.65c3.21 0 4.01.2 5.82.8 1.81.4 3.61 1.2 5.02 2.01 1.61.8 2.81 2.01 4.01 3.21s2.21 2.61 2.81 4.21l-7.63 4.41c-.4-1-1-1.81-1.61-2.61-.6-.8-1.4-1.4-2.21-2.01-.8-.6-1.81-1-2.81-1.4-1-.4-2.21-.4-3.61-.4-2.01 0-3.81.4-5.22 1.2-1.4.8-2.61 1.81-3.61 3.21s-1.61 2.81-2.21 4.62c-.4 1.81-.6 3.71-.6 5.42s.8 5.22.8 5.22Zm57.8-27.9c3.21 0 6.22.6 8.63 1.81 2.41 1.2 4.82 2.81 6.62 4.82S170.2 24.39 171 27s1.4 5.62 1.4 8.83-.4 6.02-1.4 8.83-2.41 5.02-4.01 7.02-4.01 3.61-6.62 4.82-5.42 1.81-8.63 1.81-6.22-.6-8.63-1.81-4.82-2.81-6.42-4.82-3.21-4.41-4.01-7.02-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83 2.41-5.02 4.01-7.02 4.01-3.61 6.42-4.82 5.42-1.81 8.63-1.81Zm0 36.73c1.81 0 3.61-.4 5.02-1s2.61-1.81 3.61-3.01 1.81-2.81 2.21-4.41c.4-1.81.8-3.61.8-5.62 0-2.21-.2-4.21-.8-6.02s-1.2-3.21-2.21-4.62c-1-1.2-2.21-2.21-3.61-3.01s-3.21-1-5.02-1-3.61.4-5.02 1c-1.4.8-2.61 1.81-3.61 3.01s-1.81 2.81-2.21 4.62c-.4 1.81-.8 3.61-.8 5.62 0 2.41.2 4.21.8 6.02.4 1.81 1.2 3.21 2.21 4.41s2.21 2.21 3.61 3.01c1.4.8 3.21 1 5.02 1Zm36.32 7.96-12.24-44.15h9.83l8.43 32.77h.4l8.23-32.77h9.83L200.3 58.04h-12.24Zm74.14-7.96c2.18 0 3.51-.6 3.51-.6 1.2-.6 2.01-1 2.81-1.81s1.4-1.81 1.81-2.81a13 13 0 0 0 .8-4.01V13.9h8.63v28.15c0 2.41-.4 4.62-1.4 6.62-.8 2.01-2.21 3.61-3.61 5.02s-3.41 2.41-5.62 3.21-4.62 1.2-7.02 1.2-5.02-.4-7.02-1.2c-2.21-.8-4.01-1.81-5.62-3.21s-2.81-3.01-3.61-5.02-1.4-4.21-1.4-6.62V13.9h8.63v26.95c0 1.61.2 3.01.8 4.01.4 1.2 1.2 2.21 2.01 2.81.8.8 1.81 1.4 2.81 1.81 0 0 1.34.6 3.51.6Zm34.22-36.18v18.92l15.65-18.92h10.82l-15.03 17.32 16.03 26.83h-10.21l-11.44-20.21-5.62 6.22v13.99h-8.83V13.9"/>
        </svg>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <nav class="govuk-header__navigation govuk-header__navigation--end" aria-label="Menu">
        <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" hidden>Menu</button>
        <ul id="navigation" class="govuk-header__navigation-list">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual.html">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/kubernetes/">Kubernetes</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/apps.html" aria-current="page">Apps</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/repos.html">Repos</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/mobile/">Mobile</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1">
              <div class="search" data-module="search" data-path-to-site-root="/">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input
      type="search"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <ul>
    <li>
      <a href="/repos/search-api.html" rel="noopener" class="govuk-link">search-api</a>
    </li>
    <li>
      <ul>
            <li><a href="/repos/search-api/adding-new-fields.html" rel="noopener" class="govuk-link">Adding new fields to a document type</a></li>
    <li><a href="/repos/search-api/content-api.html" rel="noopener" class="govuk-link">Internal "content API"</a></li>
    <li><a href="/repos/search-api/documents.html" rel="noopener" class="govuk-link">Documents API (to be deprecated)</a></li>
    <li><a href="/repos/search-api/indexing.html" rel="noopener" class="govuk-link">Indexing</a></li>
    <li><a href="/repos/search-api/new-indexing-process.html" rel="noopener" class="govuk-link">Moving a format to the new indexing process</a></li>
    <li><a href="/repos/search-api/relevancy.html" rel="noopener" class="govuk-link">Relevancy</a></li>
    <li><a href="/repos/search-api/schemas.html" rel="noopener" class="govuk-link">Schema definitions</a></li>
    <li><a href="/repos/search-api/search-quality-metrics.html" rel="noopener" class="govuk-link">Search Quality Metrics</a></li>
    <li><a href="/repos/search-api/using-the-search-api.html" rel="noopener" class="govuk-link">Using the search API</a></li>
    <li class="subdir__heading">arch</li>
    <ul class="subdir__menu">
          <li><a href="/repos/search-api/arch/adr-001-use-of-both-rabbitmq-and-sidekiq-queues.html" rel="noopener" class="govuk-link">Decision record: use of both RabbitMQ (bunny) and Redis (Sidekiq) queuing systems</a></li>
    <li><a href="/repos/search-api/arch/adr-002-handle-race-conditions-in-govuk-index.html" rel="noopener" class="govuk-link">Decision record: use versioning to handle race conditions when updating the govuk index</a></li>
    <li><a href="/repos/search-api/arch/adr-003-popularity-updating-without-index-locks.html" rel="noopener" class="govuk-link">Decision record: perform popularity updating without using an index lock</a></li>
    <li><a href="/repos/search-api/arch/adr-004-transition-mainstream-to-publishing-api-index.html" rel="noopener" class="govuk-link">Decision record: Transition mainstream formats to a Publishing API derived search index</a></li>
    <li><a href="/repos/search-api/arch/adr-005-incremental-popularity-updates.html" rel="noopener" class="govuk-link">Decision record: Incremental popularity updates</a></li>
    <li><a href="/repos/search-api/arch/adr-006-transition-whitehall-to-publishing-api-index.html" rel="noopener" class="govuk-link">Decision record: Transition whitehall documents to a Publishing API derived search index</a></li>
    <li><a href="/repos/search-api/arch/adr-007-batch-processing-of-rabbit-mq-messages.html" rel="noopener" class="govuk-link">Decision record: Batch processing of rabbit MQ messages</a></li>
    <li><a href="/repos/search-api/arch/adr-008-elasticsearch5-upgrade.html" rel="noopener" class="govuk-link">Decision record: Upgrade to Elasticsearch 5</a></li>
    <li><a href="/repos/search-api/arch/adr-009-elasticsearch6-upgrade.html" rel="noopener" class="govuk-link">Decision record: Upgrade to Elasticsearch 6</a></li>
    <li><a href="/repos/search-api/arch/adr-010-learn-to-rank.html" rel="noopener" class="govuk-link">Decision record: Learning To Rank</a></li>
    <li><a href="/repos/search-api/arch/adr-011-sagemaker.html" rel="noopener" class="govuk-link">Decision record: Sagemaker</a></li>
    <li><a href="/repos/search-api/arch/adr-012-learn-to-rank.html" rel="noopener" class="govuk-link">Decision record: Decommissioning Learning to Rank</a></li>
    <li><a href="/repos/search-api/arch/adr-013-rabbitmq-sidekiq-removal.html" rel="noopener" class="govuk-link">Decision record: Removing Sidekiq from RabbitMQ queue consumers</a></li>

    </ul>

      </ul>
    </li>
  </ul>

              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled" aria-label="Content">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              
<script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "item": {
        "name": "Home",
        "@id": "http://www.dev.gov.uk/"
      }
    },
    {
      "@type": "ListItem",
      "position": 2,
      "item": {
        "name": "Apps",
        "@id": "http://www.dev.gov.uk/apps.html"
      }
    },
    {
      "@type": "ListItem",
      "position": 3,
      "item": {
        "name": "search-api",
        "@id": "http://www.dev.gov.uk/repos/search-api.html"
      }
    }
  ]
}
</script>

<nav data-module="ga4-link-tracker" aria-label="Breadcrumb" class="gem-c-breadcrumbs govuk-breadcrumbs">
  <ol class="govuk-breadcrumbs__list">
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;1&quot;,&quot;index_total&quot;:&quot;3&quot;}" class="govuk-breadcrumbs__link" href="/">Home</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;2&quot;,&quot;index_total&quot;:&quot;3&quot;}" class="govuk-breadcrumbs__link" href="/apps.html">Apps</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;3&quot;,&quot;index_total&quot;:&quot;3&quot;}" class="govuk-breadcrumbs__link" href="/repos/search-api.html">search-api</a>
        </li>
  </ol>
</nav>
  <div class="govuk-!-font-size-16 govuk-!-margin-top-6">
    <div class="govuk-warning-text">
      <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
      <strong class="govuk-warning-text__text">
        <span class="govuk-warning-text__assistive">Warning</span>
        This document has not been updated for a while now. It may be out of date.
      </strong>
    </div>

  Last updated: <a href="https://github.com/alphagov/search-api/commit/89b5433030c582abbb0347b52d1a1600b3879688">9 Jun 2020</a>
</div>

  <h1 class="page-title">search-api: Decision record: Upgrade to Elasticsearch 6</h1>

  
<p><strong>Date:</strong> 2019-10-03</p>
<ol>
<li><a href="#high-level-migration-plan">High-level migration plan</a></li>
<li><a href="#new-cluster-architecture">New cluster architecture</a></li>
<li><a href="#elasticsearch-6-compatibility">Elasticsearch 6 compatibility</a></li>
<li><a href="#connecting-to-multiple-elasticsearch-clusters">Connecting to multiple Elasticsearch clusters</a></li>
<li><a href="#synchronising-the-state">Synchronising the state</a></li>
<li><a href="#data-sync-for-production---staging---integration">Data sync for production -&gt; staging -&gt; integration</a></li>
<li><a href="#ab-testing-elasticsearch-6">A/B testing Elasticsearch 6</a></li>
<li><a href="#decomissioning-elasticsearch-5">Decomissioning Elasticsearch 5</a></li>
</ol>
<p>This work was done over 2019/20 Q1 and Q2.  Most of the changes were
made in this repository.  There were also significant changes in
<a href="https://github.com/alphagov/govuk-aws">govuk-aws</a>, <a href="https://github.com/alphagov/govuk-aws-data">govuk-aws-data</a>, and <a href="https://github.com/alphagov/govuk-puppet">govuk-puppet</a>.</p>
<h2 id="high-level-migration-plan">High-level migration plan</h2>
<p>Based on our experiences <a href="https://github.com/alphagov/search-api/blob/master/docs/arch/adr-008-elasticsearch5-upgrade.md">migrating to Elasticsearch 5</a> we decided
that this time we wanted to isolate the complexity of having two
Elasticsearch clusters to search-api:</p>
<ol>
<li>Make search-api work with both Elasticsearch 5 and Elasticsearch 6.</li>
<li>Give search-api support for multiple Elasticsearch clusters:
<ul>
<li>Index changes into all clusters.</li>
<li>Add a URL parameter to select the cluster to use for a query.</li>
</ul>
</li>
<li>Perform a one-time import of data from Elasticsearch 5 to
Elasticsearch 6, and synchronise any updates missed while this
import was running.</li>
<li>Confirm that the Elasticsearch 5 and Elasticsearch 6 clusters are
consistent.</li>
<li>Set up an A/B test for finder-frontend (etc) to select which
Elasticsearch cluster to use.</li>
<li>Gradually phase from 100% Elasticsearch 5 to 100% Elasticsearch 6.</li>
<li>Retire Elasticsearch 5.</li>
</ol>
<p>The approach we took last time of having both rummager and search-api
running in parallel, necessitated by one being in Carrenza and one in
AWS, led to a lot of changes to govuk-puppet, and didn't really give
us anything reusable.  By adding multi-cluster support to search-api
directly, we do get something reusable.</p>
<h2 id="new-cluster-architecture">New cluster architecture</h2>
<p>Based on our experience of running Elasticsearch 5 for a quarter, we
at first opted for:</p>
<ul>
<li>Three dedicated master nodes, of type <code>c4.large.elasticsearch</code>.</li>
<li>Six data nodes, of type <code>r4.large.elasticsearch</code>.</li>
</ul>
<p>We found the data nodes were not powerful enough, and switched to
<code>r4.xlarge.elasticsearch</code>.  After talking to an AWS Solutions
Architect, we changed again to <code>r5.xlarge.elasticsearch</code>.  Due to
wider GOV.UK scaling concerns caused by political activity, we
increased the data nodes to <code>r5.2xlarge.elasticsearch</code>.</p>
<p>We also shrunk the cluster in staging (to below production size), as
it does not need to cope with the indexing load.  The final cluster
sizes are:</p>
<table>
<thead>
<tr>
<th>Environment</th>
<th>Master</th>
<th>Data</th>
</tr>
</thead>
<tbody>
<tr>
<td>Production</td>
<td>3x <code>c4.large.elasticsearch</code>
</td>
<td>6x <code>r5.2xlarge.elasticsearch</code>
</td>
</tr>
<tr>
<td>Staging</td>
<td>3x <code>c4.large.elasticsearch</code>
</td>
<td>3x <code>r5.2xlarge.elasticsearch</code>
</td>
</tr>
<tr>
<td>Integration</td>
<td>3x <code>t2.medium.elasticsearch</code>
</td>
<td>3x <code>r5.large.elasticsearch</code>
</td>
</tr>
</tbody>
</table>
<p>The cluster is configured in the <a href="https://github.com/alphagov/govuk-aws/tree/master/terraform/projects/app-elasticsearch6">app-elasticsearch6</a> Terraform
project.</p>
<h2 id="elasticsearch-6-compatibility">Elasticsearch 6 compatibility</h2>
<p>We used deprecation messages from Elasticsearch 5 and error messages
from Elasticsearch 6 to figure out what needed to change.  There were
some changes needed to the indices and some to the queries.</p>
<p>Index changes were:</p>
<ul>
<li>Switching from <code>string</code> fields to <code>text</code> and <code>keyword</code> fields (<a href="https://github.com/alphagov/search-api/pull/1553">PR #1553</a>).</li>
<li>Removing the use of the <code>_all</code> field and <code>include_in_all</code> (<a href="https://github.com/alphagov/search-api/pull/1557">PR #1557</a>).</li>
</ul>
<p>Query changes were:</p>
<ul>
<li>Using <code>like</code> instead of <code>docs</code> in the <code>more_like_this</code> query (<a href="https://github.com/alphagov/search-api/pull/1561">PR #1561</a>).</li>
<li>Replacing <code>match: { type: phrase }</code> with <code>match_phrase</code> queries (<a href="https://github.com/alphagov/search-api/pull/1564">PR #1564</a>).</li>
<li>Replacing <code>indices</code> query with a <code>should</code> query (<a href="https://github.com/alphagov/search-api/pull/1568">PR #1568</a>).</li>
</ul>
<p>The <code>indices</code>/<code>should</code> change introduced an inefficiency where query
generation now needs to ask Elasticsearch for the real name of an
alias.  We added a new <code>build_query</code> metric to keep track of this.
<a href="https://github.com/elastic/elasticsearch/issues/23306">Elasticsearch issue #23306</a>, opened in February 2017, is about a
solution to this problem.</p>
<p>We also changed the text similarity metric from <a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.0/index-modules-similarity.html#classic-similarity">classic similarity</a>
to the new <a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.0/index-modules-similarity.html#bm25">BM25 similarity</a>.</p>
<h2 id="connecting-to-multiple-elasticsearch-clusters">Connecting to multiple Elasticsearch clusters</h2>
<p>The <code>elasticsearch.yml</code> file contains a list of clusters.  These
clusters can specify their own schema configuration file, which means
we can try out different index-level settings in a new cluster (for
example, changing the text similarity metric only for Elasticsearch
6).</p>
<p>In the code, the multi-cluster support is implemented in the
<code>SearchConfig</code> and <code>Index::Client</code> classes.  Cluster selection is
implemented in the <code>SearchParameterParser</code> class.</p>
<p>This involved some significant refactoring (<a href="https://github.com/alphagov/search-api/pull/1569">PR #1569</a> and <a href="https://github.com/alphagov/search-api/pull/1604">PR
#1604</a>).</p>
<p>The main architectural decisions made here were:</p>
<ul>
<li>To index writes to all clusters, ensuring cluster consistency.</li>
<li>To perform queries against the default cluster unless a URL
parameter is given, so we can A/B test clusters.</li>
<li>To have one <code>SearchConfig</code> singleton per cluster.</li>
</ul>
<p>This change did result in details of clusters leaking throughout
search-api, which is unfortunate, but that can be addressed in future
refactoring work (for example, passing around <code>SearchConfig</code> instances
rather than asking for cluster singletons).</p>
<h2 id="synchronising-the-state">Synchronising the state</h2>
<p>We planned to either take a snapshot from Elasticsearch 5 and restore
it to Elasticsearch 6, or to use the same approach as the last upgrade
(a script to copy the data across), but these turned out to be
unnecessary.</p>
<p>We had search-api running with both clusters for a couple of weeks
before we started to think about synchronising the data, and by that
time everything had been republished (either directly or as a result
of dependency resolution) and so the <code>govuk</code>, <code>government</code>, and
<code>detailed</code> indices were consistent with Elasticsearch 5.</p>
<p>The <code>page-traffic</code> index was also handled in the multi-cluster work,
with traffic data being saved to all clusters.</p>
<p>The only index which needed some manual work was <code>metasearch</code>, which
holds best bets.  Attempting to republish these from <a href="https://github.com/alphagov/search-admin">search-admin</a>
kept failing due to transient network issues, and getting all of the
best bets seemed impossible.  So for the <code>metasearch</code> index we used
this script:</p>
<pre lang="python"><code>from elasticsearch5 import Elasticsearch as Elasticsearch5, TransportError as TransportError5
from elasticsearch6 import Elasticsearch as Elasticsearch6, TransportError as TransportError6
from elasticsearch6.helpers import bulk
from datetime import datetime
import os

INDEX = 'metasearch'
GENERIC_DOC_TYPE = 'generic-document'

ES5_HOST_PORT = os.getenv('ES5_ORIGIN_HOST', 'http://elasticsearch5:80')
ES6_TARGET_PORT = os.getenv('ES6_TARGET_HOST', 'http://elasticsearch6:80')

es_client5 = Elasticsearch5([ES5_HOST_PORT])
es_client6 = Elasticsearch6([ES6_TARGET_PORT])


def _prepare_docs_for_bulk_insert(docs):
    for doc in docs:
        yield {
            "_id": doc['_id'],
            "_source": doc['_source'],
        }

def bulk_index_documents_to_es6(documents):
    try:
        bulk(
            es_client6,
            _prepare_docs_for_bulk_insert(documents),
            index=INDEX,
            doc_type=GENERIC_DOC_TYPE,
            chunk_size=100
        )
    except TransportError6 as e:
        print("Failed to index documents: %s", str(e))


def fetch_documents(from_=0, page_size=100, scroll_id=None):
    try:
        if scroll_id is None:
            results = es_client5.search(INDEX, GENERIC_DOC_TYPE, from_=from_, size=page_size, scroll='2m')
            scroll_id = results['_scroll_id']
        else:
            results = es_client5.scroll(scroll_id=scroll_id, scroll='2m')
        docs = results['hits']['hits']
        return (scroll_id, docs)
    except TransportError5 as e:
        print("Failed to fetch documents: %s", str(e))
        return str(e), e.status_code


if __name__ == '__main__':
    start = datetime.now()

    dcount = es_client5.count(index=INDEX, doc_type=GENERIC_DOC_TYPE)['count']

    print('Preparing to index {} document(s) from ES5'.format(dcount))

    offset = 0
    page_size = 250
    scroll_id = None
    while offset &lt;= dcount:
        scroll_id, docs = fetch_documents(from_=offset, page_size=page_size, scroll_id=scroll_id)

        print('Indexing documents {} to {} into ES6'.format(offset, offset+page_size))
        bulk_index_documents_to_es6(docs)

        offset += page_size

    print('Finished in {} seconds'.format(datetime.now() - start))
</code></pre>
<h2 id="data-sync-for-production-staging-integration">Data sync for production -&gt; staging -&gt; integration</h2>
<p>This was done in the same way <a href="https://github.com/alphagov/search-api/blob/master/docs/arch/adr-008-elasticsearch5-upgrade.md">as for Elasticsearch 5</a>.</p>
<p>The data sync script needed to be modified to allow for a different
host to be used (<code>http://elasticsearch6</code> vs <code>http://elasticsearch5</code>)
but otherwise this was just a matter of writing some more
configuration.</p>
<h2 id="ab-testing-elasticsearch-6">A/B testing Elasticsearch 6</h2>
<p>The A/B test was set up like so:</p>
<ol>
<li>Configuration in govuk-cdn-config.</li>
<li>Logic in finder-frontend to pass one of two URL parameters to
search-api, based on the CDN-level A/B test.</li>
<li>Logic in search-api to choose a cluster based on the parameter from
finder-frontend.</li>
</ol>
<p>The general A/B test process <a href="https://docs.publishing.service.gov.uk/manual/run-ab-test.html">is covered in the dev docs</a>.</p>
<p>For the A/B test we monitored click-through rate, proportion of search
refinements, and proportion of search exits.  The test revealed a
significant degradation in our metrics compared with Elasticsearch 5,
and we were unable to proceed with the switch without doing work to
improve the search results.</p>
<p>The two main changes in Elasticsearch 6 which impacted search result
quality were:</p>
<ul>
<li>
<p>Switching from classic similarity to <a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.0/index-modules-similarity.html#bm25">BM25 similarity</a>.  This
issue arose with Elasticsearch 5, but we decided to go ahead with
the new similarity when moving to Elasticsearch 6.</p>
</li>
<li>
<p>The removal of query coordination factors, affecting the scoring of
multi-clause <code>should</code> and <code>must</code> queries.  This meant that even if
we switched back to classic similarity, we wouldn't get the same
results we had with Elasticsearch 5.</p>
</li>
</ul>
<p>With query coordination factors, multi-clause <code>should</code> and <code>must</code>
queries are scored as:</p>
<pre><code>sum(clause scores) * num(matching clauses) / num(clauses)
</code></pre>
<p>So if a query has 7 clauses and 2 of them match, the overall score is
multipled by 2/7.  The effect of this is to make documents which match
multiple clauses tend to rank higher than documents which match fewer
clauses, even if those fewer clauses are matched really well.  The
assumption is that the number of matching clauses is an important
predictor of relevance.</p>
<p>Without query coordination factors, the query is scored as:</p>
<pre><code>sum(clause scores)
</code></pre>
<p>Figuring out how to improve the search query was not a
straightforward, or particularly systematic, process.</p>
<p>Our Elasticsearch 5 query is:</p>
<pre lang="ruby"><code>{
  bool: {
    should: [
      match_phrase("title", query),
      match_phrase("acronym", query),
      match_phrase("description", query),
      match_phrase("indexable_content", query),
      match_all_terms(%w(title acronym description indexable_content), query),
      match_any_terms(%w(title acronym description indexable_content), query),
      minimum_should_match("all_searchable_text", query)
    ],
  }
}
</code></pre>
<p>And the Elasticsearch 6 query we settled on is:</p>
<pre lang="ruby"><code>should_coord_query([
  match_all_terms(%w(title), query, MATCH_ALL_TITLE_BOOST),
  match_all_terms(%w(acronym), query, MATCH_ALL_ACRONYM_BOOST),
  match_all_terms(%w(description), query, MATCH_ALL_DESCRIPTION_BOOST),
  match_all_terms(%w(indexable_content), query, MATCH_ALL_INDEXABLE_CONTENT_BOOST),
  match_all_terms(%w(title acronym description indexable_content), query, MATCH_ALL_MULTI_BOOST),
  match_any_terms(%w(title acronym description indexable_content), query, MATCH_ANY_MULTI_BOOST),
  minimum_should_match("all_searchable_text", query, MATCH_MINIMUM_BOOST)
])
</code></pre>
<p>Here <code>should_coord_query</code> is <a href="https://github.com/alphagov/search-api/blob/df38c7ecc2af5e2c21d12096d10aca79ce900310/lib/search/query_helpers.rb#L62-L84">a reimplementation of the query
coordination factor-based scoring</a>, using a <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-function-score-query.html">function_score</a>
query.  We also changed the <code>match_phrase</code> clauses in the
Elasticsearch 5 query to <code>match_all_terms</code> clauses, and adjusted the
field boosting factors.</p>
<p>We then ran the A/B test again, and found that the Elasticsearch 6
with the new query had a clickthrough rate within 3 percentage points
of Elasticsearch 5 with the old query, and decided that this was good
enough to go ahead with the switch.</p>
<h2 id="decomissioning-elasticsearch-5">Decomissioning Elasticsearch 5</h2>
<p>The steps we followed to switch to Elasticsearch 6 permanently and to
decomission Elasticsearch 5 were:</p>
<ol>
<li>Switch search-api to the B variant of the A/B test and disable the A cluster so no more indexing is done (<a href="https://github.com/alphagov/search-api/pull/1713">PR #1713</a>).</li>
<li>Disable the A/B test in govuk-cdn-config (<a href="https://github.com/alphagov/govuk-cdn-config/pull/203">PR #203</a>) and finder-frontend (<a href="https://github.com/alphagov/finder-frontend/pull/1611">PR #1611</a>).</li>
<li>Remove Elasticsearch 5 configuration from govuk-puppet (<a href="https://github.com/alphagov/govuk-puppet/pull/9643">PR #9643</a>).</li>
<li>Remove Elasticsearch 5 from govuk-aws (<a href="https://github.com/alphagov/govuk-aws/pull/1123">PR #1123</a>).</li>
</ol>
<p>We didn't want to be permanently using the "B" configuration, which
required some care to change:</p>
<ol>
<li>Set the <code>ELASTICSEARCH_URI</code> environment variable to the same value as the <code>ELASTICSEARCH_B_URI</code> environment variable in govuk-puppet (<a href="https://github.com/alphagov/govuk-puppet/pull/9648">PR #9648</a>).</li>
<li>Swap out the "B" cluster configuration for the "A" cluster configuration (<a href="https://github.com/alphagov/search-api/pull/1718">PR #1718</a>).</li>
<li>Unset the <code>ELASTICSEARCH_B_URI</code> environment variable in govuk-puppet (<a href="https://github.com/alphagov/govuk-puppet/pull/9649">PR #9649</a>).</li>
</ol>
<p>This approach avoided the need to coordinate simultaneous deploys of
search-api and govuk-puppet.</p>

  <script>
    /*
      Manually trigger the styling of the 'current page' in the sidebar,
      as it does not happen automatically because we are still technically
      in single page mode.
    */
    (function () {
        'use strict'
        /*
          Cannot use `$(document).ready` on next line as jQuery has not loaded
          yet. But we can use jQuery in the callback.
        */
        window.addEventListener('load', function () {
            try {
                new GOVUK.Modules.InPageNavigation().start($("html"));
            }
            catch (error) {
                /* Fail without causing other JS in the page to break */
                console.log("Error calling GOVUK's InPageNavigation module", error);
            }
        })
    }());
</script>


            
          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/search-api/blob/main/docs/arch/adr-009-elasticsearch6-upgrade.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?body=Problem+with+%27%27+%28https%3A%2F%2Fdocs.publishing.service.gov.uk%2Frepos%2Fsearch-api%2Farch%2Fadr-009-elasticsearch6-upgrade.html%29&amp;labels=bug&amp;title=Re%3A+%27%27">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <svg focusable="false" role="presentation" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 60" height="30" width="32" fill="currentcolor" class="govuk-footer__crown">
    <g>
      <circle cx="20" cy="17.6" r="3.7"></circle>
      <circle cx="10.2" cy="23.5" r="3.7"></circle>
      <circle cx="3.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <circle cx="43.3" cy="17.6" r="3.7"></circle>
      <circle cx="53.2" cy="23.5" r="3.7"></circle>
      <circle cx="59.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
    </g>
  </svg>
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/accessibility.html">Accessibility</a>
            </li>
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/cookies.html">Cookies</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >Â© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/govuk_frontend.js" type="module"></script>
    <script src="/javascripts/application.js"></script>
  </body>
</html>
