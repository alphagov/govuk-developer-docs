

<!doctype html>
<html lang="en" class="govuk-template govuk-template--rebranded no-js">
  <head>
    

    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

    <title>govuk-chat: Message Queue consumption - GOV.UK Developer Documentation</title>

    <link href="/stylesheets/manifest.css" rel="stylesheet" />

    <link rel="canonical" href="https://docs.publishing.service.gov.uk/repos/govuk-chat/message-queue-consumption.html">
      <link rel="icon" sizes="48x48" href="/assets/govuk/assets/rebrand/images/favicon.ico">
      <link rel="icon" sizes="any" href="/assets/govuk/assets/rebrand/images/favicon.svg" type="image/svg+xml">
      <link rel="mask-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-mask.svg" color="#0b0c0c">
      <link rel="apple-touch-icon" href="/assets/govuk/assets/rebrand/images/govuk-icon-180.png">
      <link rel="manifest" href="/assets/govuk/assets/rebrand/manifest.json">

      <meta name="twitter:card" content="summary" />
      <meta name="twitter:domain" content="docs.publishing.service.gov.uk" />
      <meta name="twitter:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta name="twitter:title" content="govuk-chat: Message Queue consumption - GOV.UK Developer Documentation" />
      <meta name="twitter:url" content="https://docs.publishing.service.gov.uk/repos/govuk-chat/message-queue-consumption.html" />

      <meta property="og:image" content="https://docs.publishing.service.gov.uk/assets/govuk/assets/rebrand/images/govuk-opengraph-image.png" />
      <meta property="og:site_name" content="GOV.UK Developer Documentation" />
      <meta property="og:title" content="govuk-chat: Message Queue consumption" />
      <meta property="og:type" content="object" />
      <meta property="og:url" content="https://docs.publishing.service.gov.uk/repos/govuk-chat/message-queue-consumption.html" />

      <script>
  document.addEventListener('DOMContentLoaded', function () {
    var markup = `<div id="global-cookie-message" data-module="cookie-banner" data-nosnippet="" aria-label="Can we store analytics cookies on your device?" class="gem-c-cookie-banner govuk-clearfix govuk-cookie-banner js-banner-wrapper" role="region" hidden="hidden" title="Can we store analytics cookies on your device?"> <div class="govuk-cookie-banner__message govuk-width-container"> <div class="govuk-grid-row"> <div class="govuk-grid-column-two-thirds"> <h2 class="govuk-cookie-banner__heading govuk-heading-m">Can we store analytics cookies on your device?</h2> <div tabindex="-1" class="govuk-cookie-banner__content gem-c-cookie-banner__confirmation"> <div class="gem-c-cookie-banner__content"><p class='govuk-body'>Weâ€™d like to set some cookies to understand how you use this site and remember your settings.</p><p class='govuk-body'>We also use cookies set by other sites to help us deliver content from their services.</p></div> <p class="gem-c-cookie-banner__confirmation-message--accepted govuk-body" hidden data-ga4-cookie-banner data-module="ga4-link-tracker" data-ga4-track-links-only data-ga4-set-indexes data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" >You have accepted additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> <p class="gem-c-cookie-banner__confirmation-message--rejected govuk-body" hidden>You have rejected additional cookies. <span class="gem-c-cookie-banner__confirmation-message">You can <a class="govuk-link" href="/cookies.html">change your cookie settings</a> at any time.</span></p> </div> </div> </div> <div class="js-confirmation-buttons govuk-button-group"> <button class="gem-c-button govuk-button" type="submit" data-accept-cookies="true" data-cookie-types="all">Accept additional cookies</button> <button class="gem-c-button govuk-button" type="submit" data-reject-cookies="true">Reject additional cookies</button> <a class="govuk-link" href="/cookies.html">View cookies</a> </div> <div hidden class="js-hide-button govuk-button-group"> <button class="gem-c-cookie-banner__hide-button govuk-button" data-hide-cookie-banner="true" data-module="ga4-event-tracker" data-ga4-event="{&quot;event_name&quot;:&quot;select_content&quot;,&quot;type&quot;:&quot;cookie banner&quot;,&quot;action&quot;:&quot;closed&quot;,&quot;section&quot;:&quot;You have accepted additional cookies&quot;}" > Hide cookie message </button> </div> </div> </div>`;
    var banner = document.createElement('div');
    banner.innerHTML = markup;
    document.body.prepend(banner);
  })
</script>


  </head>

  <body class="govuk-template__body">
    <script>document.body.className += ' js-enabled' + ('noModule' in HTMLScriptElement.prototype ? ' govuk-frontend-supported' : '');</script>

    <div class="app-pane">
      <div class="app-pane__header toc-open-disabled">
        <a href="#content" class="govuk-skip-link" data-module="govuk-skip-link">Skip to main content</a>

        <header class="govuk-header app-header" role="banner" data-module="govuk-header">
  <div class="govuk-header__container govuk-header__container--full-width">
    <div class="govuk-header__logo">
      <a href="/" class="govuk-header__link govuk-header__link--homepage">
        <svg
          focusable="false"
          role="img"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 324 60"
          height="30"
          width="162"
          fill="currentcolor"
          class="govuk-header__logotype"
          aria-label="GOV.UK">
          <title>GOV.UK</title>
          <g>
            <circle cx="20" cy="17.6" r="3.7"></circle>
            <circle cx="10.2" cy="23.5" r="3.7"></circle>
            <circle cx="3.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <circle cx="43.3" cy="17.6" r="3.7"></circle>
            <circle cx="53.2" cy="23.5" r="3.7"></circle>
            <circle cx="59.7" cy="33.2" r="3.7"></circle>
            <circle cx="31.7" cy="30.6" r="3.7"></circle>
            <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
          </g>
          <circle class="govuk-logo-dot" cx="226" cy="36" r="7.3"/>
          <path d="M93.94 41.25c.4 1.81 1.2 3.21 2.21 4.62 1 1.4 2.21 2.41 3.61 3.21s3.21 1.2 5.22 1.2 3.61-.4 4.82-1c1.4-.6 2.41-1.4 3.21-2.41.8-1 1.4-2.01 1.61-3.01s.4-2.01.4-3.01v.14h-10.86v-7.02h20.07v24.08h-8.03v-5.56c-.6.8-1.38 1.61-2.19 2.41-.8.8-1.81 1.2-2.81 1.81-1 .4-2.21.8-3.41 1.2s-2.41.4-3.81.4a18.56 18.56 0 0 1-14.65-6.63c-1.6-2.01-3.01-4.41-3.81-7.02s-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83a20.45 20.45 0 0 1 19.46-13.65c3.21 0 4.01.2 5.82.8 1.81.4 3.61 1.2 5.02 2.01 1.61.8 2.81 2.01 4.01 3.21s2.21 2.61 2.81 4.21l-7.63 4.41c-.4-1-1-1.81-1.61-2.61-.6-.8-1.4-1.4-2.21-2.01-.8-.6-1.81-1-2.81-1.4-1-.4-2.21-.4-3.61-.4-2.01 0-3.81.4-5.22 1.2-1.4.8-2.61 1.81-3.61 3.21s-1.61 2.81-2.21 4.62c-.4 1.81-.6 3.71-.6 5.42s.8 5.22.8 5.22Zm57.8-27.9c3.21 0 6.22.6 8.63 1.81 2.41 1.2 4.82 2.81 6.62 4.82S170.2 24.39 171 27s1.4 5.62 1.4 8.83-.4 6.02-1.4 8.83-2.41 5.02-4.01 7.02-4.01 3.61-6.62 4.82-5.42 1.81-8.63 1.81-6.22-.6-8.63-1.81-4.82-2.81-6.42-4.82-3.21-4.41-4.01-7.02-1.4-5.62-1.4-8.83.4-6.02 1.4-8.83 2.41-5.02 4.01-7.02 4.01-3.61 6.42-4.82 5.42-1.81 8.63-1.81Zm0 36.73c1.81 0 3.61-.4 5.02-1s2.61-1.81 3.61-3.01 1.81-2.81 2.21-4.41c.4-1.81.8-3.61.8-5.62 0-2.21-.2-4.21-.8-6.02s-1.2-3.21-2.21-4.62c-1-1.2-2.21-2.21-3.61-3.01s-3.21-1-5.02-1-3.61.4-5.02 1c-1.4.8-2.61 1.81-3.61 3.01s-1.81 2.81-2.21 4.62c-.4 1.81-.8 3.61-.8 5.62 0 2.41.2 4.21.8 6.02.4 1.81 1.2 3.21 2.21 4.41s2.21 2.21 3.61 3.01c1.4.8 3.21 1 5.02 1Zm36.32 7.96-12.24-44.15h9.83l8.43 32.77h.4l8.23-32.77h9.83L200.3 58.04h-12.24Zm74.14-7.96c2.18 0 3.51-.6 3.51-.6 1.2-.6 2.01-1 2.81-1.81s1.4-1.81 1.81-2.81a13 13 0 0 0 .8-4.01V13.9h8.63v28.15c0 2.41-.4 4.62-1.4 6.62-.8 2.01-2.21 3.61-3.61 5.02s-3.41 2.41-5.62 3.21-4.62 1.2-7.02 1.2-5.02-.4-7.02-1.2c-2.21-.8-4.01-1.81-5.62-3.21s-2.81-3.01-3.61-5.02-1.4-4.21-1.4-6.62V13.9h8.63v26.95c0 1.61.2 3.01.8 4.01.4 1.2 1.2 2.21 2.01 2.81.8.8 1.81 1.4 2.81 1.81 0 0 1.34.6 3.51.6Zm34.22-36.18v18.92l15.65-18.92h10.82l-15.03 17.32 16.03 26.83h-10.21l-11.44-20.21-5.62 6.22v13.99h-8.83V13.9"/>
        </svg>
        <span class="govuk-header__product-name">
          Developer docs
        </span>
      </a>
    </div>
    <div class="govuk-header__content">
      <nav class="govuk-header__navigation govuk-header__navigation--end" aria-label="Menu">
        <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" hidden>Menu</button>
        <ul id="navigation" class="govuk-header__navigation-list">
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual/get-started.html">Get started</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/manual.html">Manual</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/kubernetes/">Kubernetes</a>
            </li>
            <li class="govuk-header__navigation-item govuk-header__navigation-item--active">
              <a class="govuk-header__link" href="/apps.html" aria-current="page">Apps</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/repos.html">Repos</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/mobile/">Mobile</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/content-schemas.html">Schemas</a>
            </li>
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/document-types.html">Document types</a>
            </li>
        </ul>
      </nav>
    </div>
  </div>
</header>

      </div>

        <div id="toc-heading" class="toc-show fixedsticky">
          <button type="button" class="toc-show__label js-toc-show" aria-controls="toc">
            Table of contents <span class="toc-show__icon"></span>
          </button>
        </div>

      <div class="app-pane__body">
          <div class="app-pane__toc">
            <div class="toc" data-module="table-of-contents" tabindex="-1">
              <div class="search" data-module="search" data-path-to-site-root="/">
  <form action="https://www.google.co.uk/search" method="get" role="search" class="search__form govuk-!-margin-bottom-4">
    <input type="hidden" name="as_sitesearch" value="https://docs.publishing.service.gov.uk"/>
    <label class="govuk-label search__label" for="search">
      Search (via Google)
    </label>
    <input
      type="search"
      id="search" name="q"
      class="govuk-input govuk-!-margin-bottom-0 search__input"
      aria-controls="search-results"
      placeholder="Search">
    <button type="submit" class="search__button">Search</button>
  </form>
</div>

              <button type="button" class="toc__close js-toc-close" aria-controls="toc" aria-label="Hide table of contents"></button>
              <nav id="toc" class="js-toc-list toc__list" aria-labelledby="toc-heading">
                  <ul>
    <li>
      <a href="/repos/govuk-chat.html" rel="noopener" class="govuk-link">govuk-chat</a>
    </li>
    <li>
      <ul>
            <li><a href="/repos/govuk-chat/deleting-opted-out-end-user-data-in-bigquery.html" rel="noopener" class="govuk-link">Deleting opted-out end user data in BigQuery</a></li>
    <li><a href="/repos/govuk-chat/guardrails.html" rel="noopener" class="govuk-link">GOV.UK Chat Guardrails</a></li>
    <li><a href="/repos/govuk-chat/manual-build-of-chat-opensearch-cluster.html" rel="noopener" class="govuk-link">Manual Build of Chat Opensearch Cluster</a></li>
    <li><a href="/repos/govuk-chat/message-queue-consumption.html" rel="noopener" class="govuk-link">Message Queue consumption</a></li>
    <li><a href="/repos/govuk-chat/populating-search.html" rel="noopener" class="govuk-link">Populating OpenSearch</a></li>
    <li class="subdir__heading">adr</li>
    <ul class="subdir__menu">
          <li><a href="/repos/govuk-chat/adr/0001-pilot-technical-architecture.html" rel="noopener" class="govuk-link">1. Pilot Technical Architecture</a></li>
    <li><a href="/repos/govuk-chat/adr/0002-openai-rate-limit-handling.html" rel="noopener" class="govuk-link">0002. Handling OpenAI Rate Limits within the GOV.UK Chat Application</a></li>
    <li><a href="/repos/govuk-chat/adr/0003-output-guardrails.html" rel="noopener" class="govuk-link">3. Output guardrails</a></li>
    <li><a href="/repos/govuk-chat/adr/0004-open-sourcing-govuk-chat.html" rel="noopener" class="govuk-link">4. Open sourcing GOV.UK Chat</a></li>
    <li><a href="/repos/govuk-chat/adr/0005-test-opensearch-cluster.html" rel="noopener" class="govuk-link">5. Test Opensearch Cluster</a></li>
    <li><a href="/repos/govuk-chat/adr/0006-suitability-of-using-search-api-v2-for-retrieval.html" rel="noopener" class="govuk-link">6. Suitability of using Search API V2 for retrieval</a></li>
    <li><a href="/repos/govuk-chat/adr/0007-serialisation-and-schema-validation-for-govuk-chat-api.html" rel="noopener" class="govuk-link">7. Serialisation and Schema Validation for GOV.UK Chat API</a></li>
    <li><a href="/repos/govuk-chat/adr/0008-use-anthropic-sdk-for-anthropic-model-invocations.html" rel="noopener" class="govuk-link">8. Use Anthropic SDK for Anthropic models</a></li>

    </ul>

      </ul>
    </li>
  </ul>

              </nav>
            </div>
          </div>

        <div class="app-pane__content toc-open-disabled" aria-label="Content">
          <main id="content" class="technical-documentation" data-module="anchored-headings">
              
<script type="application/ld+json">
  {
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "item": {
        "name": "Home",
        "@id": "http://www.dev.gov.uk/"
      }
    },
    {
      "@type": "ListItem",
      "position": 2,
      "item": {
        "name": "Apps",
        "@id": "http://www.dev.gov.uk/apps.html"
      }
    },
    {
      "@type": "ListItem",
      "position": 3,
      "item": {
        "name": "govuk-chat",
        "@id": "http://www.dev.gov.uk/repos/govuk-chat.html"
      }
    }
  ]
}
</script>

<nav data-module="ga4-link-tracker" aria-label="Breadcrumb" class="gem-c-breadcrumbs govuk-breadcrumbs">
  <ol class="govuk-breadcrumbs__list">
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;1&quot;,&quot;index_total&quot;:&quot;3&quot;}" class="govuk-breadcrumbs__link" href="/">Home</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;2&quot;,&quot;index_total&quot;:&quot;3&quot;}" class="govuk-breadcrumbs__link" href="/apps.html">Apps</a>
        </li>
        <li class="govuk-breadcrumbs__list-item">
          <a data-ga4-link="{&quot;event_name&quot;:&quot;navigation&quot;,&quot;type&quot;:&quot;breadcrumb&quot;,&quot;index_link&quot;:&quot;3&quot;,&quot;index_total&quot;:&quot;3&quot;}" class="govuk-breadcrumbs__link" href="/repos/govuk-chat.html">govuk-chat</a>
        </li>
  </ol>
</nav>
  <div class="govuk-!-font-size-16 govuk-!-margin-top-6">
    <div class="govuk-warning-text">
      <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
      <strong class="govuk-warning-text__text">
        <span class="govuk-warning-text__assistive">Warning</span>
        This document has not been updated for a while now. It may be out of date.
      </strong>
    </div>

  Last updated: <a href="https://github.com/alphagov/govuk-chat/commit/274c12a8243b9cd885da950032f1849ed0a734e4">6 Sep 2024</a>
</div>

  <h1 class="page-title">govuk-chat: Message Queue consumption</h1>

  
<p>GOV.UK Chat stores a search index of GOV.UK content which is populated by consuming the <a href="https://github.com/alphagov/publishing-api/blob/main/docs/rabbitmq.md">Publishing API <code>published_documents</code> message queue</a>. This search index provides access to relevant GOV.UK Content in order to answer users' questions.</p>
<h2 id="how-it-works">How it works</h2>
<p>Whenever the GOV.UK Publishing API pushes a content change to the Content Store it emits an event to a message broker, the <code>published_documents</code> exchange, with a JSON representation of the Content Item. This exchange broadcasts these messages to a queue which this application listens to.</p>
<p>When receiving a message from this queue, this application will create a distributed lock based on the <code>base_path</code> of the Content Item received (to ensure two pieces of content at the same GOV.UK location are not being indexed concurrently as they will try delete each other's data) and it will check whether there is already an indexed document that is newer and uses the same <code>base_path</code> (to prevent old messages invalidating current data).</p>
<p>Once it is established that the message is not out of date, this application will then synchronise the data from the Content Item with the search index. Synchronising the content involves establishing whether the Content Item is in a supported schema, is in English and in a supported state (for example not withdrawn) - if these pre-conditions are not met any indexed content for the <code>base_path</code> is deleted. When these conditions are met the search index is updated.</p>
<p>Updating the search index involves decomposing the HTML from the Content Item into a number of smaller subsets of HTML that are organised around the HTML header structure (H2 - H6 elements). Once a collection of chunks has been established for a Content Item these will be compared with what is already in the search index to avoid updating items that have not changed. Adding and updating items involves creating an <a href="https://platform.openai.com/docs/guides/embeddings">embedding</a> representation of the indexable content, this embedding will be used as part of searching for content using a <a href="https://en.wikipedia.org/wiki/K-nearest_neighbors_algorithm">k-nearest neighbour</a> semantic search.</p>
<p>Should an exception occur during the processing of a message then the behaviour of the handling will depend on whether the exception is anticipated or not. For anticipated exceptions the message is marked for retry and pushed back to the queue to be reattempted. For an exception type that was not anticipated the message is discarded and not retried - this is because it is expected that this represents a scenario where a developer needs to fix the code and that retrying the message would not be beneficial due to the extended time frame for a fix.</p>
<h2 id="starting-the-queue-consumer">Starting the queue consumer</h2>
<p>The queue consumer is started by a rake task:</p>
<pre><code>rake message_queue:published_documents_consumer
</code></pre>
<p>You can run it in GOV.UK Docker for development. You'll have to create the queue first:</p>
<pre><code>govuk-docker-run bundle exec rake message_queue:create_published_documents_queue
</code></pre>
<p>and then start it with:</p>
<pre><code>govuk-docker-up queue-consumer
</code></pre>
<h2 id="bulk-indexing-all-gov-uk-content">Bulk indexing all GOV.UK content</h2>
<p>You will want to follow these steps in one of two situations:</p>
<ol>
<li>you've setup the queue consumer and Opensearch index and want to populate the index for the first time</li>
<li>you're reindexing and need to bulk requeue documents to populate the new fields</li>
</ol>
<p><strong>Note: This will take a significant amount of time as it will requeue each live document on GOV.UK (as of 2/7/2024 close to 1 million) to the message queue.</strong></p>
<p>Prior to running the rake task to queue the documents you should ensure that you have the necessary monitoring setup so that you have good visibiity
of the process. You should use:</p>
<p><strong>Note: These links are for production. If you're bulk indexing another environment you will need to update the environemnt in the urls accordingly</strong></p>
<ul>
<li>
<a href="https://grafana.eks.production.govuk.digital/d/sidekiq-queues/sidekiq3a-queue-length-max-delay?orgId=1&amp;var-namespace=apps&amp;var-app=publishing-api-worker">Sidekiq</a> to monitor the queue length
on Publishing API</li>
<li>
<a href="https://govuk.sentry.io/issues/?environment=production&amp;project=4507072589070336&amp;statsPeriod=14d">Sentry</a> to check any errors that might occur during the process</li>
<li>
<a href="https://docs.publishing.service.gov.uk/manual/amazonmq.html">RabbitMQ web control panel</a> to view the queue length. Once the RabbitMQ HTTPS port has been forwarded to your local machine you can visit <a href="https://localhost:4430/#/queues/publishing/govuk_chat_published_documents">https://localhost:4430/#/queues/publishing/govuk_chat_published_documents</a> to view the dashboard for the <code>govuk_chat_published_documents</code> queue</li>
<li>
<a href="https://argo.eks.production.govuk.digital/applications/govuk-chat?orphaned=false&amp;resource=">Argo CD</a> or <a href="https://dashboard.logit.io/a/1c6b2316-16e2-4ca5-a3df-ff18631b0e74">Logit</a> for application logs.</li>
</ul>
<p>Once you're confident you have sufficient monitoring in place you can run the following <a href="https://github.com/alphagov/publishing-api/blob/main/lib/tasks/queue.rake#L41-L52">rake task</a> from Publishing API.</p>
<pre lang="bash"><code>rake queue:requeue_all_the_things["bulk.govuk_chat_sync"]
</code></pre>
<p>You can check the count of documents in the index to confirm that documents are being indexed with the following code from <a href="https://docs.publishing.service.gov.uk/kubernetes/cheatsheet.html#open-a-rails-console">Rails console</a> in govuk-chat:</p>
<pre lang="bash"><code>r = Search::ChunkedContentRepository.new
r.client.count(index: r.index)
</code></pre>
<h2 id="consuming-queues-in-a-development-environment">Consuming queues in a development environment</h2>
<p>It can take a long time to index all GOV.UK content, so just indexing the subset of content from Mainstream Publisher is recommended.</p>
<p>The process to do this with GOV.UK Docker is:</p>
<ol>
<li>
<a href="https://github.com/alphagov/govuk-docker/blob/main/docs/how-tos.md#how-to-replicate-data-locally">Replicate the Publishing API Data</a> to GOV.UK Docker</li>
<li>Start a process to run the Publishing API Sidekiq worker in GOV.UK Docker with <code>govuk-docker up publishing-api-worker</code>
</li>
<li>Create a new terminal window and start the queue consumer process with <code>govuk-docker up govuk-chat-queue-consumer</code>
</li>
<li>Create a new terminal window and navigate to the Publishing API directory, <code>cd ~/govuk/publishing-api</code>
</li>
<li>Open a Rails console for the Publishing API <code>govuk-docker-run bundle exec rails console</code>
</li>
<li>To queue just content from Mainstream Publisher: <code>RequeueContentByScope.new(Edition.live.where(publishing_app: "publisher"), action: "bulk.govuk_chat_sync").call</code>
</li>
</ol>
<p>You can check on the progress of the queue consumption by following the Rails log file for GOV.UK Chat <code>tail -f logs/development.log</code>.</p>
<h2 id="adding-a-new-schema-for-indexing">Adding a new schema for indexing</h2>
<p>For a schema to be supported by GOV.UK Chat it needs to be registered with a corresponding Parser class. These are registered in <a href="https://github.com/alphagov/govuk-chat/blob/main/lib/chunking/content_item_to_chunks.rb"><code>Chunking::ContentItemToChunks::PARSERS_FOR_SCHEMAS</code></a>. The Parser class has the responsibility of converting the Content Item into a number of chunks.</p>
<p>To add a new schema you will have to establish what HTML from the Content Item is appropriate to be indexed into search for GOV.UK Chat. If there isn't any, then it probably shouldn't be added.</p>
<p>Lots of GOV.UK Content have only one field that needs to be indexed <code>details-&gt;body</code>.</p>
<p>The publishing API has 2 different formats for the body - you need to check <a href="https://docs.publishing.service.gov.uk/content-schemas/help_page.html#publisher-content-schema">the publisher content schema</a></p>
<p>If <code>body</code> is a string we have a parser class already for this field (<a href="https://github.com/alphagov/govuk-chat/blob/main/lib/chunking/content_item_parsing/body_content_parser.rb"><code>BodyContentParser</code></a>) so to add an additional schema that only uses this field then we just need to add the schema name to the list of schemas already supported for this parser.</p>
<p>If <code>body</code>  is an array with markdown and html versions - use <a href="https://github.com/alphagov/govuk-chat/blob/main/lib/chunking/content_item_parsing/body_content_array_parser.rb"><code>BodyContentArrayParser</code></a></p>
<p>If you have a schema that has HTML in different fields you'll need to create a new parser class in the <a href="https://github.com/alphagov/govuk-chat/blob/main/lib/chunking/content_item_parsing/"><code>Chunking::ContentItemParsing</code></a> namespace, which inherits from <a href="https://github.com/alphagov/govuk-chat/blob/main/lib/chunking/content_item_parsing/base_parser.rb"><code>Chunking::ContentItemParsing::BaseParser</code></a>. This parser will need to implement a <code>.call</code> method and the class will need to concatenate the HTML together before calling the <code>build_chunks</code> method to convert that HTML into chunks. An example of this can be seen in <a href="https://github.com/alphagov/govuk-chat/blob/main/lib/chunking/content_item_parsing/transaction_parser.rb"><code>Chunking::ContentItemParsing::TransactionParser</code></a>.</p>
<p>If you have a more complex schema that needs to have granular control of the chunks that are created (for example content that has parts which have different URLs) then you'll have to write more code. An example of this type of complex schema handling is <a href="https://github.com/alphagov/govuk-chat/blob/main/lib/chunking/content_item_parsing/guide_parser.rb"><code>Chunking::ContentItemParsing::GuideParser</code></a>.</p>
<h2 id="known-issues">Known issues</h2>
<ul>
<li>The message queue consumer process is single process and single threaded so a single process can only consumer one message at a time. Run multiple processes for concurrency.</li>
<li>There isn't any guarantee that messages are received in a particular order from the Publishing API message queue, so message metadata has to be relied on for integrity.</li>
<li>There isn't a mechanism to support only a subset of the document types of a schema being indexed, should this be needed it should be trivial to add.</li>
<li>It is possible that a race condition could occur if a scenario occurs where two Content Items are indexed simultaneously and both have the same <code>content_id</code> and <code>locale</code> values but different values for <code>base_path</code>. Should this prove an issue in practice we will need to use a <a href="https://github.com/alphagov/govuk-chat/commit/01358a0749ca6f67e371a17602d0cc10c2ab3d34">non-deterministic id for search indexing</a>.</li>
<li>The retry mechanism for messages is simplistic, items are just re-added to the queue and retried as soon as they are reached again in the queue. This could lead to frequently experiencing the same error.</li>
<li>We aspire to have only exceptions reported to Sentry that represent something a developer needs to fix and not any transient errors. However until we establish what are common transient errors we are reporting all errors to Sentry.</li>
</ul>

  <script>
    /*
      Manually trigger the styling of the 'current page' in the sidebar,
      as it does not happen automatically because we are still technically
      in single page mode.
    */
    (function () {
        'use strict'
        /*
          Cannot use `$(document).ready` on next line as jQuery has not loaded
          yet. But we can use jQuery in the callback.
        */
        window.addEventListener('load', function () {
            try {
                new GOVUK.Modules.InPageNavigation().start($("html"));
            }
            catch (error) {
                /* Fail without causing other JS in the page to break */
                console.log("Error calling GOVUK's InPageNavigation module", error);
            }
        })
    }());
</script>


            
          </main>

          <aside>
              <ul class="contribution-banner">
                <li><a href="https://github.com/alphagov/govuk-chat/blob/main/docs/message-queue-consumption.md">View source</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs/issues/new?body=Problem+with+%27%27+%28https%3A%2F%2Fdocs.publishing.service.gov.uk%2Frepos%2Fgovuk-chat%2Fmessage-queue-consumption.html%29&amp;labels=bug&amp;title=Re%3A+%27%27">Report problem</a></li>
                <li><a href="https://github.com/alphagov/govuk-developer-docs">GitHub Repo</a></li>
              </ul>
          </aside>

          <footer class="govuk-footer app-footer" role="contentinfo">
  <svg focusable="false" role="presentation" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 60" height="30" width="32" fill="currentcolor" class="govuk-footer__crown">
    <g>
      <circle cx="20" cy="17.6" r="3.7"></circle>
      <circle cx="10.2" cy="23.5" r="3.7"></circle>
      <circle cx="3.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <circle cx="43.3" cy="17.6" r="3.7"></circle>
      <circle cx="53.2" cy="23.5" r="3.7"></circle>
      <circle cx="59.7" cy="33.2" r="3.7"></circle>
      <circle cx="31.7" cy="30.6" r="3.7"></circle>
      <path d="M33.1,9.8c.2-.1.3-.3.5-.5l4.6,2.4v-6.8l-4.6,1.5c-.1-.2-.3-.3-.5-.5l1.9-5.9h-6.7l1.9,5.9c-.2.1-.3.3-.5.5l-4.6-1.5v6.8l4.6-2.4c.1.2.3.3.5.5l-2.6,8c-.9,2.8,1.2,5.7,4.1,5.7h0c3,0,5.1-2.9,4.1-5.7l-2.6-8ZM37,37.9s-3.4,3.8-4.1,6.1c2.2,0,4.2-.5,6.4-2.8l-.7,8.5c-2-2.8-4.4-4.1-5.7-3.8.1,3.1.5,6.7,5.8,7.2,3.7.3,6.7-1.5,7-3.8.4-2.6-2-4.3-3.7-1.6-1.4-4.5,2.4-6.1,4.9-3.2-1.9-4.5-1.8-7.7,2.4-10.9,3,4,2.6,7.3-1.2,11.1,2.4-1.3,6.2,0,4,4.6-1.2-2.8-3.7-2.2-4.2.2-.3,1.7.7,3.7,3,4.2,1.9.3,4.7-.9,7-5.9-1.3,0-2.4.7-3.9,1.7l2.4-8c.6,2.3,1.4,3.7,2.2,4.5.6-1.6.5-2.8,0-5.3l5,1.8c-2.6,3.6-5.2,8.7-7.3,17.5-7.4-1.1-15.7-1.7-24.5-1.7h0c-8.8,0-17.1.6-24.5,1.7-2.1-8.9-4.7-13.9-7.3-17.5l5-1.8c-.5,2.5-.6,3.7,0,5.3.8-.8,1.6-2.3,2.2-4.5l2.4,8c-1.5-1-2.6-1.7-3.9-1.7,2.3,5,5.2,6.2,7,5.9,2.3-.4,3.3-2.4,3-4.2-.5-2.4-3-3.1-4.2-.2-2.2-4.6,1.6-6,4-4.6-3.7-3.7-4.2-7.1-1.2-11.1,4.2,3.2,4.3,6.4,2.4,10.9,2.5-2.8,6.3-1.3,4.9,3.2-1.8-2.7-4.1-1-3.7,1.6.3,2.3,3.3,4.1,7,3.8,5.4-.5,5.7-4.2,5.8-7.2-1.3-.2-3.7,1-5.7,3.8l-.7-8.5c2.2,2.3,4.2,2.7,6.4,2.8-.7-2.3-4.1-6.1-4.1-6.1h10.6,0Z"></path>
    </g>
  </svg>
  <div class="govuk-footer__meta">
    <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">

        <ul class="govuk-footer__inline-list">
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/accessibility.html">Accessibility</a>
            </li>
            <li class="govuk-footer__inline-list-item">
              <a class="govuk-footer__link" href="/cookies.html">Cookies</a>
            </li>
        </ul>

      <svg
        aria-hidden="true"
        focusable="false"
        class="govuk-footer__licence-logo"
        xmlns="http://www.w3.org/2000/svg"
        viewbox="0 0 483.2 195.7"
        height="17"
        width="41"
      >
        <path
          fill="currentColor"
          d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
        />
      </svg>
      <span class="govuk-footer__licence-description">
        All content is available under the
        <a
          class="govuk-footer__link"
          href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
          rel="license"
        >Open Government Licence v3.0</a>, except where otherwise stated
      </span>
    </div>
    <div class="govuk-footer__meta-item">
      <a
        class="govuk-footer__link govuk-footer__copyright-logo"
        href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
      >Â© Crown copyright</a>
    </div>
  </div>
</footer>

        </div>
      </div>
    </div>

    
    <script src="/javascripts/govuk_frontend.js" type="module"></script>
    <script src="/javascripts/application.js"></script>
  </body>
</html>
